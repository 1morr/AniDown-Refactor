

services:
  anidown:
    build: .
    container_name: anidown
    restart: unless-stopped
    ports:
      - "${WEBUI_PORT:-8081}:8081"
      - "${WEBHOOK_PORT:-5678}:5678"
    volumes:
      # 數據持久化
      - "${HOST_DB_PATH:-./data/db}:/data/db"
      - "${HOST_CONFIG_PATH:-./data/config}:/data/config"
      - "${HOST_LOG_PATH:-./data/logs}:/data/logs"
      - "${HOST_AI_LOG_PATH:-./data/ai_logs}:/data/ai_logs"

      # 統一存儲路徑 (包含下載和媒體庫，支持硬鏈接)
      - "${HOST_STORAGE_PATH:-./storage}:/storage"
    environment:
      # 基本配置
      - TZ=${TZ:-UTC}
      - DEBUG=${DEBUG:-false}
      - CONFIG_PATH=/data/config/config.json
      - DB_PATH=/data/db/anime_downloader.db
      - LOG_PATH=/data/logs
      - AI_LOG_PATH=/data/ai_logs

      # Web UI 配置
      - ANIDOWN_WEBUI__HOST=0.0.0.0
      - ANIDOWN_WEBUI__PORT=8081

      # Webhook 配置
      - ANIDOWN_WEBHOOK__HOST=0.0.0.0
      - ANIDOWN_WEBHOOK__PORT=5678
      

    # 資源限制建議
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          memory: 128M

    # 日誌配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
