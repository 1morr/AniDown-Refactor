# 系統架構

本文檔詳細說明 AniDown 的系統架構、工作流程和內部機制。

---

## 目錄

- [系統架構圖](#系統架構圖)
- [工作流程](#工作流程)
  - [完整處理流程](#完整處理流程)
  - [隊列處理機制](#隊列處理機制)
  - [AI Key Pool 機制](#ai-key-pool-機制)

---

## 系統架構圖

AniDown 採用分層架構設計，從上到下分為：接口層、服務層、基礎設施層、核心層。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AniDown 系統架構                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Interface Layer (接口層)                       │   │
│  │  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │   │
│  │  │   Web UI    │  │  Webhook Server │  │          CLI            │  │   │
│  │  │  (Flask)    │  │   (qBittorrent) │  │  (Command Line)         │  │   │
│  │  │  :8081      │  │      :5678      │  │                         │  │   │
│  │  └─────────────┘  └─────────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Service Layer (服務層)                         │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │  DownloadManager │  │   RenameService  │  │  HardlinkService │  │   │
│  │  │   (業務協調器)    │  │    (重命名服務)   │  │   (硬鏈接服務)    │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │   RSS Service    │  │  Filter Service  │  │  Metadata Service│  │   │
│  │  │   (RSS 解析)     │  │    (過濾服務)     │  │   (TVDB 元數據)  │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │                    Queue Workers (隊列處理器)                  │  │   │
│  │  │     WebhookQueue (種子事件)  │  RSSQueue (RSS 處理)           │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Infrastructure Layer (基礎設施層)                  │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │   AI Adapters    │  │   qBit Adapter   │  │ Discord Notifier │  │   │
│  │  │  ┌────────────┐  │  │                  │  │                  │  │   │
│  │  │  │ TitleParser│  │  │  (qBittorrent    │  │  (Webhook 通知)  │  │   │
│  │  │  │ FileRenamer│  │  │   WebAPI 適配)   │  │                  │  │   │
│  │  │  │ KeyPool    │  │  │                  │  │                  │  │   │
│  │  │  │ Breaker    │  │  │                  │  │                  │  │   │
│  │  │  └────────────┘  │  │                  │  │                  │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │                      Repositories (數據倉儲)                   │  │   │
│  │  │   AnimeRepo  │  DownloadRepo  │  HistoryRepo  │  AIKeyRepo   │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Core Layer (核心層)                           │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────┐ │   │
│  │  │ Domain Models│  │  Interfaces  │  │  Exceptions  │  │ Config  │ │   │
│  │  │  (領域模型)   │  │   (接口)     │  │   (異常)     │  │ (配置)  │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                              External Services                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ qBittorrent  │  │  OpenAI API  │  │   Discord    │  │    TVDB      │   │
│  │   WebAPI     │  │  (GPT 模型)  │  │   Webhook    │  │   API        │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 各層職責

| 層級 | 職責 | 主要組件 |
|------|------|---------|
| **Interface Layer** | 對外暴露服務端點 | Web UI、Webhook Server、CLI |
| **Service Layer** | 業務邏輯協調 | DownloadManager、RenameService、RSS Service、Queue Workers |
| **Infrastructure Layer** | 外部服務適配 | AI Adapters、qBit Adapter、Discord Notifier、Repositories |
| **Core Layer** | 領域模型和接口定義 | Domain Models、Interfaces、Exceptions、Config |

---

## 工作流程

### 完整處理流程

從 RSS 訂閱到媒體庫整理的完整流程：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AniDown 工作流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌──────────────┐
     │  RSS 訂閱源   │
     └──────┬───────┘
            │
            ▼
┌───────────────────────┐
│   1. RSS 定時檢查      │ ◄── 定時任務 (可配置間隔)
│   解析 RSS Feed        │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│   2. 過濾已存在項目     │ ◄── 檢查數據庫，避免重複
│   應用關鍵字/正則過濾   │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   3. AI 標題解析       │────►│  GPT 模型分析標題                    │
│   提取動漫信息         │     │  - 動漫名稱 (中/日/英)               │
│                       │◄────│  - 季數、集數                        │
└───────────┬───────────┘     │  - 字幕組、畫質、格式                 │
            │                 └─────────────────────────────────────┘
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   4. 添加到 qBittorrent│────►│  qBittorrent WebAPI                 │
│   開始下載             │     │  - 設置分類和保存路徑                │
└───────────┬───────────┘     │  - 觸發 Webhook 回調                 │
            │                 └─────────────────────────────────────┘
            ▼
┌───────────────────────┐
│   5. 等待下載完成       │ ◄── qBittorrent Webhook 通知
│   接收完成事件         │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   6. AI 文件重命名      │────►│  批量處理所有文件                    │
│   (多文件場景)         │     │  - 識別視頻/字幕/其他                │
│                       │◄────│  - 生成標準化文件名                   │
└───────────┬───────────┘     └─────────────────────────────────────┘
            │
            ▼
┌───────────────────────┐
│   7. 執行文件重命名     │
│   保留原始文件         │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   8. 創建硬鏈接        │────►│  媒體庫目錄結構                      │
│   整理到媒體庫         │     │  TV Shows/動漫名稱/Season XX/        │
└───────────┬───────────┘     │  動漫名稱 - SXXEXX - 標題.mkv        │
            │                 └─────────────────────────────────────┘
            ▼
┌───────────────────────┐
│   9. Discord 通知      │
│   發送處理結果         │
└───────────────────────┘
```

### 流程說明

| 步驟 | 說明 | 觸發條件 |
|------|------|---------|
| 1 | 定時檢查 RSS Feed | 定時任務或手動觸發 |
| 2 | 過濾重複和不需要的項目 | 數據庫檢查 + 關鍵字過濾 |
| 3 | AI 解析標題提取元數據 | 新項目進入處理隊列 |
| 4 | 添加種子到下載客戶端 | 解析成功 |
| 5 | 等待下載完成通知 | qBittorrent Webhook |
| 6 | AI 批量重命名文件 | 下載完成事件 |
| 7 | 執行實際的文件重命名 | AI 返回重命名結果 |
| 8 | 創建硬鏈接到媒體庫 | 重命名成功 |
| 9 | 發送 Discord 通知 | 處理完成 |

---

### 隊列處理機制

AniDown 使用異步隊列處理事件，確保系統穩定性和可擴展性。

```
┌─────────────────────────────────────────────────────────────────┐
│                       Queue System                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    RSS Queue                             │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐               │   │
│  │  │scheduled│   │ manual  │   │ single  │               │   │
│  │  │ _check  │   │ _check  │   │ _item   │               │   │
│  │  └────┬────┘   └────┬────┘   └────┬────┘               │   │
│  │       └─────────────┴─────────────┘                     │   │
│  │                     │                                    │   │
│  │                     ▼                                    │   │
│  │            ┌─────────────────┐                          │   │
│  │            │  RSS Worker     │                          │   │
│  │            │  (異步處理)      │                          │   │
│  │            └─────────────────┘                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Webhook Queue                           │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐               │   │
│  │  │torrent_ │   │torrent_ │   │torrent_ │               │   │
│  │  │completed│   │ added   │   │ error   │               │   │
│  │  └────┬────┘   └────┬────┘   └────┬────┘               │   │
│  │       └─────────────┴─────────────┘                     │   │
│  │                     │                                    │   │
│  │                     ▼                                    │   │
│  │            ┌─────────────────┐                          │   │
│  │            │ Webhook Worker  │                          │   │
│  │            │  (異步處理)      │                          │   │
│  │            └─────────────────┘                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 隊列類型

| 隊列 | 事件類型 | 說明 |
|------|---------|------|
| **RSS Queue** | `scheduled_check` | 定時檢查所有 RSS 訂閱 |
| | `manual_check` | 手動觸發 RSS 檢查 |
| | `single_item` | 處理單個 RSS 項目 |
| **Webhook Queue** | `torrent_completed` | 種子下載完成 |
| | `torrent_added` | 種子添加成功 |
| | `torrent_error` | 種子下載錯誤 |

### 隊列特性

- **異步處理**: 所有任務在後台線程處理，不阻塞主線程
- **暫停/恢復**: 支持動態暫停和恢復隊列處理
- **錯誤處理**: 自動重試失敗的任務
- **優先級**: 支持任務優先級排序

---

### AI Key Pool 機制

為了應對 API 速率限制，AniDown 實現了 Key Pool 和熔斷器機制。

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI Key Pool & Circuit Breaker                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Request ──►  ┌─────────────────────────────────────────┐     │
│                │           Circuit Breaker               │     │
│                │  ┌─────────┐   ┌─────────┐   ┌───────┐ │     │
│                │  │ CLOSED  │◄─►│HALF_OPEN│◄─►│ OPEN  │ │     │
│                │  │ (正常)  │   │ (測試)  │   │(熔斷) │ │     │
│                │  └─────────┘   └─────────┘   └───────┘ │     │
│                └──────────────────┬──────────────────────┘     │
│                                   │                             │
│                                   ▼                             │
│                ┌─────────────────────────────────────────┐     │
│                │              Key Pool                   │     │
│                │  ┌───────┐ ┌───────┐ ┌───────┐        │     │
│                │  │ Key 1 │ │ Key 2 │ │ Key 3 │ ...    │     │
│                │  │       │ │       │ │       │        │     │
│                │  │RPM: 60│ │RPM: 60│ │RPM: 60│        │     │
│                │  │RPD:500│ │RPD:500│ │RPD:500│        │     │
│                │  └───┬───┘ └───┬───┘ └───┬───┘        │     │
│                │      │         │         │             │     │
│                │      └─────────┼─────────┘             │     │
│                │                │                       │     │
│                │      ┌─────────▼─────────┐             │     │
│                │      │   Round Robin     │             │     │
│                │      │   Key Selection   │             │     │
│                │      └───────────────────┘             │     │
│                └─────────────────────────────────────────┘     │
│                                                                 │
│   Features:                                                     │
│   • RPM (Requests Per Minute) 限制                              │
│   • RPD (Requests Per Day) 限制                                 │
│   • 自動冷卻和恢復                                               │
│   • 持久化計數 (重啟恢復)                                        │
│   • 熔斷保護 (所有 Key 冷卻時觸發)                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 熔斷器狀態

| 狀態 | 說明 | 轉換條件 |
|------|------|---------|
| **CLOSED** | 正常狀態，請求正常通過 | 默認狀態 |
| **OPEN** | 熔斷狀態，拒絕所有請求 | 連續錯誤超過閾值或所有 Key 冷卻 |
| **HALF_OPEN** | 測試狀態，允許部分請求 | 冷卻時間結束後自動進入 |

### Key Pool 特性

| 特性 | 說明 |
|------|------|
| **RPM 限制** | 每分鐘請求數限制 |
| **RPD 限制** | 每日請求數限制 |
| **自動冷卻** | 達到限制後自動冷卻 |
| **Round Robin** | 輪詢選擇可用 Key |
| **持久化** | 重啟後恢復計數狀態 |
| **熔斷保護** | 所有 Key 不可用時觸發熔斷 |

---

## 相關文檔

- [返回主文檔](../README.md)
- [配置說明](CONFIGURATION.md)
- [安裝指南](INSTALLATION.md)
