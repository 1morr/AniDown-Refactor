# AniDown

<p align="center">
  <strong>AI-Driven Anime Download Manager</strong>
</p>

<p align="center">
  自動下載、智能重命名、整理動漫到 Plex/Jellyfin 媒體庫
</p>

---

## 功能特點

- **RSS 訂閱監控** - 自動解析 RSS 訂閱源，發現新番劇集
- **AI 智能解析** - 使用 GPT 模型解析標題，提取動漫名稱、集數、字幕組等信息
- **自動重命名** - 將下載的文件重命名為 Plex/Jellyfin 標準格式
- **硬鏈接整理** - 使用硬鏈接將文件整理到媒體庫，不佔用額外空間
- **Discord 通知** - 下載完成、處理進度等狀態通過 Discord Webhook 推送
- **Web UI** - 直觀的網頁管理界面
- **多 API Key 支持** - API Key 池管理，支持 RPM/RPD 限制和自動輪換

---

## 系統架構

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AniDown 系統架構                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Interface Layer (接口層)                       │   │
│  │  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │   │
│  │  │   Web UI    │  │  Webhook Server │  │          CLI            │  │   │
│  │  │  (Flask)    │  │   (qBittorrent) │  │  (Command Line)         │  │   │
│  │  │  :8081      │  │      :5678      │  │                         │  │   │
│  │  └─────────────┘  └─────────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Service Layer (服務層)                         │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │  DownloadManager │  │   RenameService  │  │  HardlinkService │  │   │
│  │  │   (業務協調器)    │  │    (重命名服務)   │  │   (硬鏈接服務)    │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │   RSS Service    │  │  Filter Service  │  │  Metadata Service│  │   │
│  │  │   (RSS 解析)     │  │    (過濾服務)     │  │   (TVDB 元數據)  │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │                    Queue Workers (隊列處理器)                  │  │   │
│  │  │     WebhookQueue (種子事件)  │  RSSQueue (RSS 處理)           │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Infrastructure Layer (基礎設施層)                  │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │   AI Adapters    │  │   qBit Adapter   │  │ Discord Notifier │  │   │
│  │  │  ┌────────────┐  │  │                  │  │                  │  │   │
│  │  │  │ TitleParser│  │  │  (qBittorrent    │  │  (Webhook 通知)  │  │   │
│  │  │  │ FileRenamer│  │  │   WebAPI 適配)   │  │                  │  │   │
│  │  │  │ KeyPool    │  │  │                  │  │                  │  │   │
│  │  │  │ Breaker    │  │  │                  │  │                  │  │   │
│  │  │  └────────────┘  │  │                  │  │                  │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │  ┌──────────────────────────────────────────────────────────────┐  │   │
│  │  │                      Repositories (數據倉儲)                   │  │   │
│  │  │   AnimeRepo  │  DownloadRepo  │  HistoryRepo  │  AIKeyRepo   │  │   │
│  │  └──────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Core Layer (核心層)                           │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────┐ │   │
│  │  │ Domain Models│  │  Interfaces  │  │  Exceptions  │  │ Config  │ │   │
│  │  │  (領域模型)   │  │   (接口)     │  │   (異常)     │  │ (配置)  │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                              External Services                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ qBittorrent  │  │  OpenAI API  │  │   Discord    │  │    TVDB      │   │
│  │   WebAPI     │  │  (GPT 模型)  │  │   Webhook    │  │   API        │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 工作流程

### 完整處理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AniDown 工作流程                                  │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌──────────────┐
     │  RSS 訂閱源   │
     └──────┬───────┘
            │
            ▼
┌───────────────────────┐
│   1. RSS 定時檢查      │ ◄── 定時任務 (可配置間隔)
│   解析 RSS Feed        │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│   2. 過濾已存在項目     │ ◄── 檢查數據庫，避免重複
│   應用關鍵字/正則過濾   │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   3. AI 標題解析       │────►│  GPT 模型分析標題                    │
│   提取動漫信息         │     │  - 動漫名稱 (中/日/英)               │
│                       │◄────│  - 季數、集數                        │
└───────────┬───────────┘     │  - 字幕組、畫質、格式                 │
            │                 └─────────────────────────────────────┘
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   4. 添加到 qBittorrent│────►│  qBittorrent WebAPI                 │
│   開始下載             │     │  - 設置分類和保存路徑                │
└───────────┬───────────┘     │  - 觸發 Webhook 回調                 │
            │                 └─────────────────────────────────────┘
            ▼
┌───────────────────────┐
│   5. 等待下載完成       │ ◄── qBittorrent Webhook 通知
│   接收完成事件         │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   6. AI 文件重命名      │────►│  批量處理所有文件                    │
│   (多文件場景)         │     │  - 識別視頻/字幕/其他                │
│                       │◄────│  - 生成標準化文件名                   │
└───────────┬───────────┘     └─────────────────────────────────────┘
            │
            ▼
┌───────────────────────┐
│   7. 執行文件重命名     │
│   保留原始文件         │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐     ┌─────────────────────────────────────┐
│   8. 創建硬鏈接        │────►│  媒體庫目錄結構                      │
│   整理到媒體庫         │     │  TV Shows/動漫名稱/Season XX/        │
└───────────┬───────────┘     │  動漫名稱 - SXXEXX - 標題.mkv        │
            │                 └─────────────────────────────────────┘
            ▼
┌───────────────────────┐
│   9. Discord 通知      │
│   發送處理結果         │
└───────────────────────┘
```

### 隊列處理機制

```
┌─────────────────────────────────────────────────────────────────┐
│                       Queue System                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    RSS Queue                             │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐               │   │
│  │  │scheduled│   │ manual  │   │ single  │               │   │
│  │  │ _check  │   │ _check  │   │ _item   │               │   │
│  │  └────┬────┘   └────┬────┘   └────┬────┘               │   │
│  │       └─────────────┴─────────────┘                     │   │
│  │                     │                                    │   │
│  │                     ▼                                    │   │
│  │            ┌─────────────────┐                          │   │
│  │            │  RSS Worker     │                          │   │
│  │            │  (異步處理)      │                          │   │
│  │            └─────────────────┘                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Webhook Queue                           │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐               │   │
│  │  │torrent_ │   │torrent_ │   │torrent_ │               │   │
│  │  │completed│   │ added   │   │ error   │               │   │
│  │  └────┬────┘   └────┬────┘   └────┬────┘               │   │
│  │       └─────────────┴─────────────┘                     │   │
│  │                     │                                    │   │
│  │                     ▼                                    │   │
│  │            ┌─────────────────┐                          │   │
│  │            │ Webhook Worker  │                          │   │
│  │            │  (異步處理)      │                          │   │
│  │            └─────────────────┘                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### AI Key Pool 機制

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI Key Pool & Circuit Breaker                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Request ──►  ┌─────────────────────────────────────────┐     │
│                │           Circuit Breaker               │     │
│                │  ┌─────────┐   ┌─────────┐   ┌───────┐ │     │
│                │  │ CLOSED  │◄─►│HALF_OPEN│◄─►│ OPEN  │ │     │
│                │  │ (正常)  │   │ (測試)  │   │(熔斷) │ │     │
│                │  └─────────┘   └─────────┘   └───────┘ │     │
│                └──────────────────┬──────────────────────┘     │
│                                   │                             │
│                                   ▼                             │
│                ┌─────────────────────────────────────────┐     │
│                │              Key Pool                   │     │
│                │  ┌───────┐ ┌───────┐ ┌───────┐        │     │
│                │  │ Key 1 │ │ Key 2 │ │ Key 3 │ ...    │     │
│                │  │       │ │       │ │       │        │     │
│                │  │RPM: 60│ │RPM: 60│ │RPM: 60│        │     │
│                │  │RPD:500│ │RPD:500│ │RPD:500│        │     │
│                │  └───┬───┘ └───┬───┘ └───┬───┘        │     │
│                │      │         │         │             │     │
│                │      └─────────┼─────────┘             │     │
│                │                │                       │     │
│                │      ┌─────────▼─────────┐             │     │
│                │      │   Round Robin     │             │     │
│                │      │   Key Selection   │             │     │
│                │      └───────────────────┘             │     │
│                └─────────────────────────────────────────┘     │
│                                                                 │
│   Features:                                                     │
│   • RPM (Requests Per Minute) 限制                              │
│   • RPD (Requests Per Day) 限制                                 │
│   • 自動冷卻和恢復                                               │
│   • 持久化計數 (重啟恢復)                                        │
│   • 熔斷保護 (所有 Key 冷卻時觸發)                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 環境需求

### 必需組件

| 組件 | 版本要求 | 說明 |
|------|---------|------|
| **Python** | 3.11+ | 運行環境 |
| **qBittorrent** | 4.4+ | 下載客戶端，需啟用 WebAPI |
| **OpenAI API** | - | GPT 模型 API（或兼容 API） |

### 可選組件

| 組件 | 說明 |
|------|------|
| **Docker** | 容器化部署 |
| **Discord Webhook** | 通知推送 |
| **TVDB API** | 獲取動漫元數據 |

---

## 快速開始

### Docker 部署（推薦）

1. **複製配置文件**

```bash
cp .env.example .env
# 編輯 .env 配置時區和路徑
```

2. **啟動服務**

```bash
docker-compose up -d
```

3. **訪問 Web UI**

打開瀏覽器訪問 `http://localhost:8081`

### 手動部署

1. **安裝依賴**

```bash
pip install -r requirements.txt
```

2. **配置文件**

```bash
cp config.json.example config.json
# 編輯 config.json 填入必要配置
```

3. **運行應用**

```bash
python -m src.main
```

---

## 配置說明

### 核心配置 (config.json)

```json
{
  "rss": {
    "fixed_urls": [],           // RSS 訂閱 URL 列表
    "check_interval": 3600      // 檢查間隔（秒）
  },
  "qbittorrent": {
    "url": "http://localhost:8080",  // qBittorrent WebAPI 地址
    "username": "admin",
    "password": "adminadmin",
    "base_download_path": "/downloads/AniDown/",
    "category": "AniDown"
  },
  "openai": {
    "key_pools": [
      {
        "name": "MyPool",
        "base_url": "https://api.openai.com/v1",
        "model": "gpt-4",
        "api_keys": [
          { "name": "Key 1", "api_key": "sk-xxx", "rpm": 60, "rpd": 1000, "enabled": true }
        ]
      }
    ],
    "title_parse": {
      "pool_name": "MyPool",           // 使用 Key Pool
      "extra_body": "",                // 任务特定配置
      "timeout": 180
    },
    "multi_file_rename": {
      "pool_name": "MyPool"            // 可与 title_parse 共享同一 pool
    },
    "subtitle_match": {
      "pool_name": "MyPool"
    }
  },
  "link_target_path": "/library/TV Shows",      // TV 媒體庫路徑
  "movie_link_target_path": "/library/Movies"   // 電影媒體庫路徑
}
```

### API Key Pool 配置

支持多個 API Key 輪換使用，配置 RPM/RPD 限制。Key Pool 是獨立的，可被多個任務共享：

```json
{
  "openai": {
    "key_pools": [
      {
        "name": "Pool A",
        "base_url": "https://api.openai.com/v1",
        "model": "gpt-4",
        "api_keys": [
          {
            "name": "Key 1",
            "api_key": "sk-xxx",
            "rpm": 60,      // 每分鐘請求限制
            "rpd": 500,     // 每日請求限制
            "enabled": true
          },
          {
            "name": "Key 2",
            "api_key": "sk-yyy",
            "rpm": 60,
            "rpd": 500,
            "enabled": true
          }
        ]
      }
    ],
    "title_parse": {
      "pool_name": "Pool A",    // 使用 Pool A
      "extra_body": "",         // 任務特定配置（不在 pool 中）
      "timeout": 180
    },
    "multi_file_rename": {
      "pool_name": "Pool A"     // 也使用 Pool A（共享）
    }
  }
}
```

### qBittorrent Webhook 配置

在 qBittorrent 中配置完成下載時的 Webhook 回調：

1. 打開 qBittorrent → 選項 → 下載
2. 在「Torrent 完成時運行外部程序」填入：

```bash
curl -X POST "http://anidown:5678/webhook" \
  -H "Content-Type: application/json" \
  -d '{"event":"torrent_finished","hash":"%I","name":"%N","save_path":"%D","category":"%L"}'
```

---

## 目錄結構

```
AniDown/
├── src/
│   ├── core/                    # 核心層
│   │   ├── domain/              # 領域模型
│   │   ├── interfaces/          # 接口定義
│   │   ├── utils/               # 工具類
│   │   ├── config.py            # 配置管理
│   │   └── exceptions.py        # 異常定義
│   │
│   ├── infrastructure/          # 基礎設施層
│   │   ├── ai/                  # AI 組件
│   │   │   ├── api_client.py    # OpenAI 客戶端
│   │   │   ├── key_pool.py      # Key 池管理
│   │   │   ├── circuit_breaker.py # 熔斷器
│   │   │   ├── title_parser.py  # 標題解析器
│   │   │   └── file_renamer.py  # 文件重命名器
│   │   ├── database/            # 數據庫
│   │   ├── downloader/          # 下載器適配
│   │   ├── metadata/            # 元數據服務
│   │   ├── notification/        # 通知服務
│   │   └── repositories/        # 數據倉儲
│   │
│   ├── services/                # 服務層
│   │   ├── queue/               # 隊列處理
│   │   ├── file/                # 文件服務
│   │   ├── rename/              # 重命名服務
│   │   ├── download_manager.py  # 下載管理器
│   │   └── rss_service.py       # RSS 服務
│   │
│   ├── interface/               # 接口層
│   │   ├── web/                 # Web UI
│   │   └── webhook/             # Webhook 處理
│   │
│   ├── container.py             # 依賴注入容器
│   └── main.py                  # 應用入口
│
├── config.json.example          # 配置範例
├── docker-compose.yml           # Docker 編排
├── Dockerfile                   # Docker 鏡像
├── requirements.txt             # Python 依賴
└── README.md
```

---

## CLI 命令

```bash
# 正常啟動（服務器模式）
python -m src.main

# Debug 模式（詳細 AI 日誌）
python -m src.main --debug

# 驗證測試
python -m src.main --test

# 手動處理 RSS
python -m src.main rss "https://example.com/rss"

# 手動添加磁力鏈接
python -m src.main magnet <hash> <title> <group> [--season N]

# 手動添加種子文件
python -m src.main torrent <file> <title> <group> [--season N]
```

---

## 端口說明

| 端口 | 服務 | 說明 |
|------|------|------|
| 8081 | Web UI | 管理界面 |
| 5678 | Webhook | qBittorrent 回調 |

---

## 開發

```bash
# 運行測試
pytest tests/

# 僅運行單元測試
pytest -m unit

# 代碼檢查
ruff check src/

# 測試覆蓋率
pytest --cov=src --cov-report=term-missing
```

---

## License

MIT License
