{% extends 'base.html' %}

{% block title %}动漫管理 - AniDown{% endblock %}

{# 样式已移到 components.css #}
{% block styles %}{% endblock %}

{% block content %}
    <!-- 1. 标题与摘要 -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-3">
                <i class="fa-solid fa-film text-purple-600 dark:text-neon-purple"></i>
                动漫管理
            </h1>
            <p class="text-slate-500 dark:text-gray-500 text-sm">管理所有动漫信息、文件和硬链接</p>
        </div>
        <div class="text-right">
            <p class="text-xs text-slate-400 dark:text-gray-500 font-mono">Total Anime</p>
            <p class="text-2xl font-bold text-slate-800 dark:text-white font-mono" id="total-records">Loading...</p>
        </div>
    </div>

    <!-- 2. 控制面板 (筛选与操作) -->
    <section class="glass-card rounded-xl p-5 space-y-4">
        <!-- 第一行：搜索与主要操作 -->
        <div class="flex flex-col lg:flex-row gap-4 justify-between">
            
            <!-- 搜索栏 -->
            <div class="flex gap-2 flex-1">
                <div class="relative flex-1 max-w-lg">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-500 text-sm"></i>
                    <input type="text" id="search-input" placeholder="搜索动漫标题、字幕组..." 
                        class="w-full pl-9 pr-10 py-2 rounded-lg text-sm font-medium form-control transition-all">
                    <button onclick="document.getElementById('search-input').value=''; renderTable()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <!-- 页面大小 -->
                <div class="relative w-24">
                     <select id="page-size" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-sm font-medium form-control cursor-pointer">
                        <option value="20">20条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-500 text-xs pointer-events-none"></i>
                </div>
            </div>
        </div>

        <!-- 第二行：高级筛选 -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 pt-4 border-t border-slate-200 dark:border-white/5">
            <!-- 媒体类型筛选 -->
            <div class="relative">
                <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">媒体类型</label>
                <select id="filter-media-type" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                    <option value="all">全部类型</option>
                    <option value="anime">动漫</option>
                    <option value="live_action">真人</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
            </div>
            <!-- 分类筛选 -->
            <div class="relative">
                <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">分类</label>
                <select id="filter-category" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                    <option value="all">全部</option>
                    <option value="tv">剧集</option>
                    <option value="movie">电影</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
            </div>
            <!-- TVDB筛选 -->
            <div class="relative">
                <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">TVDB</label>
                <select id="filter-tvdb" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                    <option value="all">全部</option>
                    <option value="linked">已链接</option>
                    <option value="unlinked">未链接</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
            </div>
            <!-- 分组方式 -->
            <div class="relative flex gap-2">
                <div class="relative flex-1">
                    <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">分组</label>
                    <select id="group-by" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                        <option value="">不分组</option>
                        <option value="subtitle_group">按字幕组</option>
                        <option value="media_type">按类型</option>
                        <option value="season">按季数</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
                </div>
                <button onclick="resetFilters()" class="h-9 px-3 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-white/5 dark:hover:bg-white/10 border border-slate-200 dark:border-white/10 text-slate-500 dark:text-gray-400 text-xs" title="清空筛选">
                    <i class="fa-solid fa-filter-circle-xmark"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- 3. 动漫列表 (Table) -->
    <section class="glass-card rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse table-fixed">
                <thead>
                    <tr class="border-b border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-xs text-slate-500 dark:text-gray-400 uppercase font-semibold">
                        <th class="py-3 pl-5 px-2 sortable-header" style="width: 20%;" onclick="toggleSort('short_title')">
                            动漫标题
                            <span class="sort-indicator" id="sort-short_title"></span>
                        </th>
                        <th class="py-3 px-2 sortable-header" style="width: 12%;" onclick="toggleSort('subtitle_group')">
                            字幕组
                            <span class="sort-indicator" id="sort-subtitle_group"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 8%;" onclick="toggleSort('season')">
                            季数
                            <span class="sort-indicator" id="sort-season"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 7%;" onclick="toggleSort('file_count')">
                            文件数
                            <span class="sort-indicator" id="sort-file_count"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 7%;" onclick="toggleSort('hardlink_count')">
                            硬链接
                            <span class="sort-indicator" id="sort-hardlink_count"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 8%;" onclick="toggleSort('media_type')">
                            类型
                            <span class="sort-indicator" id="sort-media_type"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 10%;" onclick="toggleSort('tvdb_id')">
                            TVDB
                            <span class="sort-indicator" id="sort-tvdb_id"></span>
                        </th>
                        <th class="py-3 px-2 text-right sortable-header" style="width: 12%;" onclick="toggleSort('created_at')">
                            添加时间
                            <span class="sort-indicator" id="sort-created_at"></span>
                        </th>
                        <th class="py-3 pr-4 pl-2 text-right" style="width: 18%;">操作</th>
                    </tr>
                </thead>
                <tbody class="text-sm divide-y divide-slate-200 dark:divide-white/5" id="table-body">
                    <!-- JS 渲染 -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Footer -->
        <div class="flex items-center justify-between px-4 py-3 border-t border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-white/5">
            <div class="text-xs text-slate-500 dark:text-gray-500">
                显示 <span class="text-slate-900 dark:text-white font-bold" id="page-start">1</span> 到 <span class="text-slate-900 dark:text-white font-bold" id="page-end">20</span> 条，共 <span id="total-count-footer">...</span> 条
            </div>
            <div class="flex items-center gap-1" id="pagination-controls">
                <!-- 分页控件将通过JavaScript动态生成 -->
            </div>
        </div>
    </section>

    <!-- ============================================ -->
    <!-- 4. 文件详情 Modal -->
    <!-- ============================================ -->
    <div id="modal-files" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-files')"></div>
        
        <div class="modal-content bg-white dark:bg-[#18181b] w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden ring-1 ring-slate-900/5 transition-all transform scale-100">
            
            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-100 dark:border-white/5 flex justify-between items-start bg-slate-50/50 dark:bg-[#18181b]">
                <div class="space-y-1">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-600 dark:text-purple-400">
                            <i class="fa-solid fa-folder-open"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="files-modal-title">文件详情</h3>
                    </div>
                    <div id="files-modal-summary" class="text-xs text-slate-500 dark:text-slate-400 pl-11 flex gap-4">
                        <span>加载中...</span>
                    </div>
                </div>
                <button onclick="closeModal('modal-files')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-thin">
                <!-- 原文件列表 -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-file-video text-blue-500"></i>
                        原文件路径
                    </h4>
                    <div id="original-files-list" class="space-y-1">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- 硬链接列表 -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-link text-emerald-500"></i>
                        硬链接路径
                    </h4>
                    <div id="hardlink-files-list" class="space-y-1">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="bg-slate-50 dark:bg-white/5 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-amber-500"></i>
                        统计信息
                    </h4>
                    <div class="grid grid-cols-3 gap-4 text-center" id="files-stats">
                        <!-- JS 填充 -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t border-slate-200 dark:border-white/10 bg-white dark:bg-[#18181b] p-4 flex justify-end">
                <button onclick="closeModal('modal-files')" class="px-4 py-2 rounded-lg bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors">
                    <i class="fa-solid fa-xmark mr-1"></i> 关闭
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 5. 删除确认 Modal -->
    <!-- ============================================ -->
    <div id="modal-delete" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-delete')"></div>
        <div class="modal-content bg-white dark:bg-[#1e1e20] w-full max-w-xl rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-rose-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-trash-can"></i> 删除动漫</h3>
                <button onclick="closeModal('modal-delete')" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-5">
                <!-- Warning Box -->
                <div class="bg-yellow-50 dark:bg-yellow-500/10 border border-yellow-200 dark:border-yellow-500/20 rounded-lg p-3 flex gap-3 items-start">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 dark:text-yellow-500 mt-0.5"></i>
                    <div class="text-sm text-yellow-700 dark:text-yellow-200 font-bold">警告：此操作不可撤销，请谨慎选择删除选项！</div>
                </div>

                <!-- 动漫信息 -->
                <div class="space-y-2 text-sm text-slate-600 dark:text-gray-300" id="delete-modal-info">
                    <!-- JS 填充 -->
                </div>

                <!-- 将要删除的路径预览 -->
                <div class="bg-slate-50 dark:bg-white/5 rounded-lg p-4 space-y-3" id="delete-paths-preview">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300">将要删除的路径：</h4>
                    <div id="delete-paths-list" class="space-y-2 text-xs font-mono">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- Options -->
                <div class="space-y-3 border-t border-b border-slate-200 dark:border-white/10 py-4">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="del-original" class="mt-1 w-4 h-4 rounded bg-slate-200 dark:bg-white/10 border-gray-400 text-rose-600 focus:ring-rose-500 cursor-pointer">
                        <label for="del-original" class="cursor-pointer">
                            <div class="text-sm font-bold text-slate-800 dark:text-white">删除原文件夹</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">从qBittorrent移除torrents并删除下载的原文件夹</div>
                        </label>
                    </div>
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="del-hardlinks" class="mt-1 w-4 h-4 rounded bg-slate-200 dark:bg-white/10 border-gray-400 text-rose-600 focus:ring-rose-500 cursor-pointer">
                        <label for="del-hardlinks" class="cursor-pointer">
                            <div class="text-sm font-bold text-slate-800 dark:text-white">删除硬链接文件夹</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">删除媒体库中的硬链接文件夹</div>
                        </label>
                    </div>
                    <div class="flex items-start gap-3 pt-2 border-t border-slate-200 dark:border-white/10">
                        <input type="checkbox" id="del-database" class="mt-1 w-4 h-4 rounded bg-slate-200 dark:bg-white/10 border-gray-400 text-rose-600 focus:ring-rose-500 cursor-pointer">
                        <label for="del-database" class="cursor-pointer">
                            <div class="text-sm font-bold text-rose-600 dark:text-rose-400">完全删除动漫（从数据库中删除）</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">删除数据库中所有相关记录，包括动漫信息、下载记录和硬链接记录</div>
                        </label>
                    </div>
                </div>

                <!-- Note -->
                <div class="bg-cyan-50 dark:bg-cyan-500/10 rounded-lg p-3 flex gap-3 text-xs text-cyan-700 dark:text-cyan-300">
                    <i class="fa-solid fa-circle-info mt-0.5"></i>
                    只删除原文件夹时，下载记录将移动到删除历史中保存，可随时查看。
                </div>
            </div>

            <!-- Actions -->
            <div class="px-6 py-4 bg-slate-50 dark:bg-[#1e1e20] border-t border-slate-200 dark:border-white/10 flex justify-end gap-3">
                <button onclick="closeModal('modal-delete')" class="px-4 py-2 rounded bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-xmark mr-1"></i> 取消</button>
                <button onclick="confirmDelete()" class="px-4 py-2 rounded bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-trash-can mr-1"></i> 确认删除</button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 7. 字幕管理 Modal -->
    <!-- ============================================ -->
    <div id="modal-subtitles" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-subtitles')"></div>

        <div class="modal-content bg-white dark:bg-[#18181b] w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden ring-1 ring-slate-900/5 transition-all transform scale-100">

            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-100 dark:border-white/5 flex justify-between items-start bg-slate-50/50 dark:bg-[#18181b]">
                <div class="space-y-1">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                            <i class="fa-solid fa-closed-captioning"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="subtitles-modal-title">字幕管理</h3>
                    </div>
                    <div id="subtitles-modal-summary" class="text-xs text-slate-500 dark:text-slate-400 pl-11 flex gap-4">
                        <span>加载中...</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openAddSubtitleModal()" class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors flex items-center gap-1.5">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI添加字幕
                    </button>
                    <button onclick="closeModal('modal-subtitles')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- 控制栏 -->
            <div class="px-6 py-3 border-b border-slate-100 dark:border-white/5 bg-slate-50/30 dark:bg-white/[0.02] flex flex-wrap items-center gap-4">
                <!-- 排序控制 -->
                <div class="flex items-center gap-2">
                    <span class="text-xs text-slate-500 dark:text-gray-500">排序:</span>
                    <div class="flex rounded-lg overflow-hidden border border-slate-200 dark:border-white/10">
                        <button onclick="setSubtitleSortOrder('asc')" id="subtitle-sort-asc"
                            class="px-2.5 py-1 text-xs font-medium bg-blue-500 text-white transition-colors flex items-center gap-1">
                            <i class="fa-solid fa-arrow-up-1-9 text-[10px]"></i> 顺序
                        </button>
                        <button onclick="setSubtitleSortOrder('desc')" id="subtitle-sort-desc"
                            class="px-2.5 py-1 text-xs font-medium bg-slate-100 text-slate-600 dark:bg-white/5 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors flex items-center gap-1">
                            <i class="fa-solid fa-arrow-down-9-1 text-[10px]"></i> 倒序
                        </button>
                    </div>
                </div>

                <!-- 文件夹筛选按钮 -->
                <div class="flex items-center gap-2 flex-wrap" id="subtitle-folder-buttons">
                    <!-- JS 动态填充 -->
                </div>

                <!-- 统计信息 -->
                <div class="ml-auto text-xs text-slate-400 dark:text-gray-500" id="subtitle-filter-stats">
                    <!-- JS 动态填充 -->
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-3 scrollbar-thin" id="subtitles-content">
                <!-- JS 填充 -->
                <div class="text-center py-8 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>
            </div>

            <!-- Footer -->
            <div class="border-t border-slate-200 dark:border-white/10 bg-white dark:bg-[#18181b] p-4 flex justify-end">
                <button onclick="closeModal('modal-subtitles')" class="px-4 py-2 rounded-lg bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors">
                    <i class="fa-solid fa-xmark mr-1"></i> 关闭
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 8. AI添加字幕 Modal -->
    <!-- ============================================ -->
    <div id="modal-add-subtitle" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-add-subtitle')"></div>
        <div class="modal-content bg-white dark:bg-[#1e1e20] w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-emerald-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> AI添加字幕</h3>
                <button onclick="closeModal('modal-add-subtitle')" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="p-6 space-y-5">
                <!-- Info -->
                <div class="bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-200 dark:border-emerald-500/20 rounded-lg p-3 flex gap-3 items-start">
                    <i class="fa-solid fa-circle-info text-emerald-600 dark:text-emerald-500 mt-0.5"></i>
                    <div class="text-sm text-emerald-700 dark:text-emerald-200">
                        上传字幕压缩档，AI将自动匹配字幕与对应的影片文件。
                    </div>
                </div>

                <!-- 上传区域 -->
                <div id="subtitle-upload-zone"
                     class="border-2 border-dashed border-slate-300 dark:border-white/20 rounded-lg p-8 text-center cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/50 dark:hover:border-emerald-500/50 dark:hover:bg-emerald-500/5 transition-colors"
                     ondragover="event.preventDefault(); this.classList.add('border-emerald-400', 'bg-emerald-50/50', 'dark:border-emerald-500/50', 'dark:bg-emerald-500/5');"
                     ondragleave="this.classList.remove('border-emerald-400', 'bg-emerald-50/50', 'dark:border-emerald-500/50', 'dark:bg-emerald-500/5');"
                     ondrop="handleSubtitleDrop(event)"
                     onclick="document.getElementById('subtitle-file-input').click()">
                    <input type="file" id="subtitle-file-input" class="hidden" accept=".zip,.rar,.7z,.tar,.gz" onchange="handleSubtitleFileSelect(event)">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-sm text-slate-600 dark:text-gray-300 font-medium">拖拽压缩档到此处或点击上传</p>
                    <p class="text-xs text-slate-400 dark:text-gray-500 mt-2">支持 .zip, .rar, .7z 格式</p>
                </div>

                <!-- 已选择文件 -->
                <div id="subtitle-selected-file" class="hidden bg-slate-50 dark:bg-white/5 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-file-zipper text-2xl text-emerald-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-700 dark:text-white" id="subtitle-filename">-</p>
                                <p class="text-xs text-slate-400 dark:text-gray-500" id="subtitle-filesize">-</p>
                            </div>
                        </div>
                        <button onclick="clearSubtitleFile()" class="text-slate-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>

                <!-- 进度显示 -->
                <div id="subtitle-progress" class="hidden space-y-3">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-spinner fa-spin text-emerald-500"></i>
                        <span class="text-sm text-slate-600 dark:text-gray-300" id="subtitle-progress-text">正在处理...</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-white/10 rounded-full h-2">
                        <div id="subtitle-progress-bar" class="bg-emerald-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 匹配结果 -->
                <div id="subtitle-result" class="hidden space-y-3">
                    <div class="text-sm font-bold text-slate-700 dark:text-white">匹配结果</div>
                    <div id="subtitle-result-content" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- JS 填充 -->
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="px-6 py-4 bg-slate-50 dark:bg-[#1e1e20] border-t border-slate-200 dark:border-white/10 flex justify-end gap-3">
                <button onclick="closeAddSubtitleModal()" class="px-4 py-2 rounded bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-xmark mr-1"></i> 关闭</button>
                <button onclick="submitSubtitleArchive()" id="btn-submit-subtitle" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> 开始匹配</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    let currentPage = 1;
    let perPage = 20;
    let searchTerm = '';
    let sortColumn = 'created_at';
    let sortOrder = 'desc';
    let mediaTypeFilter = 'all';
    let categoryFilter = 'all';
    let tvdbFilter = 'all';
    let groupBy = '';
    let viewingGroup = null;
    let currentDeleteAnimeId = null;
    let requestCounter = 0;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        renderTable();
        updateSortIndicators();
    });

    // 初始化事件监听器
    function initializeEventListeners() {
        // 搜索功能
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.trim();
            currentPage = 1;
            renderTable();
        });

        // 页面大小改变
        document.getElementById('page-size').addEventListener('change', (e) => {
            perPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });

        // 筛选器
        document.getElementById('filter-media-type').addEventListener('change', (e) => {
            mediaTypeFilter = e.target.value;
            currentPage = 1;
            renderTable();
        });

        document.getElementById('filter-category').addEventListener('change', (e) => {
            categoryFilter = e.target.value;
            currentPage = 1;
            renderTable();
        });

        document.getElementById('filter-tvdb').addEventListener('change', (e) => {
            tvdbFilter = e.target.value;
            currentPage = 1;
            renderTable();
        });

        document.getElementById('group-by').addEventListener('change', (e) => {
            groupBy = e.target.value;
            viewingGroup = null;
            currentPage = 1;
            renderTable();
        });
    }

    // 切换排序
    function toggleSort(column) {
        if (sortColumn === column) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortOrder = 'desc';
        }
        currentPage = 1;
        updateSortIndicators();
        renderTable();
    }

    // 更新排序指示器
    function updateSortIndicators() {
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.className = 'sort-indicator';
            indicator.innerHTML = '<i class="fa-solid fa-sort"></i>';
        });

        const currentIndicator = document.getElementById(`sort-${sortColumn}`);
        if (currentIndicator) {
            currentIndicator.classList.add('active');
            if (sortOrder === 'asc') {
                currentIndicator.innerHTML = '<i class="fa-solid fa-sort-up"></i>';
            } else {
                currentIndicator.innerHTML = '<i class="fa-solid fa-sort-down"></i>';
            }
        }
    }

    // 渲染表格
    async function renderTable() {
        try {
            requestCounter++;
            const thisRequestId = requestCounter;

            const actualMediaTypeFilter = mediaTypeFilter === 'all' ? '' : mediaTypeFilter;
            const actualCategoryFilter = categoryFilter === 'all' ? '' : categoryFilter;
            const actualTvdbFilter = tvdbFilter === 'all' ? '' : tvdbFilter;

            const params = new URLSearchParams({
                page: currentPage,
                per_page: perPage,
                search: searchTerm,
                sort_column: sortColumn,
                sort_order: sortOrder,
                media_type_filter: actualMediaTypeFilter,
                category_filter: actualCategoryFilter,
                tvdb_filter: actualTvdbFilter,
                group_by: groupBy,
                viewing_group: viewingGroup || ''
            });

            const response = await fetch(`{{ url_for('anime.api_get_anime_list') }}?${params}`);
            const data = await response.json();

            if (thisRequestId !== requestCounter) {
                return;
            }

            if (data.error) {
                showError('加载失败: ' + data.error);
                return;
            }

            if (groupBy && !viewingGroup) {
                renderGroupedAnime(data);
                updatePagination({
                    total_count: data.total_count || 0,
                    current_page: 1,
                    per_page: data.total_count || 0,
                    total_pages: 1
                });
            } else {
                renderAnimeList(data);
                updatePagination({
                    total_count: data.total_count || 0,
                    current_page: data.current_page || 1,
                    per_page: data.per_page || perPage,
                    total_pages: data.total_pages || 0
                });
            }

            updateTotalRecords(data.total_count || 0);
        } catch (error) {
            console.error('渲染表格错误:', error);
            showError('加载失败: ' + error.message);
        }
    }

    // 渲染分组视图
    function renderGroupedAnime(data) {
        const tbody = document.getElementById('table-body');
        
        if (!data.groups || data.groups.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-8 text-slate-500 dark:text-gray-400">
                        <i class="fa-solid fa-info-circle text-2xl mb-2"></i>
                        <p>暂无数据</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        data.groups.forEach(group => {
            const groupName = group.group_name || '(未分类)';
            const displayName = group.display_name || groupName;

            html += `
                <tr class="hover:bg-slate-50 dark:hover:bg-white/5 cursor-pointer" onclick="viewGroupDetails('${escapeJs(groupName)}')">
                    <td class="py-3 pl-5 px-2 font-medium text-slate-700 dark:text-white">${escapeHtml(displayName)}</td>
                    <td class="py-3 px-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                            ${group.total_count} 部动漫
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-right">-</td>
                    <td class="py-3 pr-4 pl-2 text-right">
                        <button onclick="event.stopPropagation(); viewGroupDetails('${escapeJs(groupName)}')" class="w-7 h-7 rounded-md flex items-center justify-center bg-blue-50 hover:bg-blue-100 dark:bg-blue-500/10 dark:hover:bg-blue-500/20 text-blue-500 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20 transition-colors" title="查看详情">
                            <i class="fa-solid fa-eye text-xs"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // 渲染动漫列表
    function renderAnimeList(data) {
        const tbody = document.getElementById('table-body');
        
        if (!data.anime_list || data.anime_list.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-8 text-slate-500 dark:text-gray-400">
                        <i class="fa-solid fa-info-circle text-2xl mb-2"></i>
                        <p>暂无动漫数据</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        
        // 如果正在查看分组详情，显示返回按钮
        if (viewingGroup) {
            html += `
                <tr>
                    <td colspan="9" class="py-3 px-5 bg-purple-50 dark:bg-purple-900/10">
                        <button onclick="exitGroupView()" class="inline-flex items-center gap-2 text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-200">
                            <i class="fa-solid fa-arrow-left"></i> 返回分组列表
                        </button>
                        <span class="ml-4 text-sm text-slate-600 dark:text-gray-300">当前查看: <strong>${escapeHtml(viewingGroup)}</strong></span>
                    </td>
                </tr>
            `;
        }

        data.anime_list.forEach(anime => {
            const mediaTypeBadge = anime.media_type === 'live_action' 
                ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">真人</span>'
                : '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">动漫</span>';

            const tvdbBadge = anime.tvdb_id 
                ? `<a href="https://www.thetvdb.com/series/${anime.tvdb_id}" target="_blank" class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300 hover:bg-emerald-200 dark:hover:bg-emerald-900/50">${anime.tvdb_id}</a>`
                : '<span class="text-slate-400 dark:text-gray-600 text-xs">-</span>';

            html += `
                <tr class="group transition-colors hover:bg-slate-50 dark:hover:bg-white/5">
                    <td class="py-3 pl-5 px-2">
                        <div class="font-medium text-slate-700 dark:text-white truncate max-w-[200px]" title="${escapeHtml(anime.short_title || anime.original_title)}">${escapeHtml(anime.short_title || anime.original_title)}</div>
                    </td>
                    <td class="py-3 px-2 text-xs text-slate-500 dark:text-gray-400 whitespace-nowrap truncate max-w-[120px]" title="${escapeHtml(anime.subtitle_group || '-')}">${escapeHtml(anime.subtitle_group || '-')}</td>
                    <td class="py-3 px-2 text-center">
                        <span class="text-xs font-mono text-slate-600 dark:text-gray-500 bg-slate-100 dark:bg-white/5 px-1.5 py-0.5 rounded">S${anime.season || 1}</span>
                    </td>
                    <td class="py-3 px-2 text-center">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${anime.file_count > 0 ? 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300' : 'bg-slate-100 text-slate-600 dark:bg-white/5 dark:text-slate-400'}">
                            ${anime.file_count || 0}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${anime.hardlink_count > 0 ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300' : 'bg-slate-100 text-slate-600 dark:bg-white/5 dark:text-slate-400'}">
                            ${anime.hardlink_count || 0}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center">
                        ${mediaTypeBadge}
                    </td>
                    <td class="py-3 px-2 text-center">
                        ${tvdbBadge}
                    </td>
                    <td class="py-3 px-2 text-right">
                        <div class="font-mono text-[10px] text-slate-500 dark:text-gray-500">${formatDate(anime.created_at, 'date')}</div>
                        <div class="font-mono text-[10px] text-slate-400 dark:text-gray-400">${formatDate(anime.created_at, 'time')}</div>
                    </td>
                    <td class="py-3 pr-4 pl-2 text-right">
                        <div class="flex justify-end gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                            <a href="/anime/${anime.id}/detail" class="w-7 h-7 rounded-md flex items-center justify-center bg-purple-50 hover:bg-purple-100 dark:bg-purple-500/10 dark:hover:bg-purple-500/20 text-purple-500 dark:text-purple-400 border border-purple-200 dark:border-purple-500/20 transition-colors" title="详情">
                                <i class="fa-solid fa-list text-xs"></i>
                            </a>
                            <button onclick="openFilesModal(${anime.id})" class="w-7 h-7 rounded-md flex items-center justify-center bg-blue-50 hover:bg-blue-100 dark:bg-blue-500/10 dark:hover:bg-blue-500/20 text-blue-500 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20 transition-colors" title="查看文件">
                                <i class="fa-solid fa-folder-open text-xs"></i>
                            </button>
                            <button onclick="openSubtitlesModal(${anime.id}, '${escapeJs(anime.short_title || anime.original_title)}')" class="w-7 h-7 rounded-md flex items-center justify-center bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-500/10 dark:hover:bg-emerald-500/20 text-emerald-500 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-500/20 transition-colors" title="字幕管理">
                                <i class="fa-solid fa-closed-captioning text-xs"></i>
                            </button>
                            <button onclick="openDeleteModal(${anime.id})" class="w-7 h-7 rounded-md flex items-center justify-center bg-red-50 hover:bg-red-100 dark:bg-red-500/10 dark:hover:bg-red-500/20 text-red-500 dark:text-red-400 border border-red-200 dark:border-red-500/20 transition-colors" title="删除">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // 更新分页信息
    function updatePagination(data) {
        const paginationControls = document.getElementById('pagination-controls');
        const pageStart = document.getElementById('page-start');
        const pageEnd = document.getElementById('page-end');

        const totalCount = data.total_count || 0;
        const currentPage = data.current_page || 1;
        const perPage = data.per_page || 20;
        const totalPages = data.total_pages || 0;

        let start = 0;
        let end = 0;

        if (totalCount > 0) {
            start = (currentPage - 1) * perPage + 1;
            end = Math.min(currentPage * perPage, totalCount);
        }

        pageStart.textContent = start;
        pageEnd.textContent = end;

        let html = '';

        // 上一页按钮
        if (currentPage > 1) {
            html += `
                <button onclick="changePage(${currentPage - 1})" class="px-2 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 dark:text-gray-400 transition-colors">
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="px-2 py-1 rounded text-slate-300 dark:text-gray-600 cursor-not-allowed" disabled>
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
            `;
        }

        // 页码按钮
        if (totalPages > 0) {
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<button onclick="changePage(1)" class="px-2.5 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-500 dark:text-gray-400 text-xs transition-colors">1</button>`;
                if (startPage > 2) {
                    html += `<span class="px-2 text-slate-400 dark:text-gray-600 text-xs">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button class="px-2.5 py-1 rounded bg-purple-600 text-white text-xs font-bold">${i}</button>`;
                } else {
                    html += `<button onclick="changePage(${i})" class="px-2.5 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-500 dark:text-gray-400 text-xs transition-colors">${i}</button>`;
                }
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="px-2 text-slate-400 dark:text-gray-600 text-xs">...</span>`;
                }
                html += `<button onclick="changePage(${totalPages})" class="px-2.5 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-500 dark:text-gray-400 text-xs transition-colors">${totalPages}</button>`;
            }
        }

        // 下一页按钮
        if (currentPage < totalPages) {
            html += `
                <button onclick="changePage(${currentPage + 1})" class="px-2 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 dark:text-gray-400 transition-colors">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="px-2 py-1 rounded text-slate-300 dark:text-gray-600 cursor-not-allowed" disabled>
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            `;
        }

        paginationControls.innerHTML = html;
    }

    // 更新总记录数
    function updateTotalRecords(count) {
        document.getElementById('total-records').textContent = count;
        document.getElementById('total-count-footer').textContent = count;
    }

    // 切换页面
    function changePage(page) {
        currentPage = page;
        renderTable();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 查看分组详情
    function viewGroupDetails(groupName) {
        viewingGroup = groupName;
        currentPage = 1;
        renderTable();
    }

    // 退出分组查看
    function exitGroupView() {
        viewingGroup = null;
        currentPage = 1;
        renderTable();
    }

    // 重置筛选器
    function resetFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-media-type').value = 'all';
        document.getElementById('filter-category').value = 'all';
        document.getElementById('filter-tvdb').value = 'all';
        document.getElementById('group-by').value = '';

        searchTerm = '';
        mediaTypeFilter = 'all';
        categoryFilter = 'all';
        tvdbFilter = 'all';
        groupBy = '';
        viewingGroup = null;
        currentPage = 1;
        renderTable();
    }

    // Modal 控制
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
    }
    
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden'); 
    }

    // 打开文件详情 Modal
    async function openFilesModal(animeId) {
        openModal('modal-files');
        
        // 显示加载状态
        document.getElementById('files-modal-title').textContent = '加载中...';
        document.getElementById('files-modal-summary').innerHTML = '<span>正在获取文件信息...</span>';
        document.getElementById('original-files-list').innerHTML = '<div class="text-center py-4 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        document.getElementById('hardlink-files-list').innerHTML = '<div class="text-center py-4 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        document.getElementById('files-stats').innerHTML = '';

        try {
            const response = await fetch(`{{ url_for('anime.api_get_anime_details', anime_id=0) }}`.replace('0', animeId));
            const data = await response.json();

            if (data.error) {
                showError('获取文件详情失败: ' + data.error);
                closeModal('modal-files');
                return;
            }

            // 更新标题
            document.getElementById('files-modal-title').textContent = data.anime.short_title || data.anime.original_title;
            document.getElementById('files-modal-summary').innerHTML = `
                <span><i class="fa-regular fa-file-video mr-1"></i> ${data.original_files.length} 个下载记录</span>
                <span><i class="fa-solid fa-link mr-1"></i> ${data.hardlink_files.length} 个硬链接</span>
            `;

            // 渲染原文件列表
            let originalHtml = '';
            if (data.original_files.length === 0) {
                originalHtml = '<div class="text-slate-400 dark:text-gray-500 text-sm py-2">暂无原文件记录</div>';
            } else {
                for (const file of data.original_files) {
                    const fullPath = file.directory ? `${file.directory}/${file.filename}` : file.filename;
                    const statusBadge = file.status === 'completed' 
                        ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">已完成</span>'
                        : `<span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-slate-400">${file.status}</span>`;
                    
                    originalHtml += `
                        <div class="file-list-item flex justify-between items-start gap-2">
                            <span class="break-all flex-1">${escapeHtml(fullPath)}</span>
                            ${statusBadge}
                        </div>
                    `;
                }
            }
            document.getElementById('original-files-list').innerHTML = originalHtml;

            // 渲染硬链接列表
            let hardlinkHtml = '';
            if (data.hardlink_files.length === 0) {
                hardlinkHtml = '<div class="text-slate-400 dark:text-gray-500 text-sm py-2">暂无硬链接</div>';
            } else {
                for (const link of data.hardlink_files) {
                    hardlinkHtml += `
                        <div class="file-list-item">
                            <div class="text-emerald-600 dark:text-emerald-400 break-all">${escapeHtml(link.hardlink_path)}</div>
                            <div class="text-slate-400 dark:text-gray-500 mt-1 text-[10px]">→ ${escapeHtml(link.original_path)}</div>
                        </div>
                    `;
                }
            }
            document.getElementById('hardlink-files-list').innerHTML = hardlinkHtml;

            // 渲染统计信息
            document.getElementById('files-stats').innerHTML = `
                <div>
                    <div class="text-2xl font-bold text-slate-800 dark:text-white">${data.original_files.length}</div>
                    <div class="text-xs text-slate-500 dark:text-gray-400">下载记录</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${data.hardlink_files.length}</div>
                    <div class="text-xs text-slate-500 dark:text-gray-400">硬链接</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${formatFileSize(data.total_size)}</div>
                    <div class="text-xs text-slate-500 dark:text-gray-400">总大小</div>
                </div>
            `;

        } catch (error) {
            showError('获取文件详情失败: ' + error.message);
            closeModal('modal-files');
        }
    }

    // 监听"完全删除动漫"复选框变化
    document.getElementById('del-database').addEventListener('change', function() {
        const delOriginal = document.getElementById('del-original');
        const delHardlinks = document.getElementById('del-hardlinks');
        
        if (this.checked) {
            // 当勾选"完全删除"时，自动勾选并禁用其他两个选项
            delOriginal.checked = true;
            delHardlinks.checked = true;
            delOriginal.disabled = true;
            delHardlinks.disabled = true;
        } else {
            // 取消勾选时，取消勾选并启用其他两个选项
            delOriginal.checked = false;
            delHardlinks.checked = false;
            delOriginal.disabled = false;
            delHardlinks.disabled = false;
        }
    });

    // 打开删除确认 Modal
    async function openDeleteModal(animeId) {
        currentDeleteAnimeId = animeId;
        
        // 重置复选框状态
        document.getElementById('del-original').checked = false;
        document.getElementById('del-original').disabled = false;
        document.getElementById('del-hardlinks').checked = false;
        document.getElementById('del-hardlinks').disabled = false;
        document.getElementById('del-database').checked = false;

        // 显示加载状态
        document.getElementById('delete-modal-info').innerHTML = '<div class="text-center py-2 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> 加载中...</div>';
        document.getElementById('delete-paths-list').innerHTML = '<div class="text-center py-2 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        
        openModal('modal-delete');

        try {
            const response = await fetch(`{{ url_for('anime.api_get_anime_folders', anime_id=0) }}`.replace('0', animeId));
            const data = await response.json();

            if (data.error) {
                showError('获取动漫信息失败: ' + data.error);
                closeModal('modal-delete');
                return;
            }

            // 显示动漫信息
            document.getElementById('delete-modal-info').innerHTML = `
                <div class="flex"><span class="font-bold w-20 shrink-0">动漫标题:</span> <span class="truncate">${escapeHtml(data.anime_title)}</span></div>
                <div class="flex"><span class="font-bold w-20 shrink-0">下载数量:</span> <span>${data.download_count} 个</span></div>
            `;

            // 显示将要删除的路径
            document.getElementById('delete-paths-list').innerHTML = `
                <div class="space-y-2">
                    <div>
                        <span class="text-rose-600 dark:text-rose-400 font-bold">原文件夹:</span>
                        <div class="text-slate-600 dark:text-gray-300 break-all mt-1">${escapeHtml(data.original_folder)}</div>
                    </div>
                    <div>
                        <span class="text-rose-600 dark:text-rose-400 font-bold">硬链接文件夹:</span>
                        <div class="text-slate-600 dark:text-gray-300 break-all mt-1">${escapeHtml(data.hardlink_folder)}</div>
                    </div>
                </div>
            `;

        } catch (error) {
            showError('获取动漫信息失败: ' + error.message);
            closeModal('modal-delete');
        }
    }

    // 确认删除
    async function confirmDelete() {
        const deleteOriginal = document.getElementById('del-original').checked;
        const deleteHardlinks = document.getElementById('del-hardlinks').checked;
        const deleteDatabase = document.getElementById('del-database').checked;

        if (!deleteOriginal && !deleteHardlinks && !deleteDatabase) {
            showError('请至少选择一个删除选项');
            return;
        }

        if (deleteDatabase && !confirm('确定要从数据库中完全删除这个动漫吗？此操作不可撤销！')) {
            return;
        }

        try {
            const response = await fetch(`{{ url_for('anime.api_delete_anime', anime_id=0) }}`.replace('0', currentDeleteAnimeId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    delete_original: deleteOriginal,
                    delete_hardlinks: deleteHardlinks,
                    delete_from_database: deleteDatabase
                })
            });

            const data = await response.json();

            if (data.error) {
                showError('删除失败: ' + data.error);
                return;
            }

            let message = '删除成功！';
            if (data.original_deleted) {
                message += ` 原文件夹已删除，${data.torrents_removed || 0} 个torrents已从qBittorrent移除。`;
            }
            if (data.hardlinks_deleted) {
                message += ' 硬链接文件夹已删除。';
            }
            if (data.database_deleted) {
                message += ' 数据库记录已删除。';
            }
            if (data.downloads_moved_to_history > 0) {
                message += ` ${data.downloads_moved_to_history} 条下载记录已移动到删除历史。`;
            }

            showSuccess(message);
            closeModal('modal-delete');
            renderTable();

        } catch (error) {
            showError('删除失败: ' + error.message);
        }
    }

    // =============================================================================
    // 字幕管理功能
    // =============================================================================

    let currentSubtitleAnimeId = null;
    let currentSubtitleAnimeTitle = null;
    let selectedSubtitleFile = null;
    let subtitleSortOrder = 'asc';  // 'asc' or 'desc'
    let subtitleFolderFilter = '';  // 空表示显示全部
    let subtitleDataCache = null;   // 缓存API返回的数据

    // 打开字幕管理 Modal
    async function openSubtitlesModal(animeId, animeTitle) {
        currentSubtitleAnimeId = animeId;
        currentSubtitleAnimeTitle = animeTitle;
        subtitleSortOrder = 'asc';  // 重置排序
        subtitleFolderFilter = '';   // 重置筛选
        subtitleDataCache = null;

        document.getElementById('subtitles-modal-title').textContent = `${animeTitle} - 字幕管理`;
        document.getElementById('subtitles-modal-summary').innerHTML = '<span>加载中...</span>';
        document.getElementById('subtitles-content').innerHTML = '<div class="text-center py-8 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>';

        // 重置控制栏状态
        updateSubtitleSortButtons();
        document.getElementById('subtitle-folder-buttons').innerHTML = '';
        document.getElementById('subtitle-filter-stats').textContent = '';

        openModal('modal-subtitles');
        await loadSubtitlesList();
    }

    // 设置排序顺序
    function setSubtitleSortOrder(order) {
        if (subtitleSortOrder === order) return;
        subtitleSortOrder = order;
        updateSubtitleSortButtons();
        if (subtitleDataCache) {
            renderSubtitlesContent(subtitleDataCache);
        }
    }

    // 更新排序按钮样式
    function updateSubtitleSortButtons() {
        const ascBtn = document.getElementById('subtitle-sort-asc');
        const descBtn = document.getElementById('subtitle-sort-desc');

        if (subtitleSortOrder === 'asc') {
            ascBtn.className = 'px-2.5 py-1 text-xs font-medium bg-blue-500 text-white transition-colors flex items-center gap-1';
            descBtn.className = 'px-2.5 py-1 text-xs font-medium bg-slate-100 text-slate-600 dark:bg-white/5 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors flex items-center gap-1';
        } else {
            descBtn.className = 'px-2.5 py-1 text-xs font-medium bg-blue-500 text-white transition-colors flex items-center gap-1';
            ascBtn.className = 'px-2.5 py-1 text-xs font-medium bg-slate-100 text-slate-600 dark:bg-white/5 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors flex items-center gap-1';
        }
    }

    // 设置文件夹筛选
    function setSubtitleFolderFilter(folder) {
        subtitleFolderFilter = folder;
        updateFolderFilterButtons();
        if (subtitleDataCache) {
            renderSubtitlesContent(subtitleDataCache);
        }
    }

    // 更新文件夹筛选按钮样式
    function updateFolderFilterButtons() {
        const container = document.getElementById('subtitle-folder-buttons');
        const buttons = container.querySelectorAll('button');
        buttons.forEach(btn => {
            const btnFolder = btn.dataset.folder || '';
            if (btnFolder === subtitleFolderFilter) {
                btn.className = 'px-3 py-1 text-xs font-medium rounded-full bg-blue-500 text-white transition-colors';
            } else {
                btn.className = 'px-3 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/15 transition-colors';
            }
        });
    }

    // 从路径中提取文件夹名（仅最后一级）
    function extractFolderName(path) {
        const parts = path.split(/[/\\]/);
        if (parts.length <= 1) return '根目录';
        // 返回倒数第二个部分（即文件的父文件夹名）
        return parts[parts.length - 2] || '根目录';
    }

    // 从路径中提取完整文件夹路径
    function extractFolder(path) {
        // 处理 Windows 和 Unix 路径
        const parts = path.split(/[/\\]/);
        if (parts.length <= 1) return '根目录';
        // 返回除了文件名之外的路径部分
        return parts.slice(0, -1).join('/');
    }

    // 加载字幕列表
    async function loadSubtitlesList() {
        try {
            const response = await fetch(`/api/anime/${currentSubtitleAnimeId}/subtitles`);
            const data = await response.json();

            if (data.error) {
                document.getElementById('subtitles-content').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                        <p>${escapeHtml(data.error)}</p>
                    </div>
                `;
                return;
            }

            // 缓存数据
            subtitleDataCache = data;

            // 更新摘要
            document.getElementById('subtitles-modal-summary').innerHTML = `
                <span><i class="fa-solid fa-closed-captioning mr-1"></i> ${data.total_subtitles || 0} 个字幕</span>
                <span><i class="fa-solid fa-video mr-1"></i> ${data.total_videos || 0} 个影片</span>
            `;

            // 更新文件夹筛选下拉框
            updateFolderFilterOptions(data);

            // 渲染内容
            renderSubtitlesContent(data);

        } catch (error) {
            document.getElementById('subtitles-content').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fa-solid fa-exclamation-circle text-2xl mb-2"></i>
                    <p>加载失败: ${escapeHtml(error.message)}</p>
                </div>
            `;
        }
    }

    // 更新文件夹筛选按钮
    function updateFolderFilterOptions(data) {
        const container = document.getElementById('subtitle-folder-buttons');
        const folderMap = new Map(); // folder full path -> display name

        if (data.video_files) {
            for (const video of data.video_files) {
                const folder = extractFolder(video.path);
                if (!folderMap.has(folder)) {
                    const displayName = extractFolderName(video.path);
                    folderMap.set(folder, displayName);
                }
            }
        }

        // 只有多个文件夹时才显示按钮
        if (folderMap.size <= 1) {
            container.innerHTML = '';
            return;
        }

        // 生成按钮 HTML
        let html = `<button onclick="setSubtitleFolderFilter('')" data-folder="" class="px-3 py-1 text-xs font-medium rounded-full bg-blue-500 text-white transition-colors">全部</button>`;

        // 按显示名排序
        const sortedFolders = Array.from(folderMap.entries()).sort((a, b) =>
            a[1].localeCompare(b[1], undefined, { numeric: true, sensitivity: 'base' })
        );

        for (const [folder, displayName] of sortedFolders) {
            html += `<button onclick="setSubtitleFolderFilter('${escapeHtml(folder)}')" data-folder="${escapeHtml(folder)}" class="px-3 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/15 transition-colors">${escapeHtml(displayName)}</button>`;
        }
        container.innerHTML = html;
    }

    // 渲染字幕内容
    function renderSubtitlesContent(data) {
        const content = document.getElementById('subtitles-content');

        if (!data.video_files || data.video_files.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fa-solid fa-video-slash text-4xl text-slate-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-slate-500 dark:text-gray-400">暂无影片文件</p>
                    <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">请先下载并创建硬链接</p>
                </div>
            `;
            document.getElementById('subtitle-filter-stats').textContent = '';
            return;
        }

        // 将字幕按影片分组
        const subtitlesByVideo = {};
        if (data.subtitles) {
            for (const sub of data.subtitles) {
                const videoPath = sub.video_file_path;
                if (!subtitlesByVideo[videoPath]) {
                    subtitlesByVideo[videoPath] = [];
                }
                subtitlesByVideo[videoPath].push(sub);
            }
        }

        // 复制并处理影片列表
        let videoFiles = [...data.video_files];

        // 按文件夹筛选
        if (subtitleFolderFilter) {
            videoFiles = videoFiles.filter(v => extractFolder(v.path) === subtitleFolderFilter);
        }

        // 排序：使用自然排序（处理数字）
        videoFiles.sort((a, b) => {
            const nameA = a.path.split(/[/\\]/).pop();
            const nameB = b.path.split(/[/\\]/).pop();
            return nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
        });

        if (subtitleSortOrder === 'desc') {
            videoFiles.reverse();
        }

        // 更新筛选统计
        const totalVideos = data.video_files.length;
        const filteredVideos = videoFiles.length;
        const statsEl = document.getElementById('subtitle-filter-stats');
        if (subtitleFolderFilter) {
            statsEl.textContent = `显示 ${filteredVideos} / ${totalVideos} 个影片`;
        } else {
            statsEl.textContent = `共 ${totalVideos} 个影片`;
        }

        if (videoFiles.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fa-solid fa-filter-circle-xmark text-4xl text-slate-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-slate-500 dark:text-gray-400">当前文件夹无影片文件</p>
                    <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">请选择其他文件夹或查看全部</p>
                </div>
            `;
            return;
        }

        // 直接渲染影片列表（不再按文件夹分组）
        let html = '';

        for (const video of videoFiles) {
            const subs = subtitlesByVideo[video.path] || [];
            const videoBasename = video.path.split(/[/\\]/).pop();

            html += `
                <div class="bg-slate-50 dark:bg-white/[0.03] rounded-lg overflow-hidden border border-slate-200/50 dark:border-white/5">
                    <div class="px-4 py-2.5 border-b border-slate-200/50 dark:border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            <i class="fa-solid fa-video text-blue-500 text-sm flex-shrink-0"></i>
                            <span class="text-sm font-medium text-slate-700 dark:text-white truncate" title="${escapeHtml(video.path)}">${escapeHtml(videoBasename)}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                            ${subs.length > 0
                                ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">${subs.length} 字幕</span>`
                                : `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500 dark:bg-white/10 dark:text-gray-400">无字幕</span>`
                            }
                        </div>
                    </div>
            `;

            if (subs.length > 0) {
                html += '<div class="divide-y divide-slate-200/50 dark:divide-white/5">';
                for (const sub of subs) {
                    const langBadge = getLanguageBadge(sub.language_tag);
                    const subtitleBasename = sub.subtitle_path.split(/[/\\]/).pop();

                    html += `
                        <div class="px-4 py-2 flex items-center justify-between group hover:bg-slate-100 dark:hover:bg-white/5">
                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                <i class="fa-solid fa-closed-captioning text-emerald-500 text-sm flex-shrink-0"></i>
                                <div class="min-w-0 flex-1">
                                    <span class="text-xs text-slate-600 dark:text-gray-300 truncate block">${escapeHtml(subtitleBasename)}</span>
                                    <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                                        ${langBadge}
                                        <span class="text-[10px] text-slate-400 dark:text-gray-500">${escapeHtml(sub.subtitle_format || '-')}</span>
                                        ${sub.source_archive ? `<span class="text-[10px] text-slate-400 dark:text-gray-500">来源: ${escapeHtml(sub.source_archive)}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <button onclick="deleteSubtitle(${sub.id})" class="opacity-0 group-hover:opacity-100 w-6 h-6 rounded flex items-center justify-center bg-red-50 hover:bg-red-100 dark:bg-red-500/10 dark:hover:bg-red-500/20 text-red-500 dark:text-red-400 transition-all flex-shrink-0 ml-2" title="删除字幕">
                                <i class="fa-solid fa-trash text-[10px]"></i>
                            </button>
                        </div>
                    `;
                }
                html += '</div>';
            } else {
                html += `
                    <div class="px-4 py-2 text-center text-xs text-slate-400 dark:text-gray-500">
                        <i class="fa-solid fa-closed-captioning mr-1"></i> 暂无字幕
                    </div>
                `;
            }

            html += '</div>';
        }

        content.innerHTML = html;
    }

    // 获取语言标签徽章
    function getLanguageBadge(tag) {
        const langMap = {
            'chs': { name: '简中', color: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' },
            'cht': { name: '繁中', color: 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300' },
            'jpn': { name: '日语', color: 'bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300' },
            'eng': { name: '英语', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' },
            'kor': { name: '韩语', color: 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300' },
        };

        const lang = langMap[tag] || { name: tag || '未知', color: 'bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-slate-400' };
        return `<span class="px-1.5 py-0.5 rounded text-[10px] font-bold ${lang.color}">${lang.name}</span>`;
    }

    // 删除字幕
    async function deleteSubtitle(subtitleId) {
        if (!confirm('确定要删除这个字幕吗？字幕文件也将被删除。')) {
            return;
        }

        try {
            const response = await fetch(`/api/anime/${currentSubtitleAnimeId}/subtitles/${subtitleId}?delete_file=true`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.error) {
                showError('删除失败: ' + data.error);
                return;
            }

            showSuccess('字幕删除成功');
            await loadSubtitlesList();

        } catch (error) {
            showError('删除失败: ' + error.message);
        }
    }

    // 打开添加字幕 Modal
    function openAddSubtitleModal() {
        // 重置状态
        selectedSubtitleFile = null;
        document.getElementById('subtitle-file-input').value = '';
        document.getElementById('subtitle-upload-zone').classList.remove('hidden');
        document.getElementById('subtitle-selected-file').classList.add('hidden');
        document.getElementById('subtitle-progress').classList.add('hidden');
        document.getElementById('subtitle-result').classList.add('hidden');
        document.getElementById('btn-submit-subtitle').disabled = true;

        openModal('modal-add-subtitle');
    }

    // 关闭添加字幕 Modal
    function closeAddSubtitleModal() {
        closeModal('modal-add-subtitle');
        // 如果有匹配成功，刷新列表
        if (document.getElementById('subtitle-result').classList.contains('hidden') === false) {
            loadSubtitlesList();
        }
    }

    // 处理拖放
    function handleSubtitleDrop(event) {
        event.preventDefault();
        event.target.classList.remove('border-emerald-400', 'bg-emerald-50/50', 'dark:border-emerald-500/50', 'dark:bg-emerald-500/5');

        const files = event.dataTransfer.files;
        if (files.length > 0) {
            handleSubtitleFile(files[0]);
        }
    }

    // 处理文件选择
    function handleSubtitleFileSelect(event) {
        const files = event.target.files;
        if (files.length > 0) {
            handleSubtitleFile(files[0]);
        }
    }

    // 处理文件
    function handleSubtitleFile(file) {
        // 检查扩展名
        const allowedExtensions = ['.zip', '.rar', '.7z', '.tar', '.gz'];
        const ext = '.' + file.name.split('.').pop().toLowerCase();

        if (!allowedExtensions.includes(ext)) {
            showError(`不支持的文件格式: ${ext}。支持格式: ${allowedExtensions.join(', ')}`);
            return;
        }

        selectedSubtitleFile = file;

        // 显示选中文件
        document.getElementById('subtitle-upload-zone').classList.add('hidden');
        document.getElementById('subtitle-selected-file').classList.remove('hidden');
        document.getElementById('subtitle-filename').textContent = file.name;
        document.getElementById('subtitle-filesize').textContent = formatFileSize(file.size);
        document.getElementById('btn-submit-subtitle').disabled = false;
    }

    // 清除选中文件
    function clearSubtitleFile() {
        selectedSubtitleFile = null;
        document.getElementById('subtitle-file-input').value = '';
        document.getElementById('subtitle-upload-zone').classList.remove('hidden');
        document.getElementById('subtitle-selected-file').classList.add('hidden');
        document.getElementById('btn-submit-subtitle').disabled = true;
    }

    // 提交字幕压缩档
    async function submitSubtitleArchive() {
        if (!selectedSubtitleFile || !currentSubtitleAnimeId) {
            showError('请选择文件');
            return;
        }

        const btn = document.getElementById('btn-submit-subtitle');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 处理中...';

        // 显示进度
        document.getElementById('subtitle-selected-file').classList.add('hidden');
        document.getElementById('subtitle-progress').classList.remove('hidden');
        document.getElementById('subtitle-progress-text').textContent = '正在上传并处理...';
        document.getElementById('subtitle-progress-bar').style.width = '30%';

        try {
            const formData = new FormData();
            formData.append('archive', selectedSubtitleFile);

            document.getElementById('subtitle-progress-text').textContent = '正在调用AI匹配字幕...';
            document.getElementById('subtitle-progress-bar').style.width = '60%';

            const response = await fetch(`/api/anime/${currentSubtitleAnimeId}/subtitles/match`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            document.getElementById('subtitle-progress-bar').style.width = '100%';

            if (data.error) {
                document.getElementById('subtitle-progress').classList.add('hidden');
                showError('匹配失败: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-1"></i> 开始匹配';
                clearSubtitleFile();
                return;
            }

            // 显示结果
            document.getElementById('subtitle-progress').classList.add('hidden');
            document.getElementById('subtitle-result').classList.remove('hidden');

            let resultHtml = '';

            if (data.matched && data.matched.length > 0) {
                resultHtml += `<div class="text-xs text-emerald-600 dark:text-emerald-400 font-bold mb-2">✅ 成功匹配 ${data.matched.length} 个字幕</div>`;
                for (const m of data.matched) {
                    resultHtml += `
                        <div class="text-xs py-1 flex items-center gap-2">
                            <i class="fa-solid fa-check text-emerald-500"></i>
                            <span class="text-slate-600 dark:text-gray-300">${escapeHtml(m.subtitle)} → ${escapeHtml(m.video)}</span>
                            ${getLanguageBadge(m.language_tag)}
                        </div>
                    `;
                }
            }

            if (data.failed && data.failed.length > 0) {
                resultHtml += `<div class="text-xs text-red-600 dark:text-red-400 font-bold mt-3 mb-2">❌ 失败 ${data.failed.length} 个</div>`;
                for (const f of data.failed) {
                    resultHtml += `
                        <div class="text-xs py-1 flex items-center gap-2">
                            <i class="fa-solid fa-xmark text-red-500"></i>
                            <span class="text-slate-600 dark:text-gray-300">${escapeHtml(f.subtitle)}: ${escapeHtml(f.reason)}</span>
                        </div>
                    `;
                }
            }

            if (data.unmatched_subtitles && data.unmatched_subtitles.length > 0) {
                resultHtml += `<div class="text-xs text-amber-600 dark:text-amber-400 font-bold mt-3 mb-2">⚠️ 未匹配 ${data.unmatched_subtitles.length} 个</div>`;
                for (const u of data.unmatched_subtitles) {
                    resultHtml += `
                        <div class="text-xs py-1 flex items-center gap-2">
                            <i class="fa-solid fa-question text-amber-500"></i>
                            <span class="text-slate-500 dark:text-gray-400">${escapeHtml(u)}</span>
                        </div>
                    `;
                }
            }

            if (!resultHtml) {
                resultHtml = '<div class="text-xs text-slate-500 dark:text-gray-400">未匹配到任何字幕</div>';
            }

            document.getElementById('subtitle-result-content').innerHTML = resultHtml;

            showSuccess(`字幕匹配完成: ${data.total_matched || 0} 个成功`);

        } catch (error) {
            document.getElementById('subtitle-progress').classList.add('hidden');
            showError('处理失败: ' + error.message);
            clearSubtitleFile();
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-1"></i> 开始匹配';
        }
    }
</script>
{% endblock %}

