{% extends 'base.html' %}

{% block title %}动漫管理 - AniDown{% endblock %}

{% block styles %}
<style>
    /* 基础表单样式 */
    .form-control {
        background-color: #ffffff; 
        border: 1px solid #e2e8f0; 
        color: #334155;
    }
    .dark .form-control {
        background-color: rgba(255, 255, 255, 0.03); 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        color: #E4E4E7;
    }
    .dark .form-control option { 
        background-color: #18181b; 
        color: #E4E4E7; 
    }
    .form-control:focus {
        border-color: #3B82F6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* 表格样式 */
    tbody tr:hover { background-color: rgba(0, 0, 0, 0.02); }
    .dark tbody tr:hover { background-color: rgba(255, 255, 255, 0.03); }

    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
        transition: background-color 0.2s;
    }
    .sortable-header:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
    .dark .sortable-header:hover {
        background-color: rgba(59, 130, 246, 0.15);
    }
    .sort-indicator {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    .sortable-header:hover .sort-indicator {
        opacity: 0.8;
    }
    .sort-indicator.active {
        opacity: 1;
        color: #3B82F6;
    }
    .dark .sort-indicator.active {
        color: #60A5FA;
    }

    /* 筛选 Tab 选中状态 */
    .filter-tab.active {
        background-color: #ffffff;
        color: #0f172a;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    }
    .dark .filter-tab.active {
        background-color: #27272a;
        color: #ffffff;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4);
    }

    /* 禁用按钮样式 */
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    /* 自定义细滚动条 */
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.3);
        border-radius: 20px;
    }
    .dark .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* 文件列表样式 */
    .file-list-item {
        padding: 8px 12px;
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.02);
        margin-bottom: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        word-break: break-all;
    }
    .dark .file-list-item {
        background: rgba(255, 255, 255, 0.02);
    }
</style>
{% endblock %}

{% block content %}
    <!-- 1. 标题与摘要 -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-3">
                <i class="fa-solid fa-film text-purple-600 dark:text-neon-purple"></i>
                动漫管理
            </h1>
            <p class="text-slate-500 dark:text-gray-500 text-sm">管理所有动漫信息、文件和硬链接</p>
        </div>
        <div class="text-right">
            <p class="text-xs text-slate-400 dark:text-gray-500 font-mono">Total Anime</p>
            <p class="text-2xl font-bold text-slate-800 dark:text-white font-mono" id="total-records">Loading...</p>
        </div>
    </div>

    <!-- 2. 控制面板 (筛选与操作) -->
    <section class="glass-card rounded-xl p-5 space-y-4">
        <!-- 第一行：搜索与主要操作 -->
        <div class="flex flex-col lg:flex-row gap-4 justify-between">
            
            <!-- 搜索栏 -->
            <div class="flex gap-2 flex-1">
                <div class="relative flex-1 max-w-lg">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-500 text-sm"></i>
                    <input type="text" id="search-input" placeholder="搜索动漫标题、字幕组..." 
                        class="w-full pl-9 pr-10 py-2 rounded-lg text-sm font-medium form-control transition-all">
                    <button onclick="document.getElementById('search-input').value=''; renderTable()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <!-- 页面大小 -->
                <div class="relative w-24">
                     <select id="page-size" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-sm font-medium form-control cursor-pointer">
                        <option value="20">20条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-500 text-xs pointer-events-none"></i>
                </div>
            </div>
        </div>

        <!-- 第二行：高级筛选 -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 pt-4 border-t border-slate-200 dark:border-white/5">
            <!-- 媒体类型筛选 -->
            <div class="relative">
                <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">媒体类型</label>
                <select id="filter-media-type" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                    <option value="all">全部类型</option>
                    <option value="anime">动漫</option>
                    <option value="live_action">真人</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
            </div>
            <!-- 分类筛选 -->
            <div class="relative">
                <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">分类</label>
                <select id="filter-category" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                    <option value="all">全部</option>
                    <option value="tv">剧集</option>
                    <option value="movie">电影</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
            </div>
            <!-- TVDB筛选 -->
            <div class="relative">
                <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">TVDB</label>
                <select id="filter-tvdb" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                    <option value="all">全部</option>
                    <option value="linked">已链接</option>
                    <option value="unlinked">未链接</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
            </div>
            <!-- 分组方式 -->
            <div class="relative flex gap-2">
                <div class="relative flex-1">
                    <label class="absolute -top-2.5 left-2 text-[10px] font-bold text-slate-500 dark:text-gray-500 bg-white dark:bg-[#0F0F11] px-1 rounded">分组</label>
                    <select id="group-by" class="w-full appearance-none pl-3 pr-8 py-2 rounded-lg text-xs form-control cursor-pointer h-9">
                        <option value="">不分组</option>
                        <option value="subtitle_group">按字幕组</option>
                        <option value="media_type">按类型</option>
                        <option value="season">按季数</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-600 text-xs pointer-events-none"></i>
                </div>
                <button onclick="resetFilters()" class="h-9 px-3 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-white/5 dark:hover:bg-white/10 border border-slate-200 dark:border-white/10 text-slate-500 dark:text-gray-400 text-xs" title="清空筛选">
                    <i class="fa-solid fa-filter-circle-xmark"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- 3. 动漫列表 (Table) -->
    <section class="glass-card rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse table-fixed">
                <thead>
                    <tr class="border-b border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-white/5 text-xs text-slate-500 dark:text-gray-400 uppercase font-semibold">
                        <th class="py-3 pl-5 px-2 sortable-header" style="width: 20%;" onclick="toggleSort('short_title')">
                            动漫标题
                            <span class="sort-indicator" id="sort-short_title"></span>
                        </th>
                        <th class="py-3 px-2 sortable-header" style="width: 12%;" onclick="toggleSort('subtitle_group')">
                            字幕组
                            <span class="sort-indicator" id="sort-subtitle_group"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 8%;" onclick="toggleSort('season')">
                            季数
                            <span class="sort-indicator" id="sort-season"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 8%;" onclick="toggleSort('file_count')">
                            文件数
                            <span class="sort-indicator" id="sort-file_count"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 8%;" onclick="toggleSort('media_type')">
                            类型
                            <span class="sort-indicator" id="sort-media_type"></span>
                        </th>
                        <th class="py-3 px-2 text-center sortable-header" style="width: 10%;" onclick="toggleSort('tvdb_id')">
                            TVDB
                            <span class="sort-indicator" id="sort-tvdb_id"></span>
                        </th>
                        <th class="py-3 px-2 text-right sortable-header" style="width: 12%;" onclick="toggleSort('created_at')">
                            添加时间
                            <span class="sort-indicator" id="sort-created_at"></span>
                        </th>
                        <th class="py-3 pr-4 pl-2 text-right" style="width: 18%;">操作</th>
                    </tr>
                </thead>
                <tbody class="text-sm divide-y divide-slate-200 dark:divide-white/5" id="table-body">
                    <!-- JS 渲染 -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Footer -->
        <div class="flex items-center justify-between px-4 py-3 border-t border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-white/5">
            <div class="text-xs text-slate-500 dark:text-gray-500">
                显示 <span class="text-slate-900 dark:text-white font-bold" id="page-start">1</span> 到 <span class="text-slate-900 dark:text-white font-bold" id="page-end">20</span> 条，共 <span id="total-count-footer">...</span> 条
            </div>
            <div class="flex items-center gap-1" id="pagination-controls">
                <!-- 分页控件将通过JavaScript动态生成 -->
            </div>
        </div>
    </section>

    <!-- ============================================ -->
    <!-- 4. 文件详情 Modal -->
    <!-- ============================================ -->
    <div id="modal-files" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-files')"></div>
        
        <div class="modal-content bg-white dark:bg-[#18181b] w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden ring-1 ring-slate-900/5 transition-all transform scale-100">
            
            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-100 dark:border-white/5 flex justify-between items-start bg-slate-50/50 dark:bg-[#18181b]">
                <div class="space-y-1">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-600 dark:text-purple-400">
                            <i class="fa-solid fa-folder-open"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="files-modal-title">文件详情</h3>
                    </div>
                    <div id="files-modal-summary" class="text-xs text-slate-500 dark:text-slate-400 pl-11 flex gap-4">
                        <span>加载中...</span>
                    </div>
                </div>
                <button onclick="closeModal('modal-files')" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-thin">
                <!-- 原文件列表 -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-file-video text-blue-500"></i>
                        原文件路径
                    </h4>
                    <div id="original-files-list" class="space-y-1">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- 硬链接列表 -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-link text-emerald-500"></i>
                        硬链接路径
                    </h4>
                    <div id="hardlink-files-list" class="space-y-1">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="bg-slate-50 dark:bg-white/5 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-amber-500"></i>
                        统计信息
                    </h4>
                    <div class="grid grid-cols-3 gap-4 text-center" id="files-stats">
                        <!-- JS 填充 -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t border-slate-200 dark:border-white/10 bg-white dark:bg-[#18181b] p-4 flex justify-end">
                <button onclick="closeModal('modal-files')" class="px-4 py-2 rounded-lg bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors">
                    <i class="fa-solid fa-xmark mr-1"></i> 关闭
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 5. 删除确认 Modal -->
    <!-- ============================================ -->
    <div id="modal-delete" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-delete')"></div>
        <div class="modal-content bg-white dark:bg-[#1e1e20] w-full max-w-xl rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-rose-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-trash-can"></i> 删除动漫</h3>
                <button onclick="closeModal('modal-delete')" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-5">
                <!-- Warning Box -->
                <div class="bg-yellow-50 dark:bg-yellow-500/10 border border-yellow-200 dark:border-yellow-500/20 rounded-lg p-3 flex gap-3 items-start">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 dark:text-yellow-500 mt-0.5"></i>
                    <div class="text-sm text-yellow-700 dark:text-yellow-200 font-bold">警告：此操作不可撤销，请谨慎选择删除选项！</div>
                </div>

                <!-- 动漫信息 -->
                <div class="space-y-2 text-sm text-slate-600 dark:text-gray-300" id="delete-modal-info">
                    <!-- JS 填充 -->
                </div>

                <!-- 将要删除的路径预览 -->
                <div class="bg-slate-50 dark:bg-white/5 rounded-lg p-4 space-y-3" id="delete-paths-preview">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300">将要删除的路径：</h4>
                    <div id="delete-paths-list" class="space-y-2 text-xs font-mono">
                        <!-- JS 填充 -->
                    </div>
                </div>

                <!-- Options -->
                <div class="space-y-3 border-t border-b border-slate-200 dark:border-white/10 py-4">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="del-original" class="mt-1 w-4 h-4 rounded bg-slate-200 dark:bg-white/10 border-gray-400 text-rose-600 focus:ring-rose-500 cursor-pointer">
                        <label for="del-original" class="cursor-pointer">
                            <div class="text-sm font-bold text-slate-800 dark:text-white">删除原文件夹</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">从qBittorrent移除torrents并删除下载的原文件夹</div>
                        </label>
                    </div>
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="del-hardlinks" class="mt-1 w-4 h-4 rounded bg-slate-200 dark:bg-white/10 border-gray-400 text-rose-600 focus:ring-rose-500 cursor-pointer">
                        <label for="del-hardlinks" class="cursor-pointer">
                            <div class="text-sm font-bold text-slate-800 dark:text-white">删除硬链接文件夹</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">删除媒体库中的硬链接文件夹</div>
                        </label>
                    </div>
                    <div class="flex items-start gap-3 pt-2 border-t border-slate-200 dark:border-white/10">
                        <input type="checkbox" id="del-database" class="mt-1 w-4 h-4 rounded bg-slate-200 dark:bg-white/10 border-gray-400 text-rose-600 focus:ring-rose-500 cursor-pointer">
                        <label for="del-database" class="cursor-pointer">
                            <div class="text-sm font-bold text-rose-600 dark:text-rose-400">完全删除动漫（从数据库中删除）</div>
                            <div class="text-xs text-slate-500 dark:text-gray-400">删除数据库中所有相关记录，包括动漫信息、下载记录和硬链接记录</div>
                        </label>
                    </div>
                </div>

                <!-- Note -->
                <div class="bg-cyan-50 dark:bg-cyan-500/10 rounded-lg p-3 flex gap-3 text-xs text-cyan-700 dark:text-cyan-300">
                    <i class="fa-solid fa-circle-info mt-0.5"></i>
                    只删除原文件夹时，下载记录将移动到删除历史中保存，可随时查看。
                </div>
            </div>

            <!-- Actions -->
            <div class="px-6 py-4 bg-slate-50 dark:bg-[#1e1e20] border-t border-slate-200 dark:border-white/10 flex justify-end gap-3">
                <button onclick="closeModal('modal-delete')" class="px-4 py-2 rounded bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-xmark mr-1"></i> 取消</button>
                <button onclick="confirmDelete()" class="px-4 py-2 rounded bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-trash-can mr-1"></i> 确认删除</button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 6. 正则重建 Modal -->
    <!-- ============================================ -->
    <div id="modal-rebuild" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-backdrop" onclick="closeModal('modal-rebuild')"></div>
        <div class="modal-content bg-white dark:bg-[#1e1e20] w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-code"></i> 正则重建</h3>
                <button onclick="closeModal('modal-rebuild')" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-5">
                <!-- Info -->
                <div class="bg-blue-50 dark:bg-blue-500/10 border border-blue-200 dark:border-blue-500/20 rounded-lg p-3 flex gap-3 items-start">
                    <i class="fa-solid fa-circle-info text-blue-600 dark:text-blue-500 mt-0.5"></i>
                    <div class="text-sm text-blue-700 dark:text-blue-200">
                        使用AI重新生成正则表达式模式，以便更好地匹配文件名。
                    </div>
                </div>

                <!-- 动漫信息 -->
                <div class="space-y-2" id="rebuild-modal-info">
                    <!-- JS 填充 -->
                </div>

                <!-- 提示 -->
                <div class="bg-amber-50 dark:bg-amber-500/10 rounded-lg p-3 flex gap-3 text-xs text-amber-700 dark:text-amber-300">
                    <i class="fa-solid fa-lightbulb mt-0.5"></i>
                    <div>
                        <p class="font-bold mb-1">重建说明：</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>使用原始标题作为种子词</li>
                            <li>不会自动创建硬链接</li>
                            <li>保留原始提示词模板</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="px-6 py-4 bg-slate-50 dark:bg-[#1e1e20] border-t border-slate-200 dark:border-white/10 flex justify-end gap-3">
                <button onclick="closeModal('modal-rebuild')" class="px-4 py-2 rounded bg-slate-500 hover:bg-slate-600 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-xmark mr-1"></i> 取消</button>
                <button onclick="confirmRebuild()" id="btn-rebuild" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors"><i class="fa-solid fa-refresh mr-1"></i> 开始重建</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    let currentPage = 1;
    let perPage = 20;
    let searchTerm = '';
    let sortColumn = 'created_at';
    let sortOrder = 'desc';
    let mediaTypeFilter = 'all';
    let categoryFilter = 'all';
    let tvdbFilter = 'all';
    let groupBy = '';
    let viewingGroup = null;
    let currentDeleteAnimeId = null;
    let currentRebuildAnimeId = null;
    let requestCounter = 0;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        renderTable();
        updateSortIndicators();
    });

    // 初始化事件监听器
    function initializeEventListeners() {
        // 搜索功能
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.trim();
            currentPage = 1;
            renderTable();
        });

        // 页面大小改变
        document.getElementById('page-size').addEventListener('change', (e) => {
            perPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });

        // 筛选器
        document.getElementById('filter-media-type').addEventListener('change', (e) => {
            mediaTypeFilter = e.target.value;
            currentPage = 1;
            renderTable();
        });

        document.getElementById('filter-category').addEventListener('change', (e) => {
            categoryFilter = e.target.value;
            currentPage = 1;
            renderTable();
        });

        document.getElementById('filter-tvdb').addEventListener('change', (e) => {
            tvdbFilter = e.target.value;
            currentPage = 1;
            renderTable();
        });

        document.getElementById('group-by').addEventListener('change', (e) => {
            groupBy = e.target.value;
            viewingGroup = null;
            currentPage = 1;
            renderTable();
        });
    }

    // 切换排序
    function toggleSort(column) {
        if (sortColumn === column) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortOrder = 'desc';
        }
        currentPage = 1;
        updateSortIndicators();
        renderTable();
    }

    // 更新排序指示器
    function updateSortIndicators() {
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.className = 'sort-indicator';
            indicator.innerHTML = '<i class="fa-solid fa-sort"></i>';
        });

        const currentIndicator = document.getElementById(`sort-${sortColumn}`);
        if (currentIndicator) {
            currentIndicator.classList.add('active');
            if (sortOrder === 'asc') {
                currentIndicator.innerHTML = '<i class="fa-solid fa-sort-up"></i>';
            } else {
                currentIndicator.innerHTML = '<i class="fa-solid fa-sort-down"></i>';
            }
        }
    }

    // 渲染表格
    async function renderTable() {
        try {
            requestCounter++;
            const thisRequestId = requestCounter;

            const actualMediaTypeFilter = mediaTypeFilter === 'all' ? '' : mediaTypeFilter;
            const actualCategoryFilter = categoryFilter === 'all' ? '' : categoryFilter;
            const actualTvdbFilter = tvdbFilter === 'all' ? '' : tvdbFilter;

            const params = new URLSearchParams({
                page: currentPage,
                per_page: perPage,
                search: searchTerm,
                sort_column: sortColumn,
                sort_order: sortOrder,
                media_type_filter: actualMediaTypeFilter,
                category_filter: actualCategoryFilter,
                tvdb_filter: actualTvdbFilter,
                group_by: groupBy,
                viewing_group: viewingGroup || ''
            });

            const response = await fetch(`{{ url_for('anime.api_get_anime_list') }}?${params}`);
            const data = await response.json();

            if (thisRequestId !== requestCounter) {
                return;
            }

            if (data.error) {
                showError('加载失败: ' + data.error);
                return;
            }

            if (groupBy && !viewingGroup) {
                renderGroupedAnime(data);
                updatePagination({
                    total_count: data.total_count || 0,
                    current_page: 1,
                    per_page: data.total_count || 0,
                    total_pages: 1
                });
            } else {
                renderAnimeList(data);
                updatePagination({
                    total_count: data.total_count || 0,
                    current_page: data.current_page || 1,
                    per_page: data.per_page || perPage,
                    total_pages: data.total_pages || 0
                });
            }

            updateTotalRecords(data.total_count || 0);
        } catch (error) {
            console.error('渲染表格错误:', error);
            showError('加载失败: ' + error.message);
        }
    }

    // 渲染分组视图
    function renderGroupedAnime(data) {
        const tbody = document.getElementById('table-body');
        
        if (!data.groups || data.groups.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500 dark:text-gray-400">
                        <i class="fa-solid fa-info-circle text-2xl mb-2"></i>
                        <p>暂无数据</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        data.groups.forEach(group => {
            const groupName = group.group_name || '(未分类)';
            const displayName = group.display_name || groupName;

            html += `
                <tr class="hover:bg-slate-50 dark:hover:bg-white/5 cursor-pointer" onclick="viewGroupDetails('${escapeJs(groupName)}')">
                    <td class="py-3 pl-5 px-2 font-medium text-slate-700 dark:text-white">${escapeHtml(displayName)}</td>
                    <td class="py-3 px-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                            ${group.total_count} 部动漫
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-center">-</td>
                    <td class="py-3 px-2 text-right">-</td>
                    <td class="py-3 pr-4 pl-2 text-right">
                        <button onclick="event.stopPropagation(); viewGroupDetails('${escapeJs(groupName)}')" class="w-7 h-7 rounded-md flex items-center justify-center bg-blue-50 hover:bg-blue-100 dark:bg-blue-500/10 dark:hover:bg-blue-500/20 text-blue-500 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20 transition-colors" title="查看详情">
                            <i class="fa-solid fa-eye text-xs"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // 渲染动漫列表
    function renderAnimeList(data) {
        const tbody = document.getElementById('table-body');
        
        if (!data.anime_list || data.anime_list.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500 dark:text-gray-400">
                        <i class="fa-solid fa-info-circle text-2xl mb-2"></i>
                        <p>暂无动漫数据</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        
        // 如果正在查看分组详情，显示返回按钮
        if (viewingGroup) {
            html += `
                <tr>
                    <td colspan="8" class="py-3 px-5 bg-purple-50 dark:bg-purple-900/10">
                        <button onclick="exitGroupView()" class="inline-flex items-center gap-2 text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-200">
                            <i class="fa-solid fa-arrow-left"></i> 返回分组列表
                        </button>
                        <span class="ml-4 text-sm text-slate-600 dark:text-gray-300">当前查看: <strong>${escapeHtml(viewingGroup)}</strong></span>
                    </td>
                </tr>
            `;
        }

        data.anime_list.forEach(anime => {
            const mediaTypeBadge = anime.media_type === 'live_action' 
                ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">真人</span>'
                : '<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">动漫</span>';

            const tvdbBadge = anime.tvdb_id 
                ? `<a href="https://www.thetvdb.com/series/${anime.tvdb_id}" target="_blank" class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300 hover:bg-emerald-200 dark:hover:bg-emerald-900/50">${anime.tvdb_id}</a>`
                : '<span class="text-slate-400 dark:text-gray-600 text-xs">-</span>';

            html += `
                <tr class="group transition-colors hover:bg-slate-50 dark:hover:bg-white/5">
                    <td class="py-3 pl-5 px-2">
                        <div class="font-medium text-slate-700 dark:text-white truncate max-w-[200px]" title="${escapeHtml(anime.short_title || anime.original_title)}">${escapeHtml(anime.short_title || anime.original_title)}</div>
                    </td>
                    <td class="py-3 px-2 text-xs text-slate-500 dark:text-gray-400 whitespace-nowrap truncate max-w-[120px]" title="${escapeHtml(anime.subtitle_group || '-')}">${escapeHtml(anime.subtitle_group || '-')}</td>
                    <td class="py-3 px-2 text-center">
                        <span class="text-xs font-mono text-slate-600 dark:text-gray-500 bg-slate-100 dark:bg-white/5 px-1.5 py-0.5 rounded">S${anime.season || 1}</span>
                    </td>
                    <td class="py-3 px-2 text-center">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${anime.file_count > 0 ? 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300' : 'bg-slate-100 text-slate-600 dark:bg-white/5 dark:text-slate-400'}">
                            ${anime.file_count || 0}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center">
                        ${mediaTypeBadge}
                    </td>
                    <td class="py-3 px-2 text-center">
                        ${tvdbBadge}
                    </td>
                    <td class="py-3 px-2 text-right">
                        <div class="font-mono text-[10px] text-slate-500 dark:text-gray-500">${formatDate(anime.created_at, 'date')}</div>
                        <div class="font-mono text-[10px] text-slate-400 dark:text-gray-400">${formatDate(anime.created_at, 'time')}</div>
                    </td>
                    <td class="py-3 pr-4 pl-2 text-right">
                        <div class="flex justify-end gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                            <button onclick="openFilesModal(${anime.id})" class="w-7 h-7 rounded-md flex items-center justify-center bg-blue-50 hover:bg-blue-100 dark:bg-blue-500/10 dark:hover:bg-blue-500/20 text-blue-500 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20 transition-colors" title="查看文件">
                                <i class="fa-solid fa-folder-open text-xs"></i>
                            </button>
                            <button onclick="openRebuildModal(${anime.id}, '${escapeJs(anime.short_title || anime.original_title)}', '${escapeJs(anime.original_title)}')" class="w-7 h-7 rounded-md flex items-center justify-center bg-amber-50 hover:bg-amber-100 dark:bg-amber-500/10 dark:hover:bg-amber-500/20 text-amber-500 dark:text-amber-400 border border-amber-200 dark:border-amber-500/20 transition-colors" title="正则重建">
                                <i class="fa-solid fa-code text-xs"></i>
                            </button>
                            <button onclick="openDeleteModal(${anime.id})" class="w-7 h-7 rounded-md flex items-center justify-center bg-red-50 hover:bg-red-100 dark:bg-red-500/10 dark:hover:bg-red-500/20 text-red-500 dark:text-red-400 border border-red-200 dark:border-red-500/20 transition-colors" title="删除">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // 更新分页信息
    function updatePagination(data) {
        const paginationControls = document.getElementById('pagination-controls');
        const pageStart = document.getElementById('page-start');
        const pageEnd = document.getElementById('page-end');

        const totalCount = data.total_count || 0;
        const currentPage = data.current_page || 1;
        const perPage = data.per_page || 20;
        const totalPages = data.total_pages || 0;

        let start = 0;
        let end = 0;

        if (totalCount > 0) {
            start = (currentPage - 1) * perPage + 1;
            end = Math.min(currentPage * perPage, totalCount);
        }

        pageStart.textContent = start;
        pageEnd.textContent = end;

        let html = '';

        // 上一页按钮
        if (currentPage > 1) {
            html += `
                <button onclick="changePage(${currentPage - 1})" class="px-2 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 dark:text-gray-400 transition-colors">
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="px-2 py-1 rounded text-slate-300 dark:text-gray-600 cursor-not-allowed" disabled>
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
            `;
        }

        // 页码按钮
        if (totalPages > 0) {
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<button onclick="changePage(1)" class="px-2.5 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-500 dark:text-gray-400 text-xs transition-colors">1</button>`;
                if (startPage > 2) {
                    html += `<span class="px-2 text-slate-400 dark:text-gray-600 text-xs">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button class="px-2.5 py-1 rounded bg-purple-600 text-white text-xs font-bold">${i}</button>`;
                } else {
                    html += `<button onclick="changePage(${i})" class="px-2.5 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-500 dark:text-gray-400 text-xs transition-colors">${i}</button>`;
                }
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="px-2 text-slate-400 dark:text-gray-600 text-xs">...</span>`;
                }
                html += `<button onclick="changePage(${totalPages})" class="px-2.5 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-500 dark:text-gray-400 text-xs transition-colors">${totalPages}</button>`;
            }
        }

        // 下一页按钮
        if (currentPage < totalPages) {
            html += `
                <button onclick="changePage(${currentPage + 1})" class="px-2 py-1 rounded hover:bg-slate-200 dark:hover:bg-white/10 text-slate-400 dark:text-gray-400 transition-colors">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            `;
        } else {
            html += `
                <button class="px-2 py-1 rounded text-slate-300 dark:text-gray-600 cursor-not-allowed" disabled>
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            `;
        }

        paginationControls.innerHTML = html;
    }

    // 更新总记录数
    function updateTotalRecords(count) {
        document.getElementById('total-records').textContent = count;
        document.getElementById('total-count-footer').textContent = count;
    }

    // 切换页面
    function changePage(page) {
        currentPage = page;
        renderTable();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 查看分组详情
    function viewGroupDetails(groupName) {
        viewingGroup = groupName;
        currentPage = 1;
        renderTable();
    }

    // 退出分组查看
    function exitGroupView() {
        viewingGroup = null;
        currentPage = 1;
        renderTable();
    }

    // 重置筛选器
    function resetFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-media-type').value = 'all';
        document.getElementById('filter-category').value = 'all';
        document.getElementById('filter-tvdb').value = 'all';
        document.getElementById('group-by').value = '';

        searchTerm = '';
        mediaTypeFilter = 'all';
        categoryFilter = 'all';
        tvdbFilter = 'all';
        groupBy = '';
        viewingGroup = null;
        currentPage = 1;
        renderTable();
    }

    // Modal 控制
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
    }
    
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden'); 
    }

    // 打开文件详情 Modal
    async function openFilesModal(animeId) {
        openModal('modal-files');
        
        // 显示加载状态
        document.getElementById('files-modal-title').textContent = '加载中...';
        document.getElementById('files-modal-summary').innerHTML = '<span>正在获取文件信息...</span>';
        document.getElementById('original-files-list').innerHTML = '<div class="text-center py-4 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        document.getElementById('hardlink-files-list').innerHTML = '<div class="text-center py-4 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        document.getElementById('files-stats').innerHTML = '';

        try {
            const response = await fetch(`{{ url_for('anime.api_get_anime_details', anime_id=0) }}`.replace('0', animeId));
            const data = await response.json();

            if (data.error) {
                showError('获取文件详情失败: ' + data.error);
                closeModal('modal-files');
                return;
            }

            // 更新标题
            document.getElementById('files-modal-title').textContent = data.anime.short_title || data.anime.original_title;
            document.getElementById('files-modal-summary').innerHTML = `
                <span><i class="fa-regular fa-file-video mr-1"></i> ${data.original_files.length} 个下载记录</span>
                <span><i class="fa-solid fa-link mr-1"></i> ${data.hardlink_files.length} 个硬链接</span>
            `;

            // 渲染原文件列表
            let originalHtml = '';
            if (data.original_files.length === 0) {
                originalHtml = '<div class="text-slate-400 dark:text-gray-500 text-sm py-2">暂无原文件记录</div>';
            } else {
                for (const file of data.original_files) {
                    const fullPath = file.directory ? `${file.directory}/${file.filename}` : file.filename;
                    const statusBadge = file.status === 'completed' 
                        ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">已完成</span>'
                        : `<span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-slate-400">${file.status}</span>`;
                    
                    originalHtml += `
                        <div class="file-list-item flex justify-between items-start gap-2">
                            <span class="break-all flex-1">${escapeHtml(fullPath)}</span>
                            ${statusBadge}
                        </div>
                    `;
                }
            }
            document.getElementById('original-files-list').innerHTML = originalHtml;

            // 渲染硬链接列表
            let hardlinkHtml = '';
            if (data.hardlink_files.length === 0) {
                hardlinkHtml = '<div class="text-slate-400 dark:text-gray-500 text-sm py-2">暂无硬链接</div>';
            } else {
                for (const link of data.hardlink_files) {
                    hardlinkHtml += `
                        <div class="file-list-item">
                            <div class="text-emerald-600 dark:text-emerald-400 break-all">${escapeHtml(link.hardlink_path)}</div>
                            <div class="text-slate-400 dark:text-gray-500 mt-1 text-[10px]">→ ${escapeHtml(link.original_path)}</div>
                        </div>
                    `;
                }
            }
            document.getElementById('hardlink-files-list').innerHTML = hardlinkHtml;

            // 渲染统计信息
            document.getElementById('files-stats').innerHTML = `
                <div>
                    <div class="text-2xl font-bold text-slate-800 dark:text-white">${data.original_files.length}</div>
                    <div class="text-xs text-slate-500 dark:text-gray-400">下载记录</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${data.hardlink_files.length}</div>
                    <div class="text-xs text-slate-500 dark:text-gray-400">硬链接</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${formatFileSize(data.total_size)}</div>
                    <div class="text-xs text-slate-500 dark:text-gray-400">总大小</div>
                </div>
            `;

        } catch (error) {
            showError('获取文件详情失败: ' + error.message);
            closeModal('modal-files');
        }
    }

    // 监听"完全删除动漫"复选框变化
    document.getElementById('del-database').addEventListener('change', function() {
        const delOriginal = document.getElementById('del-original');
        const delHardlinks = document.getElementById('del-hardlinks');
        
        if (this.checked) {
            // 当勾选"完全删除"时，自动勾选并禁用其他两个选项
            delOriginal.checked = true;
            delHardlinks.checked = true;
            delOriginal.disabled = true;
            delHardlinks.disabled = true;
        } else {
            // 取消勾选时，取消勾选并启用其他两个选项
            delOriginal.checked = false;
            delHardlinks.checked = false;
            delOriginal.disabled = false;
            delHardlinks.disabled = false;
        }
    });

    // 打开删除确认 Modal
    async function openDeleteModal(animeId) {
        currentDeleteAnimeId = animeId;
        
        // 重置复选框状态
        document.getElementById('del-original').checked = false;
        document.getElementById('del-original').disabled = false;
        document.getElementById('del-hardlinks').checked = false;
        document.getElementById('del-hardlinks').disabled = false;
        document.getElementById('del-database').checked = false;

        // 显示加载状态
        document.getElementById('delete-modal-info').innerHTML = '<div class="text-center py-2 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> 加载中...</div>';
        document.getElementById('delete-paths-list').innerHTML = '<div class="text-center py-2 text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        
        openModal('modal-delete');

        try {
            const response = await fetch(`{{ url_for('anime.api_get_anime_folders', anime_id=0) }}`.replace('0', animeId));
            const data = await response.json();

            if (data.error) {
                showError('获取动漫信息失败: ' + data.error);
                closeModal('modal-delete');
                return;
            }

            // 显示动漫信息
            document.getElementById('delete-modal-info').innerHTML = `
                <div class="flex"><span class="font-bold w-20 shrink-0">动漫标题:</span> <span class="truncate">${escapeHtml(data.anime_title)}</span></div>
                <div class="flex"><span class="font-bold w-20 shrink-0">下载数量:</span> <span>${data.download_count} 个</span></div>
            `;

            // 显示将要删除的路径
            document.getElementById('delete-paths-list').innerHTML = `
                <div class="space-y-2">
                    <div>
                        <span class="text-rose-600 dark:text-rose-400 font-bold">原文件夹:</span>
                        <div class="text-slate-600 dark:text-gray-300 break-all mt-1">${escapeHtml(data.original_folder)}</div>
                    </div>
                    <div>
                        <span class="text-rose-600 dark:text-rose-400 font-bold">硬链接文件夹:</span>
                        <div class="text-slate-600 dark:text-gray-300 break-all mt-1">${escapeHtml(data.hardlink_folder)}</div>
                    </div>
                </div>
            `;

        } catch (error) {
            showError('获取动漫信息失败: ' + error.message);
            closeModal('modal-delete');
        }
    }

    // 确认删除
    async function confirmDelete() {
        const deleteOriginal = document.getElementById('del-original').checked;
        const deleteHardlinks = document.getElementById('del-hardlinks').checked;
        const deleteDatabase = document.getElementById('del-database').checked;

        if (!deleteOriginal && !deleteHardlinks && !deleteDatabase) {
            showError('请至少选择一个删除选项');
            return;
        }

        if (deleteDatabase && !confirm('确定要从数据库中完全删除这个动漫吗？此操作不可撤销！')) {
            return;
        }

        try {
            const response = await fetch(`{{ url_for('anime.api_delete_anime', anime_id=0) }}`.replace('0', currentDeleteAnimeId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    delete_original: deleteOriginal,
                    delete_hardlinks: deleteHardlinks,
                    delete_from_database: deleteDatabase
                })
            });

            const data = await response.json();

            if (data.error) {
                showError('删除失败: ' + data.error);
                return;
            }

            let message = '删除成功！';
            if (data.original_deleted) {
                message += ` 原文件夹已删除，${data.torrents_removed || 0} 个torrents已从qBittorrent移除。`;
            }
            if (data.hardlinks_deleted) {
                message += ' 硬链接文件夹已删除。';
            }
            if (data.database_deleted) {
                message += ' 数据库记录已删除。';
            }
            if (data.downloads_moved_to_history > 0) {
                message += ` ${data.downloads_moved_to_history} 条下载记录已移动到删除历史。`;
            }

            showSuccess(message);
            closeModal('modal-delete');
            renderTable();

        } catch (error) {
            showError('删除失败: ' + error.message);
        }
    }

    // 打开正则重建 Modal
    function openRebuildModal(animeId, shortTitle, originalTitle) {
        currentRebuildAnimeId = animeId;
        
        document.getElementById('rebuild-modal-info').innerHTML = `
            <div class="text-sm text-slate-600 dark:text-gray-300 space-y-2">
                <div class="flex"><span class="font-bold w-20 shrink-0">动漫标题:</span> <span>${escapeHtml(shortTitle)}</span></div>
                <div class="flex"><span class="font-bold w-20 shrink-0">原始标题:</span> <span class="text-xs font-mono break-all">${escapeHtml(originalTitle)}</span></div>
            </div>
        `;
        
        openModal('modal-rebuild');
    }

    // 确认正则重建
    async function confirmRebuild() {
        const btn = document.getElementById('btn-rebuild');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 重建中...';

        try {
            const response = await fetch(`{{ url_for('anime.api_rebuild_regex', anime_id=0) }}`.replace('0', currentRebuildAnimeId), {
                method: 'POST'
            });

            const data = await response.json();

            if (data.error) {
                showError('正则重建失败: ' + data.error);
                return;
            }

            showSuccess('正则模式重建成功！');
            closeModal('modal-rebuild');

        } catch (error) {
            showError('正则重建失败: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-refresh mr-1"></i> 开始重建';
        }
    }
</script>
{% endblock %}

