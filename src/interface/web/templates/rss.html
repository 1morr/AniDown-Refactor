<!-- filename: templates/rss.html -->
{% extends 'base.html' %}

{% block title %}AniDown{% endblock %}

{% block styles %}
<style>
    /* 开关样式 - 仅在此页面使用 */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #3B82F6;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #3B82F6;
    }
    /* 文本域聚焦 */
    textarea:focus {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<!-- 页面标题 -->
<header>
    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-1 flex items-center gap-3">
        <i class="fa-solid fa-rss text-emerald-500 dark:text-emerald-400"></i> RSS 处理
    </h1>
    <p class="text-slate-500 dark:text-gray-500 text-sm">手动输入 RSS 链接或管理自动任务</p>
</header>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
    
    <!-- 左侧：添加任务表单 -->
    <!-- Flask Todo: 可以给 form 添加 action 和 method 来提交数据 -->
    <div class="lg:col-span-2 glass-card rounded-xl p-6 flex flex-col transition-all">
        <h3 class="font-semibold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
            <i class="fa-solid fa-circle-plus text-slate-400"></i> 添加 RSS 处理任务
        </h3>

        <!-- 模式切换开关 -->
        <div class="bg-slate-50 dark:bg-white/5 rounded-lg p-4 mb-6 flex items-center justify-between border border-slate-100 dark:border-white/5 transition-all" id="mode-card">
            <div>
                <div class="text-sm font-medium text-slate-800 dark:text-white transition-all" id="mode-title">AI 处理模式</div>
                <div class="text-xs text-slate-500 dark:text-gray-400 mt-0.5 transition-all" id="mode-desc">AI自动识别动漫信息并处理</div>
            </div>
            <label for="mode-toggle" class="flex items-center cursor-pointer relative">
                <input type="checkbox" id="mode-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-slate-200 dark:bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 dark:peer-checked:bg-blue-500"></div>
            </label>
        </div>

        <!-- RSS 链接输入 -->
        <div class="mb-6">
            <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">RSS 链接</label>
            <input type="text" id="rss-input" placeholder="https://example.com/rss.xml"
                class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm text-slate-800 dark:text-white focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all font-mono placeholder-slate-400 dark:placeholder-gray-600">
            <p class="text-xs text-slate-400 dark:text-gray-600 mt-2">确保该RSS链接中只包含同一个动漫的项目</p>
        </div>

        <!-- 媒体类型选择 (AI和手动模式都显示) -->
        <div class="mb-6" id="ai-media-type-field">
            <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">媒体类型</label>
            <select id="ai_media_type" class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                <option value="anime" selected>动漫</option>
                <option value="live_action">真人</option>
            </select>
        </div>

        <!-- 手动模式扩展区域 (JS控制显示) -->
        <div id="manual-fields" class="hidden overflow-hidden transition-all duration-500 ease-in-out opacity-0 transform translate-y-4">
            <div class="mb-6 p-3 rounded-lg bg-cyan-50 dark:bg-cyan-500/10 border border-cyan-100 dark:border-cyan-500/20 flex items-start gap-3">
                <i class="fa-solid fa-circle-info text-cyan-500 mt-0.5 text-sm"></i>
                <div class="text-xs text-cyan-700 dark:text-cyan-300 leading-relaxed">
                    <span class="font-bold">手动添加模式：</span> 请填写以下信息，系统将跳过AI识别，直接使用您提供的信息处理RSS。
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">动漫短标题 <span class="text-rose-500">*</span></label>
                    <input type="text" id="short_title" placeholder="例如：进击的巨人" class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">字幕组</label>
                    <input type="text" id="subtitle_group" placeholder="例如：幻樱" class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">季数</label>
                    <input type="number" id="season" value="1" class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">类型</label>
                    <select id="category" class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="tv">剧集</option>
                        <option value="movie">电影</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-gray-500 uppercase mb-2">媒体类型</label>
                    <select id="media_type" class="w-full bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="anime" selected>动漫</option>
                        <option value="live_action">真人</option>
                    </select>
                </div>
            </div>
            <div class="mb-6 p-3 rounded-lg bg-amber-50 dark:bg-amber-500/10 border border-amber-100 dark:border-amber-500/20 flex items-start gap-3">
                <i class="fa-solid fa-triangle-exclamation text-amber-500 mt-0.5 text-sm"></i>
                <div class="text-xs text-amber-700 dark:text-amber-400 font-bold leading-relaxed">重要提醒：请确保RSS链接中只包含同一个动漫的项目。</div>
            </div>
        </div>

        <!-- 触发过滤器弹窗的按钮 -->
        <!-- Flask Todo: 点击此按钮后，可以通过 fetch 将 RSS 发送到后端进行预处理，获取过滤器需要的信息 -->
        <button onclick="openFilterModal()" class="w-full py-3 rounded-lg bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-medium shadow-lg shadow-emerald-500/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2 mt-auto">
            <i class="fa-solid fa-play"></i> 开始处理 (带过滤器)
        </button>
    </div>

    <!-- 右侧：说明卡片 (Sticky) -->
    <div class="glass-card rounded-xl p-6 flex flex-col h-fit sticky top-24">
        <h3 class="font-semibold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
            <i class="fa-solid fa-circle-info text-slate-400"></i> 使用说明
        </h3>
        <div class="space-y-2 mb-6">
            <div class="text-xs text-slate-500 dark:text-gray-400 flex items-start gap-2"><i class="fa-solid fa-check text-emerald-500 mt-0.5"></i> <span>解析RSS feed中的动漫信息</span></div>
            <div class="text-xs text-slate-500 dark:text-gray-400 flex items-start gap-2"><i class="fa-solid fa-check text-emerald-500 mt-0.5"></i> <span>自动下载种子文件</span></div>
            <div class="text-xs text-slate-500 dark:text-gray-400 flex items-start gap-2"><i class="fa-solid fa-check text-emerald-500 mt-0.5"></i> <span>创建硬链接到目标目录</span></div>
            <div class="text-xs text-slate-500 dark:text-gray-400 flex items-start gap-2"><i class="fa-solid fa-check text-emerald-500 mt-0.5"></i> <span>支持多种RSS格式</span></div>
        </div>
        <div class="mt-auto">
            <label class="block text-[10px] font-bold text-slate-400 dark:text-gray-500 uppercase mb-2">当前配置的 RSS 链接</label>
            <div class="bg-slate-100 dark:bg-black/40 border border-slate-200 dark:border-white/5 rounded-lg p-3 mb-4">
                <!-- Flask Todo: 此处使用 {{ current_rss_url }} 变量 -->
                {% if config.fixed_rss_urls %}
                    {% for feed in config.fixed_rss_urls %}
                    <p class="text-[10px] font-mono text-slate-600 dark:text-slate-400 break-all mb-1">{{ feed.url }}</p>
                    {% endfor %}
                {% else %}
                    <p class="text-[10px] font-mono text-slate-600 dark:text-slate-400 break-all">暂无配置的RSS链接</p>
                {% endif %}
            </div>
            <div class="grid grid-cols-2 gap-2">
                <!-- Flask Todo: 为这些按钮添加实际的链接或 JS 事件 -->
                <a href="{{ url_for('config.config_page') }}" class="px-3 py-2 rounded bg-blue-50 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400 text-xs font-medium border border-blue-200 dark:border-blue-500/20 hover:bg-blue-100 dark:hover:bg-blue-500/20 transition-colors text-center"><i class="fa-solid fa-gear mr-1"></i> 配置链接</a>
                <button onclick="refreshAllRSS()" id="refresh-all-btn" class="px-3 py-2 rounded bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 text-xs font-medium border border-emerald-200 dark:border-emerald-500/20 hover:bg-emerald-100 dark:hover:bg-emerald-500/20 transition-colors"><i class="fa-solid fa-rotate mr-1"></i> 立即刷新</button>
                <button onclick="fetchAllBangumiRSS()" id="fetch-all-btn" title="仅支持 Mikan (mikanani.me) RSS链接，其他来源的RSS将被跳过" class="col-span-2 px-3 py-2 rounded bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-slate-300 text-xs font-medium border border-slate-200 dark:border-white/10 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors"><i class="fa-solid fa-cloud-arrow-down mr-1"></i> 获取所有 <span class="text-[10px] text-slate-400 dark:text-gray-500">(仅Mikan)</span></button>
            </div>
        </div>
    </div>
</section>

<!-- 历史记录表格 -->
<section class="glass-card rounded-xl p-6">
    <div class="flex justify-between items-center mb-6">
        <h3 class="font-semibold text-slate-800 dark:text-white flex items-center gap-2">
            <i class="fa-solid fa-clock-rotate-left text-slate-400"></i> 处理历史
        </h3>
        <button class="text-xs text-slate-400 hover:text-slate-700 dark:text-gray-500 dark:hover:text-white transition"><i class="fa-solid fa-filter"></i> 筛选</button>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="text-xs text-slate-500 dark:text-gray-500 uppercase border-b border-slate-200 dark:border-white/5">
                <tr>
                    <th class="pb-3 font-medium pl-2">处理时间</th>
                    <th class="pb-3 font-medium">触发方式</th>
                    <th class="pb-3 font-medium">RSS 链接</th>
                    <th class="pb-3 font-medium">统计</th>
                    <th class="pb-3 font-medium text-right pr-2">操作</th>
                </tr>
            </thead>
            <!-- Flask Todo: 使用 Jinja2 循环渲染历史数据 -->
            <!-- Example: {% for item in history %} ... {% endfor %} -->
            <tbody class="divide-y divide-slate-100 dark:divide-white/5 text-sm" id="history-table-body">
                <!-- JS渲染的内容（后端接入后请删除JS渲染逻辑） -->
            </tbody>
        </table>
    </div>
</section>

<!-- ========================================================================= -->
<!-- 1. RSS详情弹窗 (历史详情)                                                 -->
<!-- ========================================================================= -->
<div id="rss-details-modal" class="fixed inset-0 z-[60] hidden items-center justify-center">
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeDetailsModal()"></div>
    <div class="relative bg-white dark:bg-[#18181b] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden m-4 border border-slate-200 dark:border-white/10">
        <div class="px-6 py-4 border-b border-slate-200 dark:border-white/5 flex justify-between items-center bg-white dark:bg-[#18181b] z-10">
            <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> RSS处理详情</h3>
            <button onclick="closeDetailsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <!-- 弹窗内容区域，ID用于JS填充 -->
        <div class="p-6 overflow-y-auto custom-scrollbar">
            <!-- Flask Todo: 如果做成服务端渲染弹窗，可以将此处内容单独提取为一个模板 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="space-y-4">
                    <div><span class="text-sm text-slate-500 dark:text-gray-400">处理时间：</span><span class="font-mono text-slate-800 dark:text-white ml-2" id="modal-time">-</span></div>
                    <div class="flex items-center gap-2"><span class="text-sm text-slate-500 dark:text-gray-400">触发方式：</span><span id="modal-trigger" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-cyan-50 dark:bg-cyan-500/10 text-cyan-600 dark:text-cyan-400 border border-cyan-200 dark:border-cyan-500/20">定时触发</span></div>
                    <div class="flex items-center gap-2"><span class="text-sm text-slate-500 dark:text-gray-400">状态：</span><div id="modal-status"></div></div>
                </div>
                <div>
                    <div class="text-sm text-slate-500 dark:text-gray-400 mb-1">RSS链接：</div>
                    <div class="text-xs font-mono text-slate-600 dark:text-slate-400 break-all bg-slate-100 dark:bg-white/5 p-2 rounded border border-slate-200 dark:border-white/5" id="modal-link">...</div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="text-center p-3 rounded-lg bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5"><div class="text-xs text-slate-500 dark:text-gray-400 uppercase mb-1">总项目</div><div class="text-lg font-mono font-bold text-slate-800 dark:text-white" id="modal-total">0</div></div>
                <div class="text-center p-3 rounded-lg bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5"><div class="text-xs text-slate-500 dark:text-gray-400 uppercase mb-1">尝试项目</div><div class="text-lg font-mono font-bold text-slate-800 dark:text-white" id="modal-attempt">0</div></div>
                <div class="text-center p-3 rounded-lg bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5"><div class="text-xs text-slate-500 dark:text-gray-400 uppercase mb-1">成功率</div><div class="text-lg font-mono font-bold text-emerald-500" id="modal-rate">0%</div></div>
            </div>
            <div>
                <h4 class="text-sm font-bold text-slate-700 dark:text-gray-300 mb-3 border-l-4 border-emerald-500 pl-2">处理详情</h4>
                <div class="overflow-x-auto border border-slate-200 dark:border-white/10 rounded-lg">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 dark:bg-white/5 text-xs text-slate-500 dark:text-gray-400 uppercase">
                            <tr><th class="px-4 py-3 font-medium">项目标题</th><th class="px-4 py-3 font-medium w-24">状态</th><th class="px-4 py-3 font-medium w-32">失败原因</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-white/5" id="modal-logs-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="px-6 py-4 bg-slate-50 dark:bg-white/5 border-t border-slate-200 dark:border-white/5 flex justify-end gap-3">
            <button class="px-4 py-2 rounded-lg bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold transition-colors flex items-center gap-2"><i class="fa-solid fa-trash"></i> 删除记录</button>
            <button onclick="closeDetailsModal()" class="px-4 py-2 rounded-lg bg-slate-500 hover:bg-slate-600 text-white text-xs font-bold transition-colors">关闭</button>
        </div>
    </div>
</div>

<!-- ========================================================================= -->
<!-- 2. 过滤器弹窗 (Filter Settings Modal)                                     -->
<!-- ========================================================================= -->
<div id="filter-modal" class="fixed inset-0 z-[70] hidden items-center justify-center">
    <div class="fixed inset-0 bg-black/70 backdrop-blur-md transition-opacity" onclick="closeFilterModal()"></div>
    
    <div class="relative bg-white dark:bg-[#18181b] rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col m-4 border border-slate-200 dark:border-white/10 transition-all duration-300 transform scale-95" id="filter-modal-content">
        
        <div class="px-6 py-4 border-b border-slate-200 dark:border-white/5 flex justify-between items-center bg-white dark:bg-[#18181b] z-10 rounded-t-xl">
            <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-filter text-slate-400"></i> AI处理模式 - 过滤器设置
            </h3>
            <button onclick="closeFilterModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
            <!-- 输入区：屏蔽词 & 正则 -->
            <!-- Flask Todo: 提交时，将这些 textarea 的内容发送给后端 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-2">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">屏蔽词</label>
                    <textarea id="filter-words" class="w-full h-32 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-800 dark:text-white font-mono focus:outline-none focus:border-blue-500 transition-all resize-none" 
                        placeholder="每行一个屏蔽词，当标题包含这些词时将被跳过&#10;例如：&#10;合集&#10;OVA"></textarea>
                    <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">每行一个屏蔽词，当标题包含这些词时将被跳过</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">正则表达式</label>
                    <textarea id="filter-regex" class="w-full h-32 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-white/10 rounded-lg p-3 text-sm text-slate-800 dark:text-white font-mono focus:outline-none focus:border-blue-500 transition-all resize-none" 
                        placeholder="每行一个正则表达式，当标题匹配时将被跳过&#10;例如：&#10;.*\[合集\].*"></textarea>
                    <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">每行一个正则表达式，当标题匹配时将被跳过</p>
                </div>
            </div>

            <!-- 预览结果区 -->
            <div id="filter-preview-section" class="hidden mt-8 border-t border-slate-200 dark:border-white/5 pt-6">
                <div class="grid grid-cols-4 gap-4 mb-6 text-center">
                    <div><div class="text-3xl font-bold text-blue-500 font-mono" id="preview-total">0</div><div class="text-xs text-slate-500 dark:text-gray-400 mt-1">总项目数</div></div>
                    <div><div class="text-3xl font-bold text-emerald-500 font-mono" id="preview-passed">0</div><div class="text-xs text-slate-500 dark:text-gray-400 mt-1">通过项目</div></div>
                    <div><div class="text-3xl font-bold text-rose-500 font-mono" id="preview-filtered">0</div><div class="text-xs text-slate-500 dark:text-gray-400 mt-1">被过滤</div></div>
                    <div><div class="text-3xl font-bold text-amber-500 font-mono" id="preview-new">0</div><div class="text-xs text-slate-500 dark:text-gray-400 mt-1">新项目</div></div>
                </div>
                <div class="overflow-hidden border border-slate-200 dark:border-white/10 rounded-lg max-h-[350px] overflow-y-auto custom-scrollbar relative">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 dark:bg-[#202024] text-xs text-slate-500 dark:text-gray-400 uppercase sticky top-0 z-10 shadow-sm">
                            <tr><th class="px-4 py-3 font-bold">标题</th><th class="px-4 py-3 font-bold w-24 text-center">状态</th><th class="px-4 py-3 font-bold w-48">原因</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-white/5" id="filter-preview-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="px-6 py-4 bg-slate-50 dark:bg-white/5 border-t border-slate-200 dark:border-white/5 flex justify-end gap-3 rounded-b-xl">
            <button onclick="closeFilterModal()" class="px-5 py-2 rounded-lg bg-slate-500 hover:bg-slate-600 text-white text-sm font-bold transition-colors">取消</button>
            <!-- Flask Todo: 点击预览时，发送 Ajax 请求到后端，模拟过滤结果 -->
            <button onclick="showFilterPreview()" class="px-5 py-2 rounded-lg bg-transparent border border-blue-500 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-500/10 text-sm font-bold transition-colors flex items-center gap-2"><i class="fa-solid fa-magnifying-glass"></i> 预览</button>
            <!-- Flask Todo: 点击开始处理时，提交整个表单 -->
            <button onclick="submitFilterForm()" class="px-5 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold transition-colors flex items-center gap-2"><i class="fa-solid fa-play"></i> 开始处理</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // AI/手动模式切换
    const modeToggle = document.getElementById('mode-toggle');
    const manualFields = document.getElementById('manual-fields');
    const modeTitle = document.getElementById('mode-title');
    const modeDesc = document.getElementById('mode-desc');

    modeToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            modeTitle.textContent = "手动添加模式";
            modeDesc.textContent = "手动填写动漫信息，跳过AI识别";
            manualFields.classList.remove('hidden');
            setTimeout(() => manualFields.classList.remove('opacity-0', 'translate-y-4'), 10);
        } else {
            modeTitle.textContent = "AI 处理模式";
            modeDesc.textContent = "AI自动识别动漫信息并处理";
            manualFields.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => manualFields.classList.add('hidden'), 300);
        }
    });

    // 加载RSS历史记录
    function loadRSSHistory() {
        fetch('/api/rss_history')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('加载历史记录失败:', data.error);
                    showEmptyHistory(); // 显示空状态
                    return;
                }
                displayHistory(data.history);
            })
            .catch(error => {
                console.error('加载历史记录失败:', error);
                showEmptyHistory(); // 显示空状态
            });
    }

    // 显示空历史状态
    function showEmptyHistory() {
        const tbody = document.getElementById('history-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="py-8 text-center text-slate-400 dark:text-gray-600">
                    <i class="fa-solid fa-info-circle mr-2"></i>
                    暂无RSS处理历史记录
                </td>
            </tr>
        `;
    }

    function displayHistory(history) {
        const tbody = document.getElementById('history-table-body');

        if (!history || history.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="py-8 text-center text-slate-400 dark:text-gray-600">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        暂无RSS处理历史记录
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = history.map((record, index) => {
            // record 结构: [id, rss_url, triggered_by, items_found, items_attempted, items_processed, created_at, status, completed_at]
            const isQueued = record[7] === 'queued';
            const isProcessing = record[7] === 'processing';
            const isCompleted = record[7] === 'completed';
            const isInterrupted = record[7] === 'interrupted';
            const rssUrl = record[1].length > 50 ? record[1].substring(0, 50) + '...' : record[1];

            let statsDisplay = '';
            let detailsButton = '';
            let statusBadge = '';

            if (isQueued) {
                statsDisplay = '<span class="text-blue-500 dark:text-blue-400">队列中...</span>';
                statusBadge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-blue-50 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20">队列中</span>';
                detailsButton = '<small class="text-slate-400 dark:text-gray-600">等待处理...</small>';
            } else if (isProcessing) {
                statsDisplay = '<span class="text-amber-500 dark:text-amber-400">处理中...</span>';
                statusBadge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-amber-50 dark:bg-amber-500/10 text-amber-600 dark:text-amber-400 border border-amber-200 dark:border-amber-500/20">处理中</span>';
                detailsButton = '<small class="text-slate-400 dark:text-gray-600">处理中...</small>';
            } else if (isCompleted) {
                const itemsAttempted = record[4] || 0;
                const itemsProcessed = record[5] || 0;
                const itemsFound = record[3] || 0;

                statsDisplay = `
                    <span class="text-emerald-600 dark:text-emerald-400 font-bold">${itemsProcessed}</span> /
                    <span class="text-slate-500 dark:text-gray-400">${itemsAttempted}</span>
                    <span class="text-slate-400 dark:text-gray-500 text-xs ml-1">(${itemsFound})</span>
                `;
                statusBadge = getTriggerTypeBadge(record[2]);
                detailsButton = `
                    <button onclick="viewDetails(${record[0]})" class="px-3 py-1 rounded bg-slate-100 dark:bg-white/5 hover:bg-blue-50 dark:hover:bg-blue-500/10 text-slate-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 text-xs transition-colors border border-slate-200 dark:border-white/10">
                        <i class="fa-solid fa-circle-info mr-1"></i> 详情
                    </button>
                `;
            } else if (isInterrupted) {
                const itemsAttempted = record[4] || 0;
                const itemsProcessed = record[5] || 0;
                const itemsFound = record[3] || 0;

                statsDisplay = `
                    <span class="text-orange-600 dark:text-orange-400 font-bold">${itemsProcessed}</span> /
                    <span class="text-slate-500 dark:text-gray-400">${itemsAttempted}</span>
                    <span class="text-slate-400 dark:text-gray-500 text-xs ml-1">(${itemsFound})</span>
                `;
                statusBadge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-orange-50 dark:bg-orange-500/10 text-orange-600 dark:text-orange-400 border border-orange-200 dark:border-orange-500/20">已中断</span>';
                detailsButton = `
                    <button onclick="viewDetails(${record[0]})" class="px-3 py-1 rounded bg-slate-100 dark:bg-white/5 hover:bg-blue-50 dark:hover:bg-blue-500/10 text-slate-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 text-xs transition-colors border border-slate-200 dark:border-white/10">
                        <i class="fa-solid fa-circle-info mr-1"></i> 详情
                    </button>
                `;
            } else {
                const itemsAttempted = record[4] || 0;
                const itemsProcessed = record[5] || 0;
                statsDisplay = `<span class="text-slate-400 dark:text-gray-600">${itemsProcessed}/${itemsAttempted}</span>`;
                statusBadge = getStatusBadge(record[7]);
                detailsButton = '<small class="text-slate-400 dark:text-gray-600">未知状态</small>';
            }

            // 格式化处理时间（使用created_at，索引为6）
            let displayTime = '-';
            if (record[6]) {  // created_at (ISO时间字符串)
                displayTime = formatDate(record[6]);
            }
            
            return `
                <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                    <td class="py-4 pl-2 font-mono text-slate-600 dark:text-slate-400 text-xs">${displayTime}</td>
                    <td class="py-4">${statusBadge}</td>
                    <td class="py-4">
                        <div class="text-xs font-mono text-slate-500 dark:text-gray-500 truncate max-w-[200px] xl:max-w-[350px]" title="${record[1]}">${rssUrl}</div>
                    </td>
                    <td class="py-4 text-sm font-mono">${statsDisplay}</td>
                    <td class="py-4 pr-2 text-right">${detailsButton}</td>
                </tr>
            `;
        }).join('');
    }

    function getTriggerTypeBadge(triggerType) {
        const badgeMap = {
            'WebUI触发': 'bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-500/20',
            '定时触发': 'bg-cyan-50 dark:bg-cyan-500/10 text-cyan-600 dark:text-cyan-400 border-cyan-200 dark:border-cyan-500/20',
            '手动触发': 'bg-purple-50 dark:bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-200 dark:border-purple-500/20',
            '手动添加': 'bg-purple-50 dark:bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-200 dark:border-purple-500/20',
            '启动时触发': 'bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 border-indigo-200 dark:border-indigo-500/20',
            '获取所有番组': 'bg-violet-50 dark:bg-violet-500/10 text-violet-600 dark:text-violet-400 border-violet-200 dark:border-violet-500/20',
            '获取所有': 'bg-violet-50 dark:bg-violet-500/10 text-violet-600 dark:text-violet-400 border-violet-200 dark:border-violet-500/20',
            '立即刷新': 'bg-amber-50 dark:bg-amber-500/10 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-500/20'
        };
        const classes = badgeMap[triggerType] || 'bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-slate-400 border-slate-200 dark:border-white/10';
        return `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${classes} border">${triggerType}</span>`;
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadRSSHistory();

        // 设置定时刷新RSS历史（每10秒刷新一次）
        setInterval(loadRSSHistory, 10000);
    });

    // 查看详情（从后端API获取）
    function viewDetails(historyId) {
        fetch(`/api/rss_history/${historyId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showFlashMessage('error', '加载详情失败: ' + data.error);
                    return;
                }
                displayDetailsModal(data.history, data.details);
            })
            .catch(error => {
                showFlashMessage('error', '加载详情失败: ' + error.message);
            });
    }

    function displayDetailsModal(history, details) {
        const modal = document.getElementById('rss-details-modal');

        // 格式化时间（history结构: [id, rss_url, triggered_by, items_found, items_attempted, items_processed, created_at, status, completed_at]）
        let processingTime = '未知';
        if (history[6]) { // created_at (ISO时间字符串)
            processingTime = formatDate(history[6]);
        }

        document.getElementById('modal-time').innerText = processingTime;
        document.getElementById('modal-total').innerText = history[3] || 0;
        document.getElementById('modal-attempt').innerText = history[4] || 0;
        document.getElementById('modal-rate').innerText = history[4] > 0 ? Math.round((history[5] / history[4]) * 100) + '%' : '0%';
        document.getElementById('modal-link').innerText = history[1];

        // 更新触发方式
        const triggerElement = document.getElementById('modal-trigger');
        triggerElement.innerText = history[2];
        triggerElement.className = `px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border ${getTriggerTypeBadge(history[2]).split('class="')[1].split('"')[0]}`;

        // 更新状态
        const statusElement = document.getElementById('modal-status');
        if (statusElement) {
            statusElement.innerHTML = getStatusBadge(history[7]);
        }

        const logsBody = document.getElementById('modal-logs-body');
        if (details && details.length > 0) {
            logsBody.innerHTML = details.map(detail => {
                const failureReason = detail[3] || '-';
                const tooltipAttr = detail[3] ? `title="${escapeHtml(detail[3])}"` : '';
                return `
                <tr class="border-b border-slate-50 dark:border-white/5 last:border-0">
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300 font-mono text-xs break-all">${detail[1]}</td>
                    <td class="px-4 py-3 text-center">
                        ${getStatusBadge(detail[2])}
                    </td>
                    <td class="px-4 py-3 text-slate-400 text-xs break-all cursor-default" ${tooltipAttr}>${escapeHtml(failureReason)}</td>
                </tr>`;
            }).join('');
        } else {
            logsBody.innerHTML = '<tr><td colspan="3" class="px-4 py-3 text-center text-slate-400 dark:text-gray-600">暂无详细信息</td></tr>';
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function getStatusBadge(status) {
        switch(status) {
            case 'success':
            case 'completed':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-600 text-white">成功</span>`;
            case 'failed':
            case 'error':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-rose-500 text-white">失败</span>`;
            case 'processing':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500 text-white">处理中</span>`;
            case 'interrupted':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-500 text-white">已中断</span>`;
            case 'info':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-cyan-500 text-white">信息</span>`;
            case 'exists':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-500 text-white">已存在</span>`;
            case 'filtered':
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-500 text-white">已过滤</span>`;
            default:
                return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-500 text-white">${status || '未知'}</span>`;
        }
    }

    // escapeHtml 已在 utils.js 中定义

    function closeDetailsModal() {
        const modal = document.getElementById('rss-details-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // 过滤器弹窗逻辑
    const filterModal = document.getElementById('filter-modal');
    const filterModalContent = document.getElementById('filter-modal-content');
    const filterPreviewSection = document.getElementById('filter-preview-section');
    const filterPreviewBody = document.getElementById('filter-preview-body');

    function openFilterModal() {
        const rssUrl = document.getElementById('rss-input').value.trim();
        if (!rssUrl) {
            showFlashMessage('warning', '请先输入RSS链接');
            return;
        }

        // 检查是否是手动添加模式
        const isManualMode = modeToggle.checked;

        // 如果是手动模式，检查必填字段
        if (isManualMode) {
            const shortTitle = document.getElementById('short_title').value.trim();
            if (!shortTitle) {
                showFlashMessage('warning', '手动添加模式下，动漫短标题为必填项');
                return;
            }
        }

        // 更新弹窗标题
        const modalTitle = document.querySelector('#filter-modal h3');
        modalTitle.innerHTML = `<i class="fa-solid fa-filter text-slate-400"></i> ${isManualMode ? '手动添加模式' : 'AI处理模式'} - 过滤器设置`;

        filterModal.classList.remove('hidden');
        filterModal.classList.add('flex');
        setTimeout(() => filterModalContent.classList.remove('scale-95'), 10);
        filterPreviewSection.classList.add('hidden'); // 重置预览状态
    }

    function closeFilterModal() {
        filterModalContent.classList.add('scale-95');
        setTimeout(() => {
            filterModal.classList.add('hidden');
            filterModal.classList.remove('flex');
        }, 150);
    }

    function showFilterPreview() {
        const rssUrl = document.getElementById('rss-input').value.trim();
        const blockedKeywords = document.getElementById('filter-words').value.trim();
        const blockedRegex = document.getElementById('filter-regex').value.trim();

        if (!rssUrl) {
            showFlashMessage('warning', '请先输入RSS链接');
            return;
        }

        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 处理中...';
        btn.disabled = true;

        // 准备请求数据
        const requestData = {
            rss_url: rssUrl,
            blocked_keywords: blockedKeywords,
            blocked_regex: blockedRegex
        };

        // 发送预览请求
        fetch('/api/preview_filters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;

            if (data.error) {
                showFlashMessage('error', '预览失败: ' + data.error);
                return;
            }

            displayPreviewResults(data);
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            showFlashMessage('error', '预览请求失败: ' + error.message);
        });
    }

    function displayPreviewResults(data) {
        const results = data.results;
        const stats = data.stats;

        // 更新统计数字
        document.getElementById('preview-total').innerText = stats.total;
        document.getElementById('preview-passed').innerText = stats.passed;
        document.getElementById('preview-filtered').innerText = stats.filtered;
        document.getElementById('preview-new').innerText = stats.new;

        // 生成项目表格
        filterPreviewBody.innerHTML = results.map(item => {
            const statusBadge = item.status === 'filtered' 
                ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-rose-500 text-white block w-fit mx-auto">被过滤</span>`
                : item.status === 'exists'
                ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-500 text-white block w-fit mx-auto">已存在</span>`
                : `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-600 text-white block w-fit mx-auto">通过</span>`;
            
            return `
            <tr class="border-b border-slate-50 dark:border-white/5 hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                <td class="px-4 py-3 text-slate-700 dark:text-slate-300 font-mono text-xs break-all">${item.title}</td>
                <td class="px-4 py-3 text-center">${statusBadge}</td>
                <td class="px-4 py-3 text-slate-500 dark:text-gray-400 text-xs">${item.reason || '-'}</td>
            </tr>`;
        }).join('');
        
        filterPreviewSection.classList.remove('hidden');
        filterModalContent.scrollTop = filterModalContent.scrollHeight;
    }

    function submitFilterForm() {
        const rssUrl = document.getElementById('rss-input').value.trim();
        const blockedKeywords = document.getElementById('filter-words').value.trim();
        const blockedRegex = document.getElementById('filter-regex').value.trim();
        const isManualMode = modeToggle.checked;

        if (!rssUrl) {
            showFlashMessage('warning', '请先输入RSS链接');
            return;
        }

        // 如果是手动模式，检查必填字段
        if (isManualMode) {
            const shortTitle = document.getElementById('short_title').value.trim();
            if (!shortTitle) {
                showFlashMessage('warning', '手动添加模式下，动漫短标题为必填项');
                return;
            }
        }

        // 关闭模态框
        closeFilterModal();

        // 准备请求数据
        const requestData = {
            rss_url: rssUrl,
            blocked_keywords: blockedKeywords,
            blocked_regex: blockedRegex,
            is_manual_mode: isManualMode,
            media_type: isManualMode ? document.getElementById('media_type').value : document.getElementById('ai_media_type').value
        };

        // 如果是手动模式，添加额外字段
        if (isManualMode) {
            requestData.short_title = document.getElementById('short_title').value.trim();
            requestData.subtitle_group = document.getElementById('subtitle_group').value.trim();
            requestData.season = parseInt(document.getElementById('season').value);
            requestData.category = document.getElementById('category').value;
        }

        // 发送请求
        fetch('/process_unified_rss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showFlashMessage('error', '处理失败： ' + data.error);
            } else {
                showFlashMessage('success', data.message || '处理已启动');
                
                // 清空表单字段
                document.getElementById('rss-input').value = '';
                document.getElementById('filter-words').value = '';
                document.getElementById('filter-regex').value = '';
                document.getElementById('ai_media_type').value = 'anime';

                if (isManualMode) {
                    document.getElementById('short_title').value = '';
                    document.getElementById('subtitle_group').value = '';
                    document.getElementById('season').value = '1';
                    document.getElementById('category').value = 'tv';
                    document.getElementById('media_type').value = 'anime';
                }
                
                // 刷新历史记录
                setTimeout(loadRSSHistory, 1000);
            }
        })
        .catch(error => {
            showFlashMessage('error', '处理请求失败: ' + error.message);
        });
    }

    // 立即刷新所有配置的RSS
    function refreshAllRSS() {
        const btn = document.getElementById('refresh-all-btn');
        if (!btn) return;

        // 禁用按钮并显示加载状态
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 处理中...';

        fetch('/api/refresh_all_rss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-rotate mr-1"></i> 立即刷新';

            if (data.error) {
                showFlashMessage('error', '刷新失败: ' + data.error);
            } else {
                showFlashMessage('success', data.message || 'RSS刷新已启动');
                // 刷新历史记录
                setTimeout(loadRSSHistory, 1000);
            }
        })
        .catch(error => {
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-rotate mr-1"></i> 立即刷新';
            alert('刷新请求失败: ' + error.message);
        });
    }

    // 获取所有番组RSS
    function fetchAllBangumiRSS() {
        const btn = document.getElementById('fetch-all-btn');
        if (!btn) return;

        // 确认操作
        if (!confirm('此操作将从所有配置的RSS链接中提取番组信息并生成标准RSS链接进行处理。\n\n这可能需要一些时间，确定要继续吗？')) {
            return;
        }

        // 禁用按钮并显示加载状态
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 获取中...';

        fetch('/api/fetch_all_bangumi_rss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down mr-1"></i> 获取所有';

            if (data.error) {
                showFlashMessage('error', '获取失败: ' + data.error);
            } else {
                let message = data.message || '番组RSS获取已启动';
                if (data.rss_links && data.rss_links.length > 0) {
                    message += ` - 生成了 ${data.rss_links.length} 个RSS链接`;
                }
                showFlashMessage('success', message);
                // 刷新历史记录
                setTimeout(loadRSSHistory, 1000);
            }
        })
        .catch(error => {
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down mr-1"></i> 获取所有';
            showFlashMessage('error', '获取请求失败: ' + error.message);
        });
    }
</script>
{% endblock %}
