<!-- filename: templates/config.html -->
{% extends "base.html" %}

{% block title %}AniDown{% endblock %}

{% block content %}

<!-- Flash Messages (Server-side) -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    {% for category, message in messages %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                showFlashMessage('{{ category }}', '{{ message }}');
            });
        </script>
    {% endfor %}
{% endif %}
{% endwith %}

<div class="flex flex-col lg:flex-row gap-8">
    
    <!-- 左侧侧边栏导航 (Sticky) -->
    <aside class="w-full lg:w-64 flex-shrink-0">
        <div class="lg:sticky lg:top-24 glass-card rounded-xl p-4">
            <h3 class="text-xs font-bold text-slate-500 dark:text-gray-500 uppercase tracking-wider mb-4 ml-2">设置导航</h3>
            <nav class="space-y-1 flex flex-row lg:flex-col overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 gap-2 lg:gap-0">
                <a href="#section-rss" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-700 dark:text-white bg-slate-200 dark:bg-white/10 whitespace-nowrap">
                    <i class="fa-solid fa-rss w-4 text-center"></i> RSS 订阅
                </a>
                <a href="#section-ai" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white dark:hover:bg-white/5 whitespace-nowrap">
                    <i class="fa-solid fa-robot w-4 text-center"></i> AI 与 LLM
                </a>
                <a href="#section-downloader" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white dark:hover:bg-white/5 whitespace-nowrap">
                    <i class="fa-solid fa-download w-4 text-center"></i> 下载器 (QB)
                </a>
                <a href="#section-notification" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white dark:hover:bg-white/5 whitespace-nowrap">
                    <i class="fa-brands fa-discord w-4 text-center"></i> 通知服务
                </a>
                <a href="#section-file" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white dark:hover:bg-white/5 whitespace-nowrap">
                    <i class="fa-solid fa-folder-tree w-4 text-center"></i> 文件与路径
                </a>
                <a href="#section-basic" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-900 dark:text-gray-400 dark:hover:text-white dark:hover:bg-white/5 whitespace-nowrap">
                    <i class="fa-solid fa-sliders w-4 text-center"></i> 端口设置
                </a>
            </nav>
        </div>
    </aside>

    <!-- 右侧表单内容 -->
    <div class="flex-1 space-y-8 pb-20">

        <!-- 1. RSS 订阅 -->
        <section id="section-rss" class="glass-card rounded-xl p-6 scroll-mt-24">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-white/5 pb-4">
                <div class="p-2 bg-yellow-100 dark:bg-yellow-500/10 rounded-lg text-yellow-600 dark:text-yellow-400"><i class="fa-solid fa-rss"></i></div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">RSS 订阅设置</h2>
            </div>

            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">固定 RSS 链接列表</label>
            <div id="rss_list" class="space-y-4">
                <!-- JS 将动态插入 RSS 输入框 -->
                {% for feed in config.rss.get_feeds() %}
                <div class="rss-feed-item border border-slate-200 dark:border-white/10 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <div class="flex-1">
                            <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">RSS URL</label>
                            <input type="text" class="input-field rss-url-input" placeholder="https://..." value="{{ feed.url if feed is not string else feed }}">
                        </div>
                        <div class="w-32">
                            <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">类型</label>
                            <select class="input-field rss-media-type-select">
                                <option value="anime" {{ 'selected' if (feed is not string and feed.media_type == 'anime') or feed is string else '' }}>动漫</option>
                                <option value="live_action" {{ 'selected' if (feed is not string and feed.media_type == 'live_action') else '' }}>真人</option>
                            </select>
                        </div>
                        <button onclick="toggleRssFilters(this)" class="mt-6 px-3 py-2 text-slate-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors" title="展开过滤设置">
                            <i class="fa-solid fa-filter"></i>
                        </button>
                        <button onclick="removeRssFeed(this)" class="mt-6 px-3 py-2 text-slate-400 hover:text-red-500 transition-colors" title="删除">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <div class="rss-filters mt-4 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">屏蔽词 (每行一个)</label>
                                <textarea class="input-field rss-keywords-input min-h-[100px]" placeholder="例如：简体&#10;1080p">{{ feed.blocked_keywords if feed is not string else '' }}</textarea>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">正则表达式 (每行一个)</label>
                                <textarea class="input-field rss-regex-input min-h-[100px]" placeholder="例如：.*\[1080p\].*">{{ feed.blocked_regex if feed is not string else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not config.rss.fixed_urls %}
                <div class="rss-feed-item border border-slate-200 dark:border-white/10 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <div class="flex-1">
                            <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">RSS URL</label>
                            <input type="text" class="input-field rss-url-input" placeholder="https://..." value="">
                        </div>
                        <div class="w-32">
                            <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">类型</label>
                            <select class="input-field rss-media-type-select">
                                <option value="anime" selected>动漫</option>
                                <option value="live_action">真人</option>
                            </select>
                        </div>
                        <button onclick="toggleRssFilters(this)" class="mt-6 px-3 py-2 text-slate-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors" title="展开过滤设置">
                            <i class="fa-solid fa-filter"></i>
                        </button>
                        <button onclick="removeRssFeed(this)" class="mt-6 px-3 py-2 text-slate-400 hover:text-red-500 transition-colors" title="删除">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <div class="rss-filters mt-4 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">屏蔽词 (每行一个)</label>
                                <textarea class="input-field rss-keywords-input min-h-[100px]" placeholder="例如：简体&#10;1080p"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">正则表达式 (每行一个)</label>
                                <textarea class="input-field rss-regex-input min-h-[100px]" placeholder="例如：.*\[1080p\].*"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <button onclick="addRssField()" class="mt-4 flex items-center gap-2 text-sm text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 transition-colors">
                <i class="fa-solid fa-plus"></i> 添加 RSS 链接
            </button>

            <div class="mt-6">
                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">检查间隔 (秒)</label>
                <input type="number" id="rss_interval" class="input-field md:w-1/3" value="{{ config.rss.check_interval }}">
            </div>
        </section>

        <!-- 2. AI 与 LLM -->
        <section id="section-ai" class="glass-card rounded-xl p-6 scroll-mt-24">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-white/5 pb-4">
                <div class="p-2 bg-cyan-100 dark:bg-cyan-500/10 rounded-lg text-cyan-600 dark:text-neon-cyan"><i class="fa-solid fa-robot"></i></div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">AI / LLM 设置</h2>
            </div>
            <div class="grid grid-cols-1 gap-6">
                <!-- 标题解析 -->
                <div class="border border-slate-200 dark:border-white/10 rounded-lg overflow-hidden">
                    <button type="button" onclick="toggleCollapsible('title_parse_section')" class="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                        <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300">标题解析</h4>
                        <i id="title_parse_section_icon" class="fa-solid fa-chevron-right text-slate-400 dark:text-gray-500 transition-transform duration-300"></i>
                    </button>
                    <div id="title_parse_section" class="collapsible-content border-t border-slate-200 dark:border-white/10" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                        <div class="p-4">

                    <!-- 独立配置（选择 Pool 后禁用） -->
                    <div id="title_parse_standalone_config" class="grid grid-cols-1 gap-4 {{ 'opacity-50 pointer-events-none' if config.openai.title_parse.pool_name else '' }}">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API Base URL</label>
                            <input type="text" id="ai_title_parse_base_url" class="input-field" value="{{ config.get('openai.title_parse.base_url', 'https://api.openai.com/v1') }}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API Key</label>
                            <div class="relative">
                                <input type="password" id="ai_title_parse_api_key" class="input-field pr-8" value="{{ config.get('openai.title_parse.api_key', '') }}">
                                <button type="button" onclick="togglePassword('ai_title_parse_api_key')" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-white">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pool 选择 -->
                    <div class="mt-4">
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">使用 Key Pool</label>
                        <select id="title_parse_pool_select" class="input-field" onchange="onPoolSelect('title_parse')">
                            <option value="">-- 不使用 Pool (独立配置) --</option>
                            {% for pool in config.openai.key_pools %}
                            <option value="{{ pool.name }}" {{ 'selected' if config.openai.title_parse.pool_name == pool.name else '' }}>{{ pool.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">选择 Key Pool 后将使用该 Pool 的 Base URL 和 API Keys</p>
                    </div>

                    <!-- 任务特定配置（始终可用） -->
                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">模型 (Model)</label>
                            <input type="text" id="ai_title_parse_model" class="input-field" value="{{ config.get('openai.title_parse.model', 'gpt-4') }}">
                            <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">每个任务独立配置模型</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">标题解析重试次数</label>
                                <input type="number" id="ai_title_parse_retries" class="input-field" value="{{ config.get('openai.title_parse.retries', 3) }}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API 超时时间 (秒)</label>
                                <input type="number" id="ai_title_parse_timeout" class="input-field" min="10" max="600" value="{{ config.get('openai.title_parse.timeout', 180) }}">
                                <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">推荐: 180 秒</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">Extra Body (JSON格式)</label>
                            <textarea id="ai_title_parse_extra_body" class="input-field min-h-[80px] font-mono text-xs" placeholder='例如启用思考模式: {"thinking": {"type": "enabled"}}'>{{ config.get('openai.title_parse.extra_body', '') }}</textarea>
                            <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">可选。额外的API参数，此设置独立于 Key Pool，始终使用本任务的配置。</p>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

                <!-- 多文件重命名 -->
                <div class="border border-slate-200 dark:border-white/10 rounded-lg overflow-hidden">
                    <button type="button" onclick="toggleCollapsible('multi_file_rename_section')" class="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                        <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300">多文件重命名</h4>
                        <i id="multi_file_rename_section_icon" class="fa-solid fa-chevron-right text-slate-400 dark:text-gray-500 transition-transform duration-300"></i>
                    </button>
                    <div id="multi_file_rename_section" class="collapsible-content border-t border-slate-200 dark:border-white/10" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                        <div class="p-4">

                    <!-- 独立配置（选择 Pool 后禁用） -->
                    <div id="multi_file_rename_standalone_config" class="grid grid-cols-1 gap-4 {{ 'opacity-50 pointer-events-none' if config.openai.multi_file_rename.pool_name else '' }}">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API Base URL</label>
                            <input type="text" id="ai_multi_rename_base_url" class="input-field" value="{{ config.get('openai.multi_file_rename.base_url', 'https://api.openai.com/v1') }}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API Key</label>
                            <div class="relative">
                                <input type="password" id="ai_multi_rename_api_key" class="input-field pr-8" value="{{ config.get('openai.multi_file_rename.api_key', '') }}">
                                <button type="button" onclick="togglePassword('ai_multi_rename_api_key')" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-white">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pool 选择 -->
                    <div class="mt-4">
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">使用 Key Pool</label>
                        <select id="multi_file_rename_pool_select" class="input-field" onchange="onPoolSelect('multi_file_rename')">
                            <option value="">-- 不使用 Pool (独立配置) --</option>
                            {% for pool in config.openai.key_pools %}
                            <option value="{{ pool.name }}" {{ 'selected' if config.openai.multi_file_rename.pool_name == pool.name else '' }}>{{ pool.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">选择 Key Pool 后将使用该 Pool 的 Base URL 和 API Keys</p>
                    </div>

                    <!-- 任务特定配置（始终可用） -->
                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">模型 (Model)</label>
                            <input type="text" id="ai_multi_rename_model" class="input-field" value="{{ config.get('openai.multi_file_rename.model', 'gpt-4') }}">
                            <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">每个任务独立配置模型</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">Extra Body (JSON格式)</label>
                            <textarea id="ai_multi_rename_extra_body" class="input-field min-h-[80px] font-mono text-xs" placeholder='例如启用思考模式: {"thinking": {"type": "enabled"}}'>{{ config.get('openai.multi_file_rename.extra_body', '') }}</textarea>
                            <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">可选。额外的API参数，此设置独立于 Key Pool，始终使用本任务的配置。</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">最大批次大小</label>
                                <input type="number" id="ai_batch_size" class="input-field" value="{{ config.get('openai.multi_file_rename.max_batch_size', 30) }}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">批次重试次数</label>
                                <input type="number" id="ai_batch_retries" class="input-field" value="{{ config.get('openai.multi_file_rename.batch_processing_retries', 2) }}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API 超时时间 (秒)</label>
                                <input type="number" id="ai_multi_rename_timeout" class="input-field" min="10" max="600" value="{{ config.get('openai.multi_file_rename.timeout', 180) }}">
                                <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">推荐: 360 秒</p>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

                <!-- 字幕匹配 -->
                <div class="border border-slate-200 dark:border-white/10 rounded-lg overflow-hidden">
                    <button type="button" onclick="toggleCollapsible('subtitle_match_section')" class="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                        <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300">字幕匹配</h4>
                        <i id="subtitle_match_section_icon" class="fa-solid fa-chevron-right text-slate-400 dark:text-gray-500 transition-transform duration-300"></i>
                    </button>
                    <div id="subtitle_match_section" class="collapsible-content border-t border-slate-200 dark:border-white/10" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                        <div class="p-4">

                    <!-- 独立配置（选择 Pool 后禁用） -->
                    <div id="subtitle_match_standalone_config" class="grid grid-cols-1 gap-4 {{ 'opacity-50 pointer-events-none' if config.openai.subtitle_match.pool_name else '' }}">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API Base URL</label>
                            <input type="text" id="ai_subtitle_match_base_url" class="input-field" value="{{ config.get('openai.subtitle_match.base_url', 'https://api.openai.com/v1') }}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API Key</label>
                            <div class="relative">
                                <input type="password" id="ai_subtitle_match_api_key" class="input-field pr-8" value="{{ config.get('openai.subtitle_match.api_key', '') }}">
                                <button type="button" onclick="togglePassword('ai_subtitle_match_api_key')" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-white">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pool 选择 -->
                    <div class="mt-4">
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">使用 Key Pool</label>
                        <select id="subtitle_match_pool_select" class="input-field" onchange="onPoolSelect('subtitle_match')">
                            <option value="">-- 不使用 Pool (独立配置) --</option>
                            {% for pool in config.openai.key_pools %}
                            <option value="{{ pool.name }}" {{ 'selected' if config.openai.subtitle_match.pool_name == pool.name else '' }}>{{ pool.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">选择 Key Pool 后将使用该 Pool 的 Base URL 和 API Keys</p>
                    </div>

                    <!-- 任务特定配置（始终可用） -->
                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">模型 (Model)</label>
                            <input type="text" id="ai_subtitle_match_model" class="input-field" value="{{ config.get('openai.subtitle_match.model', 'gpt-4') }}">
                            <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">每个任务独立配置模型</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">Extra Body (JSON格式)</label>
                            <textarea id="ai_subtitle_match_extra_body" class="input-field min-h-[80px] font-mono text-xs" placeholder='例如启用思考模式: {"thinking": {"type": "enabled"}}'>{{ config.get('openai.subtitle_match.extra_body', '') }}</textarea>
                            <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">可选。额外的API参数，此设置独立于 Key Pool，始终使用本任务的配置。</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">字幕匹配重试次数</label>
                                <input type="number" id="ai_subtitle_match_retries" class="input-field" value="{{ config.get('openai.subtitle_match.retries', 3) }}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">API 超时时间 (秒)</label>
                                <input type="number" id="ai_subtitle_match_timeout" class="input-field" min="10" max="600" value="{{ config.get('openai.subtitle_match.timeout', 180) }}">
                                <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">推荐: 180 秒</p>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

                <!-- 独立 Key Pools -->
                <div class="border border-slate-200 dark:border-white/10 rounded-lg overflow-hidden">
                    <button type="button" onclick="toggleCollapsible('key_pools_section')" class="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                        <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300">Key Pools</h4>
                        <i id="key_pools_section_icon" class="fa-solid fa-chevron-right text-slate-400 dark:text-gray-500 transition-transform duration-300"></i>
                    </button>
                    <div id="key_pools_section" class="collapsible-content border-t border-slate-200 dark:border-white/10" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                        <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xs text-slate-400 dark:text-gray-500 flex-1 mr-4">创建独立的 Key Pool，可被多个任务共享使用。每个 Pool 包含 base_url 和多个 API Key，Model 在各任务中独立配置。</p>
                        <button type="button" onclick="addKeyPool()" class="px-3 py-1.5 text-xs rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-white/5 dark:hover:bg-white/10 text-slate-700 dark:text-gray-200 whitespace-nowrap">
                            <i class="fa-solid fa-plus mr-1"></i> 添加 Pool
                        </button>
                    </div>

                    <div id="key_pools_container" class="space-y-4">
                        {% for pool in config.openai.key_pools %}
                        <div class="key-pool-card border border-slate-300 dark:border-white/20 rounded-lg p-4 bg-slate-50 dark:bg-white/5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-layer-group text-blue-500"></i>
                                    <input type="text" class="pool-name-input input-field w-48" value="{{ pool.name }}" placeholder="Pool 名称">
                                </div>
                                <button type="button" onclick="removeKeyPool(this)" class="text-slate-400 hover:text-red-500" title="删除 Pool">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>

                            <div class="mb-4">
                                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">Base URL</label>
                                <input type="text" class="pool-base-url input-field" value="{{ pool.base_url }}">
                            </div>

                            <!-- Pool 内的 API Keys -->
                            <div class="border-t border-slate-200 dark:border-white/10 pt-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-medium text-slate-600 dark:text-gray-300">API Keys</span>
                                    <button type="button" onclick="addKeyToPool(this)" class="text-xs text-blue-500 hover:text-blue-600">
                                        <i class="fa-solid fa-plus mr-1"></i> 添加 Key
                                    </button>
                                </div>
                                <div class="pool-keys-list space-y-2">
                                    {% for key in pool.api_keys %}
                                    <div class="pool-key-item grid grid-cols-12 gap-2 items-center">
                                        <input type="text" class="pool-key-name input-field col-span-3 text-sm" value="{{ key.name }}" placeholder="名称">
                                        <input type="password" class="pool-key-value input-field col-span-4 text-sm" value="{{ key.api_key }}" placeholder="API Key">
                                        <input type="number" class="pool-key-rpm input-field col-span-2 text-sm" value="{{ key.rpm }}" placeholder="RPM">
                                        <input type="number" class="pool-key-rpd input-field col-span-2 text-sm" value="{{ key.rpd }}" placeholder="RPD">
                                        <div class="col-span-1 flex items-center gap-1">
                                            <input type="checkbox" class="pool-key-enabled" {{ 'checked' if key.enabled else '' }}>
                                            <button type="button" onclick="removeKeyFromPool(this)" class="text-slate-400 hover:text-red-500">
                                                <i class="fa-solid fa-times text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                        </div>
                    </div>
                </div>

                <!-- 语言优先级设置 -->
                <div class="border border-slate-200 dark:border-white/10 rounded-lg overflow-hidden">
                    <button type="button" onclick="toggleCollapsible('language_priority_section')" class="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                        <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300">标题语言优先级</h4>
                        <i id="language_priority_section_icon" class="fa-solid fa-chevron-right text-slate-400 dark:text-gray-500 transition-transform duration-300"></i>
                    </button>
                    <div id="language_priority_section" class="collapsible-content border-t border-slate-200 dark:border-white/10" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                        <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-xs text-slate-400 dark:text-gray-500 flex-1 mr-4">拖动调整语言优先级顺序，AI 将优先使用排在前面的语言作为动漫标题。如果第一优先级不存在，则依次尝试下一优先级。</p>
                        <button type="button" onclick="showAddLanguageForm()" class="px-3 py-1.5 text-xs rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-white/5 dark:hover:bg-white/10 text-slate-700 dark:text-gray-200 whitespace-nowrap">
                            <i class="fa-solid fa-plus mr-1"></i> 添加语言
                        </button>
                    </div>

                    <!-- 添加语言表单（默认隐藏） -->
                    <div id="add_language_form" class="hidden mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-500/30">
                        <div class="mb-3">
                            <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">语言名称</label>
                            <input type="text" id="new_lang_name" class="input-field text-sm" placeholder="如: 中文, English, 日本語, Romaji">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="hideAddLanguageForm()" class="px-3 py-1.5 text-xs rounded-lg bg-slate-200 hover:bg-slate-300 dark:bg-white/10 dark:hover:bg-white/20 text-slate-700 dark:text-gray-200">
                                取消
                            </button>
                            <button type="button" onclick="addLanguage()" class="px-3 py-1.5 text-xs rounded-lg bg-blue-500 hover:bg-blue-600 text-white">
                                添加
                            </button>
                        </div>
                    </div>

                    <div id="language_priority_list" class="space-y-2">
                        {% for lang in config.openai.language_priorities %}
                        <div class="language-priority-item flex items-center gap-3 p-3 bg-slate-50 dark:bg-white/5 rounded-lg cursor-move border border-transparent hover:border-blue-300 dark:hover:border-blue-500 transition-all"
                             draggable="true"
                             data-name="{{ lang.name }}">
                            <div class="drag-handle text-slate-400 dark:text-gray-500">
                                <i class="fa-solid fa-grip-vertical"></i>
                            </div>
                            <div class="flex-1">
                                <span class="language-name text-sm text-slate-700 dark:text-gray-300">{{ lang.name }}</span>
                            </div>
                            <button type="button" onclick="removeLanguage(this)" class="text-slate-400 hover:text-red-500 transition-colors" title="删除">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="text-xs text-slate-400 dark:text-gray-500 mt-3">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        当前优先级：<span id="current_priority_display" class="font-medium text-slate-600 dark:text-gray-300"></span>
                    </p>
                </div>
                </div>
                </div>
            </div>
        </section>

        <!-- 3. 下载器 -->
        <section id="section-downloader" class="glass-card rounded-xl p-6 scroll-mt-24">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-white/5 pb-4">
                <div class="p-2 bg-green-100 dark:bg-green-500/10 rounded-lg text-green-600 dark:text-neon-green"><i class="fa-solid fa-download"></i></div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">qBittorrent 设置</h2>
            </div>
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">服务器地址 (URL)</label>
                    <input type="text" id="qb_url" class="input-field" value="{{ config.qbittorrent.url }}">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">用户名</label>
                        <input type="text" id="qb_username" class="input-field" value="{{ config.qbittorrent.username }}">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">密码</label>
                        <div class="relative">
                            <input type="password" id="qb_password" class="input-field pr-8" value="{{ config.qbittorrent.password }}">
                            <button onclick="togglePassword('qb_password')" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600 dark:text-gray-500 dark:hover:text-white">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">基础下载路径</label>
                    <input type="text" id="qb_path" class="input-field" value="{{ config.qbittorrent.base_download_path }}">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">动漫文件夹名称</label>
                        <input type="text" id="qb_anime_folder" class="input-field" value="{{ config.qbittorrent.anime_folder_name }}">
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">在基础路径下创建的动漫根文件夹</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">真人文件夹名称</label>
                        <input type="text" id="qb_liveaction_folder" class="input-field" value="{{ config.qbittorrent.live_action_folder_name }}">
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">在基础路径下创建的真人根文件夹</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">剧集(TV)文件夹名称</label>
                        <input type="text" id="qb_tv_folder" class="input-field" value="{{ config.qbittorrent.tv_folder_name }}">
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">在动漫/真人文件夹下的TV剧集文件夹</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">电影(Movie)文件夹名称</label>
                        <input type="text" id="qb_movie_folder" class="input-field" value="{{ config.qbittorrent.movie_folder_name }}">
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">在动漫/真人文件夹下的电影文件夹</p>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">分类 (Category)</label>
                    <input type="text" id="qb_category" class="input-field" value="{{ config.qbittorrent.category }}">
                </div>
            </div>
        </section>

        <!-- 4. 通知 -->
        <section id="section-notification" class="glass-card rounded-xl p-6 scroll-mt-24">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-white/5 pb-4">
                <div class="p-2 bg-indigo-100 dark:bg-indigo-500/10 rounded-lg text-indigo-600 dark:text-indigo-400"><i class="fa-brands fa-discord"></i></div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">Discord 通知</h2>
                <div class="ml-auto">
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" name="discord_enabled" id="discord_enabled" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer top-0.5 left-0.5" {{ 'checked' if config.discord.enabled else '' }}/>
                        <label for="discord_enabled" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-gray-700 cursor-pointer"></label>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-6 {{ 'opacity-50 pointer-events-none' if not config.discord.enabled else '' }} transition-all duration-300" id="discord_settings">
                <div>
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">RSS 通知 Webhook</label>
                    <input type="text" id="discord_rss" class="input-field" placeholder="https://discord.com/api/webhooks/..." value="{{ config.discord.rss_webhook_url }}">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">硬链接通知 Webhook</label>
                    <input type="text" id="discord_hardlink" class="input-field" placeholder="https://discord.com/api/webhooks/..." value="{{ config.discord.hardlink_webhook_url }}">
                </div>
            </div>
        </section>

        <!-- 5. 文件与路径管理 -->
        <section id="section-file" class="glass-card rounded-xl p-6 scroll-mt-24">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-white/5 pb-4">
                <div class="p-2 bg-orange-100 dark:bg-orange-500/10 rounded-lg text-orange-600 dark:text-orange-400"><i class="fa-solid fa-folder-tree"></i></div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">文件路径与整理</h2>
            </div>
            
            <!-- Path Conversion -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300">路径转换 (Docker/Local)</h4>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" id="path_conv_enabled" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer top-0.5 left-0.5" {{ 'checked' if config.get('path_conversion.enabled', False) else '' }}/>
                        <label for="path_conv_enabled" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-gray-700 cursor-pointer"></label>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 {{ 'opacity-50 pointer-events-none' if not config.get('path_conversion.enabled', False) else '' }} transition-all duration-300" id="path_conv_fields">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">源基础路径</label>
                        <input type="text" id="path_conv_src" class="input-field" value="{{ config.get('path_conversion.source_base_path', '/downloads/AniDown/') }}">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">目标基础路径</label>
                        <input type="text" id="path_conv_target" class="input-field" value="{{ config.get('path_conversion.target_base_path', '/path/to/target/') }}">
                    </div>
                </div>
            </div>

            <!-- Target Paths -->
            <div class="grid grid-cols-1 gap-6 mb-6 border-t border-slate-200 dark:border-white/5 pt-6">
                <div>
                    <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300 mb-3">动漫硬链接路径</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">剧集(TV) 硬链接目标路径</label>
                            <input type="text" id="link_target_tv" class="input-field" value="{{ config.link_target_path }}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">电影(Movie) 硬链接目标路径</label>
                            <input type="text" id="link_target_movie" class="input-field" value="{{ config.movie_link_target_path }}">
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-slate-700 dark:text-gray-300 mb-3">真人硬链接路径</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">剧集(TV) 硬链接目标路径</label>
                            <input type="text" id="live_action_link_target_tv" class="input-field" value="{{ config.live_action_tv_target_path }}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">电影(Movie) 硬链接目标路径</label>
                            <input type="text" id="live_action_link_target_movie" class="input-field" value="{{ config.live_action_movie_target_path }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Naming & TVDB -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-slate-200 dark:border-white/5 pt-6">
                <div>
                    <label class="flex items-center gap-2 cursor-pointer mb-3">
                        <input type="checkbox" id="naming_tv" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700" {{ 'checked' if config.get('use_consistent_naming_tv', False) else '' }}>
                        <span class="text-sm text-slate-700 dark:text-gray-300">启用剧集统一命名</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="naming_movie" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700" {{ 'checked' if config.get('use_consistent_naming_movie', False) else '' }}>
                        <span class="text-sm text-slate-700 dark:text-gray-300">启用电影统一命名</span>
                    </label>
                </div>
                <div>
                    <div class="mb-2">
                        <span class="text-sm text-slate-700 dark:text-gray-300">TVDB API Key</span>
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">在手动上传时可选择是否使用 TVDB 刮削</p>
                    </div>
                    <input type="text" id="tvdb_key" class="input-field" placeholder="TVDB API Key" value="{{ config.tvdb.api_key }}">
                </div>
            </div>
        </section>

        <!-- 6. 端口设置 -->
        <section id="section-basic" class="glass-card rounded-xl p-6 scroll-mt-24">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-white/5 pb-4">
                <div class="p-2 bg-blue-100 dark:bg-blue-500/10 rounded-lg text-blue-600 dark:text-neon-blue"><i class="fa-solid fa-sliders"></i></div>
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">端口设置</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- WebUI -->
                <div class="col-span-full md:col-span-1">
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">WebUI 端口</label>
                    <input type="number" id="webui_port" class="input-field" value="{{ config.get('webui.port', 8081) }}">
                </div>

                <!-- Webhook -->
                <div class="col-span-full md:col-span-1">
                    <label class="block text-xs font-medium text-slate-500 dark:text-gray-400 mb-2">Webhook 端口</label>
                    <input type="number" id="webhook_port" class="input-field" value="{{ config.webhook.port }}">
                </div>
            </div>
        </section>

    </div>
</div>

<!-- 左下角工具按钮 -->
<div class="fixed bottom-6 left-6 z-50 flex items-center gap-2">
    <!-- 恢复默认配置按钮 -->
    <button id="reset_config_btn" onclick="resetConfigToDefault()" class="flex items-center justify-center w-10 h-10 bg-slate-600 hover:bg-slate-500 text-white rounded-full shadow-lg hover:shadow-slate-500/30 transition-all disabled:opacity-70 disabled:cursor-not-allowed" title="恢复默认配置（需点击保存才会生效）">
        <i id="reset_btn_icon" class="fa-solid fa-arrow-rotate-left"></i>
    </button>
    <!-- 重新加载配置按钮 -->
    <button id="reload_config_btn" onclick="reloadConfigFromFile()" class="flex items-center justify-center w-10 h-10 bg-slate-600 hover:bg-slate-500 text-white rounded-full shadow-lg hover:shadow-slate-500/30 transition-all disabled:opacity-70 disabled:cursor-not-allowed" title="从 config.json 重新加载配置">
        <i id="reload_btn_icon" class="fa-solid fa-rotate"></i>
    </button>
</div>

<!-- 右下角保存按钮 -->
<div class="fixed bottom-6 right-6 z-50">
    <button id="save_config_btn" onclick="saveConfig()" class="group relative flex items-center gap-3 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-full shadow-lg hover:shadow-blue-500/30 transition-all disabled:opacity-70 disabled:cursor-not-allowed disabled:hover:bg-blue-600">
        <i id="save_btn_icon" class="fa-solid fa-floppy-disk"></i>
        <span id="save_btn_text">保存配置</span>
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Flash Message Function (copied from other pages)
    function showFlashMessage(category, message) {
        // 创建flash消息容器
        let flashContainer = document.getElementById('flash-messages');
        if (!flashContainer) {
            flashContainer = document.createElement('div');
            flashContainer.id = 'flash-messages';
            flashContainer.className = 'position-fixed top-0 end-0 p-3';
            flashContainer.style.zIndex = '1050';
            flashContainer.style.position = 'fixed';
            flashContainer.style.top = '80px';
            flashContainer.style.right = '16px';
            flashContainer.style.zIndex = '50';
            document.body.appendChild(flashContainer);
        }

        // 创建消息元素
        const messageDiv = document.createElement('div');
        messageDiv.className = `glass-static rounded-lg p-4 border-l-4 max-w-sm mb-2 ${
            category === 'success' ? 'border-green-500 bg-green-50 dark:bg-green-900/20' :
            category === 'error' ? 'border-red-500 bg-red-50 dark:bg-red-900/20' :
            'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20'
        }`;
        
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    category === 'success' ? 'fa-check-circle text-green-500' :
                    category === 'error' ? 'fa-exclamation-circle text-red-500' :
                    'fa-exclamation-triangle text-yellow-500'
                } mr-2"></i>
                <span class="text-sm font-medium ${
                    category === 'success' ? 'text-green-800 dark:text-green-200' :
                    category === 'error' ? 'text-red-800 dark:text-red-200' :
                    'text-yellow-800 dark:text-yellow-200'
                }">${message}</span>
            </div>
        `;

        flashContainer.appendChild(messageDiv);

        // 5秒后自动隐藏
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                messageDiv.style.transition = 'all 0.3s ease';
                setTimeout(() => messageDiv.remove(), 300);
            }
        }, 5000);
    }

    // 将 showFlashMessage 暴露为全局函数
    window.showFlashMessage = showFlashMessage;

    // 1. 加载数据逻辑
    async function loadConfig() {
        try {
            // 数据已通过 Flask 模板变量传递，无需额外加载
            console.log("配置页面已加载");
        } catch (error) {
            console.error("Load Config Error:", error);
        }
    }

    // 2. 辅助功能

    // 折叠/展开功能
    function toggleCollapsible(sectionId) {
        const content = document.getElementById(sectionId);
        const icon = document.getElementById(sectionId + '_icon');

        if (!content || !icon) return;

        const isExpanded = content.style.maxHeight && content.style.maxHeight !== '0px';

        if (isExpanded) {
            // 收起
            content.style.maxHeight = '0px';
            icon.style.transform = 'rotate(0deg)';
        } else {
            // 展开 - 设置为内容的实际高度
            content.style.maxHeight = content.scrollHeight + 'px';
            icon.style.transform = 'rotate(90deg)';
        }
    }

    // 更新已展开的折叠区域高度（用于动态内容变化）
    function updateCollapsibleHeight(sectionId) {
        const content = document.getElementById(sectionId);
        if (!content) return;

        const isExpanded = content.style.maxHeight && content.style.maxHeight !== '0px';
        if (isExpanded) {
            // 需要延迟一下让 DOM 更新
            setTimeout(() => {
                content.style.maxHeight = content.scrollHeight + 'px';
            }, 10);
        }
    }

    function addRssField(url = '', keywords = '', regex = '', media_type = 'anime') {
        const div = document.createElement('div');
        div.className = 'rss-feed-item border border-slate-200 dark:border-white/10 rounded-lg p-4';
        div.innerHTML = `
            <div class="flex items-start gap-2">
                <div class="flex-1">
                    <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">RSS URL</label>
                    <input type="text" class="input-field rss-url-input" placeholder="https://..." value="${url}">
                </div>
                <div class="w-32">
                    <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">类型</label>
                    <select class="input-field rss-media-type-select">
                        <option value="anime" ${media_type === 'anime' ? 'selected' : ''}>动漫</option>
                        <option value="live_action" ${media_type === 'live_action' ? 'selected' : ''}>真人</option>
                    </select>
                </div>
                <button onclick="toggleRssFilters(this)" class="mt-6 px-3 py-2 text-slate-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors" title="展开过滤设置">
                    <i class="fa-solid fa-filter"></i>
                </button>
                <button onclick="removeRssFeed(this)" class="mt-6 px-3 py-2 text-slate-400 hover:text-red-500 transition-colors" title="删除">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <div class="rss-filters mt-4 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">屏蔽词 (每行一个)</label>
                        <textarea class="input-field rss-keywords-input min-h-[100px]" placeholder="例如：简体&#10;1080p">${keywords}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">正则表达式 (每行一个)</label>
                        <textarea class="input-field rss-regex-input min-h-[100px]" placeholder="例如：.*\\[1080p\\].*">${regex}</textarea>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('rss_list').appendChild(div);
    }

    function toggleRssFilters(button) {
        const feedItem = button.closest('.rss-feed-item');
        const filtersDiv = feedItem.querySelector('.rss-filters');
        filtersDiv.classList.toggle('hidden');

        // 切换图标
        const icon = button.querySelector('i');
        if (filtersDiv.classList.contains('hidden')) {
            icon.className = 'fa-solid fa-filter';
            button.classList.remove('text-blue-500', 'dark:text-blue-400');
            button.classList.add('text-slate-600', 'dark:text-gray-400');
        } else {
            icon.className = 'fa-solid fa-filter-circle-xmark';
            button.classList.add('text-blue-500', 'dark:text-blue-400');
            button.classList.remove('text-slate-600', 'dark:text-gray-400');
        }
    }

    function removeRssFeed(button) {
        const feedItem = button.closest('.rss-feed-item');
        feedItem.remove();
    }

    function togglePassword(id) {
        const input = document.getElementById(id);
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    // ========== 独立 Key Pool 管理 ==========

    // 添加新的 Key Pool
    function addKeyPool() {
        const container = document.getElementById('key_pools_container');
        const div = document.createElement('div');
        div.className = 'key-pool-card border border-slate-300 dark:border-white/20 rounded-lg p-4 bg-slate-50 dark:bg-white/5';
        div.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-layer-group text-blue-500"></i>
                    <input type="text" class="pool-name-input input-field w-48" value="" placeholder="Pool 名称">
                </div>
                <button type="button" onclick="removeKeyPool(this)" class="text-slate-400 hover:text-red-500" title="删除 Pool">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-xs text-slate-500 dark:text-gray-400 mb-1">Base URL</label>
                <input type="text" class="pool-base-url input-field" value="https://api.openai.com/v1">
            </div>

            <div class="border-t border-slate-200 dark:border-white/10 pt-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-slate-600 dark:text-gray-300">API Keys</span>
                    <button type="button" onclick="addKeyToPool(this)" class="text-xs text-blue-500 hover:text-blue-600">
                        <i class="fa-solid fa-plus mr-1"></i> 添加 Key
                    </button>
                </div>
                <div class="pool-keys-list space-y-2">
                </div>
            </div>
        `;
        container.appendChild(div);

        // 绑定 Pool 名称变化事件以更新下拉框
        div.querySelector('.pool-name-input').addEventListener('input', updatePoolDropdowns);

        // 更新折叠区域高度
        updateCollapsibleHeight('key_pools_section');
    }

    // 删除 Key Pool
    function removeKeyPool(button) {
        const card = button.closest('.key-pool-card');
        if (card) {
            card.remove();
            updatePoolDropdowns();
            // 更新折叠区域高度
            updateCollapsibleHeight('key_pools_section');
        }
    }

    // 向 Pool 添加 Key
    function addKeyToPool(button) {
        const card = button.closest('.key-pool-card');
        const keysList = card.querySelector('.pool-keys-list');
        const div = document.createElement('div');
        div.className = 'pool-key-item grid grid-cols-12 gap-2 items-center';
        div.innerHTML = `
            <input type="text" class="pool-key-name input-field col-span-3 text-sm" value="" placeholder="名称">
            <input type="password" class="pool-key-value input-field col-span-4 text-sm" value="" placeholder="API Key">
            <input type="number" class="pool-key-rpm input-field col-span-2 text-sm" value="0" placeholder="RPM">
            <input type="number" class="pool-key-rpd input-field col-span-2 text-sm" value="0" placeholder="RPD">
            <div class="col-span-1 flex items-center gap-1">
                <input type="checkbox" class="pool-key-enabled" checked>
                <button type="button" onclick="removeKeyFromPool(this)" class="text-slate-400 hover:text-red-500">
                    <i class="fa-solid fa-times text-xs"></i>
                </button>
            </div>
        `;
        keysList.appendChild(div);
        // 更新折叠区域高度
        updateCollapsibleHeight('key_pools_section');
    }

    // 从 Pool 删除 Key
    function removeKeyFromPool(button) {
        const item = button.closest('.pool-key-item');
        if (item) {
            item.remove();
            // 更新折叠区域高度
            updateCollapsibleHeight('key_pools_section');
        }
    }

    // 收集所有 Key Pools 数据
    function collectKeyPools() {
        const pools = [];
        document.querySelectorAll('.key-pool-card').forEach(card => {
            const name = (card.querySelector('.pool-name-input')?.value || '').trim();
            if (!name) return; // 跳过没有名称的 Pool

            const base_url = (card.querySelector('.pool-base-url')?.value || '').trim();

            const api_keys = [];
            card.querySelectorAll('.pool-key-item').forEach(keyItem => {
                const api_key = (keyItem.querySelector('.pool-key-value')?.value || '').trim();
                if (!api_key) return; // 跳过空 Key

                api_keys.push({
                    name: (keyItem.querySelector('.pool-key-name')?.value || '').trim(),
                    api_key: api_key,
                    rpm: parseInt(keyItem.querySelector('.pool-key-rpm')?.value || '0', 10) || 0,
                    rpd: parseInt(keyItem.querySelector('.pool-key-rpd')?.value || '0', 10) || 0,
                    enabled: !!keyItem.querySelector('.pool-key-enabled')?.checked
                });
            });

            pools.push({ name, base_url, api_keys });
        });
        return pools;
    }

    // 更新所有任务的 Pool 下拉框选项
    function updatePoolDropdowns() {
        const pools = collectKeyPools();
        const dropdowns = ['title_parse_pool_select', 'multi_file_rename_pool_select', 'subtitle_match_pool_select'];

        dropdowns.forEach(dropdownId => {
            const select = document.getElementById(dropdownId);
            if (!select) return;

            const currentValue = select.value;
            // 保留第一个选项（不使用 Pool）
            select.innerHTML = '<option value="">-- 不使用 Pool (独立配置) --</option>';

            pools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool.name;
                option.textContent = pool.name;
                if (pool.name === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });
    }

    // Pool 选择变化时禁用/启用独立配置
    function onPoolSelect(purpose) {
        const select = document.getElementById(`${purpose}_pool_select`);
        const standaloneConfig = document.getElementById(`${purpose}_standalone_config`);

        if (!select || !standaloneConfig) return;

        if (select.value) {
            // 选择了 Pool，禁用独立配置
            standaloneConfig.classList.add('opacity-50', 'pointer-events-none');
        } else {
            // 未选择 Pool，启用独立配置
            standaloneConfig.classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    // 3. 联动逻辑
    document.getElementById('discord_enabled').addEventListener('change', (e) => toggleDiscordInputs(e.target.checked));
    function toggleDiscordInputs(enabled) {
        const div = document.getElementById('discord_settings');
        if(enabled) {
            div.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            div.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    document.getElementById('path_conv_enabled').addEventListener('change', (e) => togglePathConv(e.target.checked));
    function togglePathConv(enabled) {
        const div = document.getElementById('path_conv_fields');
        if(enabled) {
            div.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            div.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    // 3.5 侧边栏导航高亮
    document.addEventListener('DOMContentLoaded', () => {
        const navLinks = document.querySelectorAll('aside nav a');

        function setActive(id) {
            navLinks.forEach(link => {
                const active = link.getAttribute('href') === `#${id}`;
                link.classList.toggle('bg-slate-200', active);
                link.classList.toggle('dark:bg-white/10', active);
                link.classList.toggle('text-slate-700', active);
                link.classList.toggle('dark:text-white', active);
                // 非激活状态样式
                link.classList.toggle('text-slate-500', !active);
                link.classList.toggle('dark:text-gray-400', !active);
            });
        }

        // 点击导航时切换
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                const id = link.getAttribute('href').substring(1);
                setActive(id);
            });
        });

        // 滚动时根据 section 可见性更新
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    setActive(entry.target.id);
                }
            });
        }, {
            rootMargin: '-50% 0px -50% 0px',
            threshold: 0
        });

        document.querySelectorAll('section[id]').forEach(sec => observer.observe(sec));

        // 滚动到页面底部时，激活最后一个导航项
        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;

            // 检查是否滚动到底部（允许 5px 的误差）
            if (scrollTop + clientHeight >= scrollHeight - 5) {
                setActive('section-basic');
            }
        });
    });

    // 4. 保存逻辑

    // 更新保存按钮状态
    function updateSaveButton(state, text) {
        const btn = document.getElementById('save_config_btn');
        const icon = document.getElementById('save_btn_icon');
        const textSpan = document.getElementById('save_btn_text');

        if (!btn || !icon || !textSpan) return;

        switch (state) {
            case 'saving':
                btn.disabled = true;
                icon.className = 'fa-solid fa-spinner fa-spin';
                textSpan.textContent = text || '保存配置中...';
                break;
            case 'reloading':
                btn.disabled = true;
                icon.className = 'fa-solid fa-rotate fa-spin';
                textSpan.textContent = text || '重载配置中...';
                break;
            case 'success':
                btn.disabled = false;
                icon.className = 'fa-solid fa-check';
                textSpan.textContent = text || '保存成功';
                // 2秒后恢复默认状态
                setTimeout(() => updateSaveButton('default'), 2000);
                break;
            case 'error':
                btn.disabled = false;
                icon.className = 'fa-solid fa-xmark';
                textSpan.textContent = text || '保存失败';
                // 3秒后恢复默认状态
                setTimeout(() => updateSaveButton('default'), 3000);
                break;
            case 'default':
            default:
                btn.disabled = false;
                icon.className = 'fa-solid fa-floppy-disk';
                textSpan.textContent = '保存配置';
                break;
        }
    }

    // 重新加载配置
    async function reloadConfigFromFile() {
        const btn = document.getElementById('reload_config_btn');
        const icon = document.getElementById('reload_btn_icon');

        // 显示加载状态
        btn.disabled = true;
        icon.className = 'fa-solid fa-spinner fa-spin';

        try {
            const response = await fetch('/config/reload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                icon.className = 'fa-solid fa-check';
                showFlashMessage('success', data.message || '配置已从文件重新加载');
                // 刷新页面以显示新配置
                setTimeout(() => window.location.reload(), 1500);
            } else {
                icon.className = 'fa-solid fa-xmark';
                showFlashMessage('error', data.message || '重新加载配置失败');
                setTimeout(() => {
                    btn.disabled = false;
                    icon.className = 'fa-solid fa-rotate';
                }, 2000);
            }
        } catch (error) {
            console.error('重新加载配置时出错:', error);
            icon.className = 'fa-solid fa-xmark';
            showFlashMessage('error', '重新加载配置时出错: ' + error.message);
            setTimeout(() => {
                btn.disabled = false;
                icon.className = 'fa-solid fa-rotate';
            }, 2000);
        }
    }

    // 恢复默认配置（从后端获取默认值，只修改前端表单，不保存）
    async function resetConfigToDefault() {
        const btn = document.getElementById('reset_config_btn');
        const icon = document.getElementById('reset_btn_icon');

        // 显示加载状态
        btn.disabled = true;
        icon.className = 'fa-solid fa-spinner fa-spin';

        try {
            // 从后端获取默认配置
            const response = await fetch('/config/defaults');
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message || '获取默认配置失败');
            }

            const defaults = result.data;

            // 字段映射：后端 key -> 前端 ID
            const fieldMappings = {
                'rss_interval': 'rss_interval',
                'qb_url': 'qb_url',
                'qb_username': 'qb_username',
                'qb_password': 'qb_password',
                'qb_path': 'qb_path',
                'qb_category': 'qb_category',
                'qb_anime_folder': 'qb_anime_folder',
                'qb_liveaction_folder': 'qb_liveaction_folder',
                'qb_tv_folder': 'qb_tv_folder',
                'qb_movie_folder': 'qb_movie_folder',
                'discord_rss_webhook': 'discord_rss',
                'discord_hardlink_webhook': 'discord_hardlink',
                'ai_title_parse_base_url': 'ai_title_parse_base_url',
                'ai_title_parse_api_key': 'ai_title_parse_api_key',
                'ai_title_parse_model': 'ai_title_parse_model',
                'ai_title_parse_timeout': 'ai_title_parse_timeout',
                'ai_title_parse_retries': 'ai_title_parse_retries',
                'ai_title_parse_extra_body': 'ai_title_parse_extra_body',
                'ai_multi_rename_base_url': 'ai_multi_rename_base_url',
                'ai_multi_rename_api_key': 'ai_multi_rename_api_key',
                'ai_multi_rename_model': 'ai_multi_rename_model',
                'ai_multi_rename_timeout': 'ai_multi_rename_timeout',
                'ai_multi_rename_extra_body': 'ai_multi_rename_extra_body',
                'ai_max_batch_size': 'ai_max_batch_size',
                'ai_batch_processing_retries': 'ai_batch_processing_retries',
                'ai_subtitle_match_base_url': 'ai_subtitle_match_base_url',
                'ai_subtitle_match_api_key': 'ai_subtitle_match_api_key',
                'ai_subtitle_match_model': 'ai_subtitle_match_model',
                'ai_subtitle_match_timeout': 'ai_subtitle_match_timeout',
                'ai_subtitle_match_retries': 'ai_subtitle_match_retries',
                'ai_subtitle_match_extra_body': 'ai_subtitle_match_extra_body',
                'link_target_path': 'link_target_path',
                'movie_link_target_path': 'movie_link_target_path',
                'live_action_tv_target_path': 'live_action_tv_target_path',
                'live_action_movie_target_path': 'live_action_movie_target_path',
                'path_conversion_source_base': 'path_conversion_source_base',
                'path_conversion_target_base': 'path_conversion_target_base',
                'webui_port': 'webui_port',
                'webhook_port': 'webhook_port',
                'tvdb_api_key': 'tvdb_api_key'
            };

            // 设置文本/数字输入框
            Object.entries(fieldMappings).forEach(([defaultKey, fieldId]) => {
                const el = document.getElementById(fieldId);
                if (el && defaults[defaultKey] !== undefined) {
                    el.value = defaults[defaultKey];
                }
            });

            // 设置复选框
            const checkboxMappings = {
                'discord_enabled': 'discord_enabled',
                'use_consistent_naming_tv': 'use_consistent_naming_tv',
                'use_consistent_naming_movie': 'use_consistent_naming_movie',
                'path_conversion_enabled': 'path_conversion_enabled'
            };

            Object.entries(checkboxMappings).forEach(([defaultKey, fieldId]) => {
                const el = document.getElementById(fieldId);
                if (el) {
                    el.checked = defaults[defaultKey] || false;
                }
            });

            // 设置下拉框（Pool 选择）
            const poolSelects = {
                'title_parse_pool_select': 'title_parse_pool_name',
                'multi_file_rename_pool_select': 'multi_file_rename_pool_name',
                'subtitle_match_pool_select': 'subtitle_match_pool_name'
            };

            Object.entries(poolSelects).forEach(([selectId, defaultKey]) => {
                const el = document.getElementById(selectId);
                if (el) {
                    el.value = defaults[defaultKey] || '';
                    // 触发 onchange 事件以更新独立配置区域的状态
                    el.dispatchEvent(new Event('change'));
                }
            });

            // 清空 RSS feeds（只保留一个空的）
            const rssList = document.getElementById('rss_list');
            if (rssList) {
                rssList.innerHTML = '';
                addRssField(); // 添加一个空的 RSS 输入框
            }

            // 清空 Key Pools
            const keyPoolsList = document.getElementById('key_pools_list');
            if (keyPoolsList) {
                keyPoolsList.innerHTML = '';
            }

            // 重置语言优先级为默认值
            const defaultLanguages = defaults.language_priorities || ['中文', 'English', '日本語', 'Romaji'];
            const languageList = document.getElementById('language_priority_list');
            if (languageList) {
                languageList.innerHTML = '';
                defaultLanguages.forEach(lang => {
                    const item = document.createElement('div');
                    item.className = 'language-priority-item flex items-center gap-2 p-2 bg-slate-100 dark:bg-white/5 rounded-lg cursor-move';
                    item.draggable = true;
                    item.innerHTML = `
                        <i class="fa-solid fa-grip-vertical text-slate-400 dark:text-gray-500"></i>
                        <span class="flex-1 text-sm text-slate-700 dark:text-gray-300">${lang}</span>
                        <button type="button" onclick="removeLanguagePriority(this)" class="text-slate-400 hover:text-red-500 transition-colors">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;
                    languageList.appendChild(item);
                });
                // 重新初始化拖拽
                if (typeof initLanguagePriorityDrag === 'function') {
                    initLanguagePriorityDrag();
                }
            }

            // 显示成功状态
            icon.className = 'fa-solid fa-check';
            showFlashMessage('success', '已恢复默认配置，点击保存按钮后生效');

            setTimeout(() => {
                btn.disabled = false;
                icon.className = 'fa-solid fa-arrow-rotate-left';
            }, 1500);

        } catch (error) {
            console.error('恢复默认配置时出错:', error);
            icon.className = 'fa-solid fa-xmark';
            showFlashMessage('error', '恢复默认配置时出错: ' + error.message);

            setTimeout(() => {
                btn.disabled = false;
                icon.className = 'fa-solid fa-arrow-rotate-left';
            }, 2000);
        }
    }

    async function saveConfig() {
        // 更新按钮状态为保存中
        updateSaveButton('saving', '保存配置中...');

        const formData = new FormData();

        // RSS 配置 - 收集新的结构
        const rssFeeds = [];
        document.querySelectorAll('.rss-feed-item').forEach(item => {
            const url = item.querySelector('.rss-url-input').value.trim();
            if (url) {
                const keywords = item.querySelector('.rss-keywords-input').value.trim();
                const regex = item.querySelector('.rss-regex-input').value.trim();
                const media_type = item.querySelector('.rss-media-type-select').value;
                rssFeeds.push({
                    url: url,
                    blocked_keywords: keywords,
                    blocked_regex: regex,
                    media_type: media_type
                });
            }
        });
        formData.append('rss_feeds', JSON.stringify(rssFeeds));
        formData.append('rss_interval', document.getElementById('rss_interval').value);

        // qBittorrent 配置
        formData.append('qb_url', document.getElementById('qb_url').value);
        formData.append('qb_username', document.getElementById('qb_username').value);
        formData.append('qb_password', document.getElementById('qb_password').value);
        formData.append('qb_download_path', document.getElementById('qb_path').value);
        formData.append('qb_anime_folder', document.getElementById('qb_anime_folder').value);
        formData.append('qb_liveaction_folder', document.getElementById('qb_liveaction_folder').value);
        formData.append('qb_tv_folder', document.getElementById('qb_tv_folder').value);
        formData.append('qb_movie_folder', document.getElementById('qb_movie_folder').value);
        formData.append('qb_category', document.getElementById('qb_category').value);

        // Discord 配置
        if (document.getElementById('discord_enabled').checked) {
            formData.append('discord_enabled', 'on');
        }
        formData.append('discord_rss_webhook', document.getElementById('discord_rss').value);
        formData.append('discord_hardlink_webhook', document.getElementById('discord_hardlink').value);

        // 独立 Key Pools 配置
        formData.append('key_pools', JSON.stringify(collectKeyPools()));

        // 标题解析配置
        formData.append('title_parse_pool_name', document.getElementById('title_parse_pool_select').value);
        formData.append('openai_title_parse_key', document.getElementById('ai_title_parse_api_key').value);
        formData.append('openai_title_parse_model', document.getElementById('ai_title_parse_model').value);
        formData.append('openai_title_parse_base_url', document.getElementById('ai_title_parse_base_url').value);
        formData.append('openai_title_parse_retries', document.getElementById('ai_title_parse_retries').value);
        formData.append('openai_title_parse_timeout', document.getElementById('ai_title_parse_timeout').value);
        formData.append('openai_title_parse_extra_body', document.getElementById('ai_title_parse_extra_body').value);

        // 语言优先级配置
        formData.append('language_priorities', JSON.stringify(collectLanguagePriorities()));

        // 多文件重命名配置
        formData.append('multi_file_rename_pool_name', document.getElementById('multi_file_rename_pool_select').value);
        formData.append('openai_multi_rename_key', document.getElementById('ai_multi_rename_api_key').value);
        formData.append('openai_multi_rename_model', document.getElementById('ai_multi_rename_model').value);
        formData.append('openai_multi_rename_base_url', document.getElementById('ai_multi_rename_base_url').value);
        formData.append('openai_multi_rename_timeout', document.getElementById('ai_multi_rename_timeout').value);
        formData.append('openai_multi_rename_extra_body', document.getElementById('ai_multi_rename_extra_body').value);

        // 字幕匹配配置
        formData.append('subtitle_match_pool_name', document.getElementById('subtitle_match_pool_select').value);
        formData.append('openai_subtitle_match_key', document.getElementById('ai_subtitle_match_api_key').value);
        formData.append('openai_subtitle_match_model', document.getElementById('ai_subtitle_match_model').value);
        formData.append('openai_subtitle_match_base_url', document.getElementById('ai_subtitle_match_base_url').value);
        formData.append('openai_subtitle_match_retries', document.getElementById('ai_subtitle_match_retries').value);
        formData.append('openai_subtitle_match_timeout', document.getElementById('ai_subtitle_match_timeout').value);
        formData.append('openai_subtitle_match_extra_body', document.getElementById('ai_subtitle_match_extra_body').value);

        // AI 处理配置
        formData.append('ai_max_batch_size', document.getElementById('ai_batch_size').value);
        formData.append('ai_batch_processing_retries', document.getElementById('ai_batch_retries').value);

        // 路径配置
        formData.append('link_target_path', document.getElementById('link_target_tv').value);
        formData.append('movie_link_target_path', document.getElementById('link_target_movie').value);
        formData.append('live_action_tv_target_path', document.getElementById('live_action_link_target_tv').value);
        formData.append('live_action_movie_target_path', document.getElementById('live_action_link_target_movie').value);

        // 命名一致性配置
        if (document.getElementById('naming_tv').checked) {
            formData.append('use_consistent_naming_tv', 'on');
        }
        if (document.getElementById('naming_movie').checked) {
            formData.append('use_consistent_naming_movie', 'on');
        }

        // WebUI 配置
        formData.append('webui_port', document.getElementById('webui_port').value);

        // 路径转换配置
        if (document.getElementById('path_conv_enabled').checked) {
            formData.append('path_conversion_enabled', 'on');
        }
        formData.append('path_conversion_source_base', document.getElementById('path_conv_src').value);
        formData.append('path_conversion_target_base', document.getElementById('path_conv_target').value);

        // Webhook 配置
        formData.append('webhook_port', document.getElementById('webhook_port').value);

        // TVDB 配置 (只保存 API Key，启用开关已移至手动上传页面)
        formData.append('tvdb_api_key', document.getElementById('tvdb_key').value);

        try {
            // 更新状态为热重载中（服务器保存后会执行热重载）
            updateSaveButton('reloading', '重载配置中...');

            const response = await fetch('{{ url_for("config.update_config") }}', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    updateSaveButton('success', '保存成功');
                    showFlashMessage('success', data.message || '配置已保存成功');
                } else {
                    updateSaveButton('error', '保存失败');
                    showFlashMessage('error', data.message || '保存配置失败');
                }
            } else {
                // 嘗試解析錯誤響應
                try {
                    const errorData = await response.json();
                    updateSaveButton('error', '保存失败');
                    showFlashMessage('error', errorData.message || '保存配置失败');
                } catch {
                    updateSaveButton('error', '保存失败');
                    showFlashMessage('error', '保存配置失败');
                }
            }
        } catch (error) {
            console.error('保存配置时出错:', error);
            updateSaveButton('error', '保存失败');
            showFlashMessage('error', '保存配置时出错: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', loadConfig);
    document.addEventListener('DOMContentLoaded', () => {
        // 初始化语言优先级拖放功能
        initLanguagePriorityDrag();
        updatePriorityDisplay();

        // 绑定现有 Key Pool 名称变化事件
        document.querySelectorAll('.key-pool-card .pool-name-input').forEach(input => {
            input.addEventListener('input', updatePoolDropdowns);
        });

        // 初始化 Pool 下拉框选项
        updatePoolDropdowns();
    });

    // 语言优先级拖放功能
    function initLanguagePriorityDrag() {
        const list = document.getElementById('language_priority_list');
        if (!list) return;

        list.querySelectorAll('.language-priority-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                list.draggedItem = item;
                item.classList.add('opacity-50', 'border-blue-500');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('opacity-50', 'border-blue-500');
                list.draggedItem = null;
                updatePriorityDisplay();
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            item.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (item !== list.draggedItem) {
                    item.classList.add('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20');
                }
            });

            item.addEventListener('dragleave', () => {
                item.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20');
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                item.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20');

                const draggedItem = list.draggedItem;
                if (item !== draggedItem && draggedItem) {
                    const allItems = [...list.querySelectorAll('.language-priority-item')];
                    const draggedIdx = allItems.indexOf(draggedItem);
                    const targetIdx = allItems.indexOf(item);

                    if (draggedIdx < targetIdx) {
                        item.parentNode.insertBefore(draggedItem, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedItem, item);
                    }
                }
            });
        });
    }

    // 更新优先级显示
    function updatePriorityDisplay() {
        const items = document.querySelectorAll('#language_priority_list .language-priority-item');
        const langs = [];

        items.forEach(item => {
            const name = item.dataset.name;
            if (name) {
                langs.push(name);
            }
        });

        const display = document.getElementById('current_priority_display');
        if (display) {
            display.textContent = langs.length > 0 ? langs.join(' → ') : '无';
        }
    }

    // 收集语言优先级配置
    function collectLanguagePriorities() {
        const items = document.querySelectorAll('#language_priority_list .language-priority-item');
        const priorities = [];

        items.forEach(item => {
            const name = item.dataset.name;
            if (name) {
                priorities.push({ name: name });
            }
        });

        return priorities;
    }

    // 显示添加语言表单
    function showAddLanguageForm() {
        document.getElementById('add_language_form').classList.remove('hidden');
        document.getElementById('new_lang_name').focus();
        // 更新折叠区域高度
        updateCollapsibleHeight('language_priority_section');
    }

    // 隐藏添加语言表单
    function hideAddLanguageForm() {
        document.getElementById('add_language_form').classList.add('hidden');
        document.getElementById('new_lang_name').value = '';
        // 更新折叠区域高度
        updateCollapsibleHeight('language_priority_section');
    }

    // 添加新语言
    function addLanguage() {
        const name = document.getElementById('new_lang_name').value.trim();

        if (!name) {
            showFlashMessage('error', '请输入语言名称');
            return;
        }

        // 检查是否已存在
        const existing = document.querySelector(`#language_priority_list .language-priority-item[data-name="${name}"]`);
        if (existing) {
            showFlashMessage('error', '该语言已存在');
            return;
        }

        // 创建新的语言项
        const list = document.getElementById('language_priority_list');
        const div = document.createElement('div');
        div.className = 'language-priority-item flex items-center gap-3 p-3 bg-slate-50 dark:bg-white/5 rounded-lg cursor-move border border-transparent hover:border-blue-300 dark:hover:border-blue-500 transition-all';
        div.draggable = true;
        div.dataset.name = name;
        div.innerHTML = `
            <div class="drag-handle text-slate-400 dark:text-gray-500">
                <i class="fa-solid fa-grip-vertical"></i>
            </div>
            <div class="flex-1">
                <span class="language-name text-sm text-slate-700 dark:text-gray-300">${name}</span>
            </div>
            <button type="button" onclick="removeLanguage(this)" class="text-slate-400 hover:text-red-500 transition-colors" title="删除">
                <i class="fa-solid fa-trash text-xs"></i>
            </button>
        `;

        list.appendChild(div);

        // 为新项目绑定拖放事件
        bindDragEventsToItem(div);

        // 隐藏表单并更新显示
        hideAddLanguageForm();
        updatePriorityDisplay();
        showFlashMessage('success', `已添加语言: ${name}`);

        // 更新折叠区域高度
        updateCollapsibleHeight('language_priority_section');
    }

    // 删除语言
    function removeLanguage(btn) {
        const item = btn.closest('.language-priority-item');
        const name = item?.dataset?.name || '未知';

        if (item) {
            item.remove();
            updatePriorityDisplay();
            showFlashMessage('success', `已删除语言: ${name}`);
            // 更新折叠区域高度
            updateCollapsibleHeight('language_priority_section');
        }
    }

    // 为单个项目绑定拖放事件
    function bindDragEventsToItem(item) {
        const list = document.getElementById('language_priority_list');

        item.addEventListener('dragstart', (e) => {
            list.draggedItem = item;
            item.classList.add('opacity-50', 'border-blue-500');
            e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('opacity-50', 'border-blue-500');
            list.draggedItem = null;
            updatePriorityDisplay();
        });

        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });

        item.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (item !== list.draggedItem) {
                item.classList.add('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20');
            }
        });

        item.addEventListener('dragleave', () => {
            item.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20');
        });

        item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20');

            const dragged = list.draggedItem;
            if (item !== dragged && dragged) {
                const allItems = [...list.querySelectorAll('.language-priority-item')];
                const draggedIdx = allItems.indexOf(dragged);
                const targetIdx = allItems.indexOf(item);

                if (draggedIdx < targetIdx) {
                    item.parentNode.insertBefore(dragged, item.nextSibling);
                } else {
                    item.parentNode.insertBefore(dragged, item);
                }
            }
        });
    }
</script>
{% endblock %}
