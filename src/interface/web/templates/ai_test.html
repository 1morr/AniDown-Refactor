<!-- filename: templates/ai_test.html -->
{% extends "base.html" %}

{% block title %}AniDown{% endblock %}

{% block content %}
<!-- 页面标题 -->
<header class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-3">
        <i class="fa-solid fa-robot text-purple-500 dark:text-neon-purple"></i>
        AI 测试工具
    </h1>
    <p class="text-slate-500 dark:text-gray-500 text-sm">调试和优化 Prompt，实时预览 DeepSeek 等模型的处理结果。</p>
</header>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    
    <!-- 左侧：配置面板 (占 7/12) -->
    <div class="lg:col-span-7 space-y-6">
        
        <!-- 1. 提示词模板选择 -->
        <section class="glass-card rounded-xl p-6">
            <h3 class="text-sm font-semibold text-slate-800 dark:text-gray-300 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-file-lines text-purple-500 dark:text-purple-400"></i> 提示词模板
                <span class="tooltip-trigger ml-1" data-tooltip="选择预设的提示词模板，将自动填充系统提示词">
                    <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 text-xs cursor-help"></i>
                </span>
            </h3>
            <div class="flex gap-3">
                <div class="relative flex-1">
                    <select id="prompt-template" onchange="loadPromptTemplate()" 
                        class="input-field appearance-none cursor-pointer pr-10">
                        <option value="title_parse">标题解析 (Title Parse)</option>
                        <option value="multi_file_tvdb">多文件重命名 - TVDB版</option>
                        <option value="multi_file_standard">多文件重命名 - 标准版</option>
                        <option value="custom">自定义 (Custom)</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-slate-400 dark:text-gray-500 text-xs"></i>
                    </div>
                </div>
                <button onclick="reloadTemplate()" 
                    class="px-4 py-2 rounded-lg text-sm font-medium text-slate-600 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors flex items-center gap-2 tooltip-trigger"
                    data-tooltip="重新载入当前模板的原始内容">
                    <i class="fa-solid fa-rotate"></i> 重载
                </button>
            </div>
            <!-- 用户提示词范例显示区 -->
            <div id="user-prompt-example" class="mt-4 p-3 bg-slate-50 dark:bg-black/20 rounded-lg border border-slate-200 dark:border-white/5 hidden">
                <div class="text-xs font-medium text-slate-500 dark:text-gray-500 mb-2 flex items-center gap-1">
                    <i class="fa-solid fa-lightbulb text-yellow-500"></i> 用户提示词范例
                </div>
                <pre id="user-prompt-example-text" class="text-xs text-slate-600 dark:text-gray-400 whitespace-pre-wrap font-mono"></pre>
            </div>
        </section>

        <!-- 2. API 配置 -->
        <section class="glass-card rounded-xl p-6">
            <h3 class="text-sm font-semibold text-slate-800 dark:text-gray-300 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-gear text-blue-500 dark:text-blue-400"></i> API 配置
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Base URL -->
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2 flex items-center gap-1">
                        Base URL
                        <span class="tooltip-trigger" data-tooltip="API端点地址，留空使用系统配置的默认值">
                            <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 cursor-help"></i>
                        </span>
                    </label>
                    <input type="text" id="api-base-url" 
                        class="input-field text-sm" 
                        placeholder="https://api.deepseek.com/v1"
                        value="{{ config.get('openai.title_parse.base_url', 'https://api.openai.com/v1') }}">
                </div>
                
                <!-- API Key -->
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2 flex items-center gap-1">
                        API Key
                        <span class="tooltip-trigger" data-tooltip="API密钥，留空使用系统配置的默认值。此密钥仅用于当前测试，不会保存">
                            <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 cursor-help"></i>
                        </span>
                    </label>
                    <div class="relative">
                        <input type="password" id="api-key" 
                            class="input-field text-sm pr-10" 
                            placeholder="sk-xxxxxxxx（留空使用系统配置）"
                            value="">
                        <button type="button" onclick="toggleApiKeyVisibility()" 
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-gray-500 hover:text-slate-600 dark:hover:text-gray-300 transition-colors">
                            <i id="api-key-toggle-icon" class="fa-solid fa-eye text-xs"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Model 输入 -->
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2 flex items-center gap-1">
                        模型 (Model)
                        <span class="tooltip-trigger" data-tooltip="输入要使用的AI模型名称，如：deepseek-chat、gpt-4、claude-3-opus等">
                            <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 cursor-help"></i>
                        </span>
                    </label>
                    <input type="text" id="model-name" 
                        class="input-field text-sm" 
                        placeholder="deepseek-chat"
                        value="{{ config.get('openai.title_parse.model', 'gpt-4') }}">
                </div>

                <!-- Temperature 输入 -->
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2 flex items-center gap-1">
                        温度 (Temperature)
                        <span class="tooltip-trigger" data-tooltip="控制生成结果的随机性，范围0-2。较低的值会让结果更确定，较高的值会让结果更随机。DeepSeek-R1建议0.6">
                            <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 cursor-help"></i>
                        </span>
                    </label>
                    <input type="number" id="temperature" 
                        class="input-field text-sm" 
                        placeholder="留空使用模型默认值"
                        step="0.1" min="0" max="2"
                        value="">
                </div>

                <!-- Extra Body 输入 -->
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2 flex items-center gap-1">
                        自定义参数 (Extra Body)
                        <span class="tooltip-trigger" data-tooltip="输入JSON格式的自定义参数，将直接合并到请求体中。例如：{&quot;thinking_budget&quot;: 1024}">
                            <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 cursor-help"></i>
                        </span>
                    </label>
                    <textarea id="extra-body" 
                        class="input-field text-sm font-mono h-20" 
                        placeholder='{"thinking_budget": 1024, "enable_thinking": true}'></textarea>
                    <div class="text-[10px] text-slate-400 mt-1">请输入合法的 JSON 对象。留空则不发送。</div>
                </div>
                
            </div>
        </section>

        <!-- 3. 输入数据配置 -->
        <section class="glass-card rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-semibold text-slate-800 dark:text-gray-300 flex items-center gap-2">
                    <i class="fa-solid fa-input-numeric text-green-500 dark:text-green-400"></i> 数据源输入
                    <span class="tooltip-trigger" data-tooltip="输入要处理的RSS链接或手动输入动漫标题">
                        <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 text-xs cursor-help"></i>
                    </span>
                </h3>
                
                <!-- Tab 切换器 -->
                <div class="bg-slate-200 dark:bg-black/40 p-1 rounded-lg flex text-xs font-medium border border-slate-300 dark:border-white/5">
                    <button onclick="switchInputMode('rss')" id="tab-rss" class="px-3 py-1.5 rounded-md bg-white dark:bg-blue-600 text-blue-600 dark:text-white shadow-sm transition-all">
                        <i class="fa-solid fa-rss mr-1"></i> RSS链接
                    </button>
                    <button onclick="switchInputMode('manual')" id="tab-manual" class="px-3 py-1.5 rounded-md text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white transition-all">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> 手动输入标题
                    </button>
                </div>
            </div>

            <!-- 动态输入区域 -->
            <div id="input-area-rss" class="animate-fade-in">
                <textarea id="input-rss-value" rows="3" class="input-field" 
                    placeholder="粘贴 RSS Feed 链接 (例如: https://mikanani.me/RSS/...)"></textarea>
            </div>
            
            <div id="input-area-manual" class="hidden animate-fade-in">
                <textarea id="input-manual-value" rows="3" class="input-field" 
                    placeholder="输入一行或多行动漫标题用于测试...&#10;[Nekomoe] Frieren - 01.mkv"></textarea>
            </div>
        </section>

        <!-- 3.5 上下文信息 (用于多文件重命名等高级功能) -->
        <section id="context-info-section" class="glass-card rounded-xl p-6 hidden">
            <h3 class="text-sm font-semibold text-slate-800 dark:text-gray-300 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-database text-orange-500 dark:text-orange-400"></i> 上下文信息
                <span class="tooltip-trigger" data-tooltip="某些Prompt模板需要额外的上下文信息（如动漫标题、类型、TVDB数据等）才能正常工作">
                    <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 text-xs cursor-help"></i>
                </span>
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- 动漫标题 -->
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2">
                        动漫标题 (Anime Title) <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="context-anime-title" class="input-field text-sm" placeholder="例如：葬送的芙莉莲">
                </div>
                
                <!-- 动漫类型 -->
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2">
                        动漫类型 (Category)
                    </label>
                    <select id="context-anime-type" class="input-field text-sm">
                        <option value="tv">TV 剧集</option>
                        <option value="movie">Movie 电影</option>
                    </select>
                </div>
            </div>
            
            <!-- TVDB ID (仅 TVDB 版显示) -->
            <div id="context-tvdb-id-container" class="hidden">
                <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2 flex items-center justify-between">
                    <span>TVDB ID</span>
                    <span class="tooltip-trigger" data-tooltip="输入动漫的TVDB ID，将自动获取对应的元数据">
                        <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 text-xs cursor-help"></i>
                    </span>
                </label>
                <input type="text" id="context-tvdb-id" class="input-field text-sm" placeholder="例如：403566">
            </div>
        </section>

        <!-- 4. System Prompt 编辑器 -->
        <section class="glass-card rounded-xl p-0 overflow-hidden flex flex-col h-[400px]">
            <!-- 编辑器工具栏 -->
            <div class="bg-slate-50 dark:bg-white/5 border-b border-slate-200 dark:border-white/5 px-4 py-2 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-slate-700 dark:text-gray-300 flex items-center gap-2">
                    <i class="fa-solid fa-terminal text-yellow-500 dark:text-yellow-400"></i> 系统提示词 (System Prompt)
                    <span class="tooltip-trigger" data-tooltip="系统提示词定义了AI的行为方式和任务说明">
                        <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 text-xs cursor-help"></i>
                    </span>
                </h3>
                <div class="flex items-center gap-2">
                    <span id="prompt-char-count" class="text-[10px] text-slate-400 dark:text-gray-600 font-mono">0 字符</span>
                    <div class="text-[10px] text-slate-400 dark:text-gray-600 font-mono">Markdown Enabled</div>
                </div>
            </div>
            
            <!-- 编辑器主体 -->
            <div class="flex-1 relative">
                <textarea id="system-prompt" 
                    class="w-full h-full p-4 font-mono text-sm focus:outline-none resize-none leading-relaxed code-editor-bg" 
                    spellcheck="false"
                    oninput="updateCharCount()">{{ system_prompt }}</textarea>
            </div>
        </section>

        <!-- 5. 正则表达式测试工具 -->
        <section id="regex-tester-section" class="glass-card rounded-xl p-6 hidden">
            <h3 class="text-sm font-semibold text-slate-800 dark:text-gray-300 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-flask text-pink-500 dark:text-pink-400"></i> 正则表达式测试
                <span class="tooltip-trigger" data-tooltip="测试AI生成的正则表达式是否能正确匹配目标字符串">
                    <i class="fa-solid fa-circle-question text-slate-400 dark:text-gray-500 text-xs cursor-help"></i>
                </span>
            </h3>
            
            <!-- 测试字符串输入 -->
            <div class="mb-4">
                <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2">
                    测试字符串 (Test String)
                </label>
                <textarea id="regex-test-input" rows="2" class="input-field font-mono text-xs" 
                    placeholder="在此输入要测试的字符串..."></textarea>
            </div>

            <!-- 正则表达式按钮区域 -->
            <div class="mb-4">
                <label class="block text-xs font-medium text-slate-600 dark:text-gray-400 mb-2">
                    AI返回的正则 (Click to Test)
                </label>
                <div id="regex-buttons-container" class="flex flex-wrap gap-2">
                    <div class="text-xs text-slate-400 italic">等待AI返回结果...</div>
                </div>
            </div>

            <!-- 测试结果显示 -->
            <div id="regex-test-result" class="hidden p-3 bg-slate-100 dark:bg-black/20 rounded-lg font-mono text-xs border border-slate-200 dark:border-white/5 overflow-x-auto">
                <!-- 结果将显示在这里 -->
            </div>
        </section>

        <!-- 底部操作栏 -->
        <div class="flex items-center justify-between gap-4 pt-2">
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-gray-400 cursor-pointer tooltip-trigger" data-tooltip="启用后所有测试互动将被记录到AI debug日志">
                    <input type="checkbox" id="enable-logging" class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" checked>
                    <span><i class="fa-solid fa-file-lines mr-1"></i> 记录日志</span>
                </label>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="resetForm()" class="px-5 py-2.5 rounded-lg text-sm font-medium text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">
                    <i class="fa-solid fa-rotate-left mr-2"></i> 重置
                </button>
                <button onclick="startTest()" id="btn-start-test" class="relative overflow-hidden px-6 py-2.5 rounded-lg text-sm font-bold text-white bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 shadow-lg shadow-blue-500/20 transition-all group">
                    <span class="relative z-10 flex items-center">
                        <i class="fa-solid fa-play mr-2 text-xs"></i> <span id="btn-text">开始测试</span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- 右侧：实时结果预览 (占 5/12) -->
    <div class="lg:col-span-5">
        <div class="sticky top-24">
            <div class="glass-card rounded-xl h-[calc(100vh-150px)] flex flex-col overflow-hidden">
                <!-- 结果头部 -->
                <div class="px-6 py-4 border-b border-slate-200 dark:border-white/5 flex justify-between items-center bg-slate-50/50 dark:bg-white/5">
                    <h3 class="font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                        <i class="fa-solid fa-code text-blue-500 dark:text-blue-400"></i> 处理结果预览
                    </h3>
                    <div class="flex items-center gap-3">
                        <!-- 中止按钮 (仅运行时显示) -->
                        <button onclick="abortTest()" id="btn-abort" class="hidden px-3 py-1 text-xs font-medium text-white bg-orange-500 hover:bg-orange-600 rounded-md transition-colors">
                            <i class="fa-solid fa-stop mr-1"></i> 中止
                        </button>
                        <!-- 重试按钮 (仅错误时显示) -->
                        <button onclick="retryTest()" id="btn-retry" class="hidden px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">
                            <i class="fa-solid fa-rotate-right mr-1"></i> 重试
                        </button>
                        <div class="flex items-center gap-1.5 text-[10px] text-slate-500 dark:text-gray-500">
                            <span class="w-2 h-2 rounded-full bg-slate-400 dark:bg-gray-600" id="ai-status-dot"></span>
                            <span id="ai-status-text">等待开始</span>
                        </div>
                    </div>
                </div>

                <!-- 思考过程区域 (仅流式传输时显示) -->
                <div id="thinking-section" class="hidden border-b border-slate-200 dark:border-white/5">
                    <div class="px-4 py-2 bg-purple-50 dark:bg-purple-900/20 flex items-center justify-between cursor-pointer" onclick="toggleThinking()">
                        <div class="flex items-center gap-2 text-sm font-medium text-purple-700 dark:text-purple-400">
                            <i class="fa-solid fa-brain"></i> AI 思考过程
                            <span id="thinking-status" class="text-xs text-purple-500 dark:text-purple-500"></span>
                        </div>
                        <i id="thinking-toggle-icon" class="fa-solid fa-chevron-down text-purple-500 transition-transform"></i>
                    </div>
                    <div id="thinking-content" class="max-h-48 overflow-y-auto p-4 bg-purple-25 dark:bg-purple-900/10 font-mono text-xs text-purple-800 dark:text-purple-300 whitespace-pre-wrap">
                    </div>
                </div>

                <!-- 结果内容区 -->
                <div class="flex-1 p-6 overflow-y-auto font-mono text-sm space-y-2 bg-slate-50 dark:bg-[#0f172a]" id="console-output">
                    <div class="text-slate-400 dark:text-gray-500 opacity-50 italic text-center mt-20">
                        <i class="fa-solid fa-terminal text-4xl mb-4 block"></i>
                        点击 "开始测试" 运行模型<br>
                        结果将显示在这里
                    </div>
                </div>

                <!-- 底部统计 -->
                <div class="px-6 py-3 bg-slate-100 dark:bg-black/20 border-t border-slate-200 dark:border-white/5 text-xs text-slate-500 dark:text-gray-500 flex justify-between font-mono">
                    <span>Tokens: <span id="token-count" class="text-slate-700 dark:text-gray-300">0</span></span>
                    <span>Time: <span id="time-cost" class="text-slate-700 dark:text-gray-300">0ms</span></span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Tooltip 样式 -->
<style>
    .tooltip-trigger {
        position: relative;
    }
    .tooltip-trigger::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 11px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 1000;
        max-width: 250px;
        white-space: normal;
        text-align: center;
    }
    .tooltip-trigger:hover::after {
        opacity: 1;
        visibility: visible;
    }
    
    /* 思考过程展开/收起动画 */
    #thinking-content {
        transition: max-height 0.3s ease-out;
    }
    #thinking-content.collapsed {
        max-height: 0 !important;
        padding-top: 0;
        padding-bottom: 0;
        overflow: hidden;
    }
    #thinking-toggle-icon.rotated {
        transform: rotate(180deg);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // -------------------------
    // 默认 API 配置（随提示词模板切换）
    // -------------------------
    const templateApiDefaults = {
        title_parse: {
            base_url: {{ config.get('openai.title_parse.base_url', 'https://api.openai.com/v1') | tojson | safe }},
            model: {{ config.get('openai.title_parse.model', 'gpt-4') | tojson | safe }},
            api_key: {{ config.get('openai.title_parse.api_key', '') | tojson | safe }}
        },
        multi_file_tvdb: {
            base_url: {{ config.get('openai.multi_file_rename.base_url', 'https://api.openai.com/v1') | tojson | safe }},
            model: {{ config.get('openai.multi_file_rename.model', 'gpt-4') | tojson | safe }},
            api_key: {{ config.get('openai.multi_file_rename.api_key', '') | tojson | safe }}
        },
        multi_file_standard: {
            base_url: {{ config.get('openai.multi_file_rename.base_url', 'https://api.openai.com/v1') | tojson | safe }},
            model: {{ config.get('openai.multi_file_rename.model', 'gpt-4') | tojson | safe }},
            api_key: {{ config.get('openai.multi_file_rename.api_key', '') | tojson | safe }}
        }
    };

    let lastAutoApiDefaults = null;

    function applyApiDefaultsForTemplate(templateKey, options = {}) {
        const { force = false } = options;
        const defaults = templateApiDefaults[templateKey];
        if (!defaults) return;

        const baseUrlInput = document.getElementById('api-base-url');
        const modelInput = document.getElementById('model-name');
        const apiKeyInput = document.getElementById('api-key');

        const baseUrlVal = baseUrlInput.value.trim();
        const modelVal = modelInput.value.trim();
        const apiKeyVal = apiKeyInput.value.trim();

        // 仅在“空值 / 仍是上一套自动默认值 / 强制重置”时覆盖，避免打断手动输入
        if (force || !baseUrlVal || (lastAutoApiDefaults && baseUrlVal === lastAutoApiDefaults.base_url)) {
            baseUrlInput.value = defaults.base_url || '';
        }
        if (force || !modelVal || (lastAutoApiDefaults && modelVal === lastAutoApiDefaults.model)) {
            modelInput.value = defaults.model || '';
        }

        // API Key：默认不强制覆盖，避免意外展示/覆盖用户手填 key。
        // 但如果用户没填，且系统配置里有 key，则可自动带入（仍是 password 输入框）。
        if ((force || !apiKeyVal || (lastAutoApiDefaults && apiKeyVal === lastAutoApiDefaults.api_key)) && defaults.api_key) {
            apiKeyInput.value = defaults.api_key;
        }

        lastAutoApiDefaults = { ...defaults };
    }

    // -------------------------
    // 提示词模板数据
    // -------------------------
    const promptTemplates = {
        title_parse: {
            name: "标题解析",
            system_prompt: {{ system_prompt | tojson | safe }},
            user_example: "输入示例：\n[ANi] 9nine Rulers Crown / 9-nine- 支配者的王冠 - 02 [1080P][Baha][WEB-DL][AAC AVC][CHT][MP4]\n\n或RSS链接：\nhttps://mikanani.me/RSS/Bangumi?bangumiId=xxx"
        },
        multi_file_tvdb: {
            name: "多文件重命名 - TVDB版",
            system_prompt: {% if multi_file_tvdb_prompt %}{{ multi_file_tvdb_prompt | tojson | safe }}{% else %}""{% endif %},
            user_example: "输入示例（文件路径列表）：\n/downloads/Anime/Season 1/[SubGroup] Anime Title - 01.mkv\n/downloads/Anime/Season 1/[SubGroup] Anime Title - 02.mkv\n/downloads/Anime/SP/[SubGroup] Anime Title - SP01.mkv\n\n需要配合TVDB数据使用"
        },
        multi_file_standard: {
            name: "多文件重命名 - 标准版",
            system_prompt: {% if multi_file_standard_prompt %}{{ multi_file_standard_prompt | tojson | safe }}{% else %}""{% endif %},
            user_example: "输入示例（文件路径列表）：\n/downloads/Anime/[SubGroup] Anime Title - 01.mkv\n/downloads/Anime/[SubGroup] Anime Title - 02.mkv\n\n不需要TVDB数据，直接分析文件名"
        },
        custom: {
            name: "自定义",
            system_prompt: "",
            user_example: "自定义模式，请自行编写系统提示词和输入内容"
        }
    };

    // 当前选择的模板
    let currentTemplate = 'title_parse';
    let originalPrompt = {{ system_prompt | tojson | safe }};

    // -------------------------
    // 提示词模板功能
    // -------------------------
    function loadPromptTemplate() {
        const select = document.getElementById('prompt-template');
        currentTemplate = select.value;
        const template = promptTemplates[currentTemplate];
        
        if (template && currentTemplate !== 'custom') {
            document.getElementById('system-prompt').value = template.system_prompt;
            originalPrompt = template.system_prompt;
            updateCharCount();
            
            // 显示用户提示词范例
            const exampleDiv = document.getElementById('user-prompt-example');
            const exampleText = document.getElementById('user-prompt-example-text');
            exampleDiv.classList.remove('hidden');
            exampleText.textContent = template.user_example;
        } else {
            // 自定义模式，隐藏范例
            document.getElementById('user-prompt-example').classList.add('hidden');
        }

        // 控制上下文信息区域的显示
        const contextSection = document.getElementById('context-info-section');
        const tvdbIdContainer = document.getElementById('context-tvdb-id-container');
        const rssTabBtn = document.getElementById('tab-rss');
        
        if (currentTemplate === 'multi_file_tvdb' || currentTemplate === 'multi_file_standard') {
            contextSection.classList.remove('hidden');
            
            // 只有TVDB版显示TVDB ID
            if (currentTemplate === 'multi_file_tvdb') {
                tvdbIdContainer.classList.remove('hidden');
            } else {
                tvdbIdContainer.classList.add('hidden');
            }

            // 强制切换到手动输入模式，并隐藏RSS选项
            switchInputMode('manual');
            rssTabBtn.style.display = 'none';
        } else {
            contextSection.classList.add('hidden');
            // 恢复RSS选项显示
            rssTabBtn.style.display = '';
        }

        // 根据模板自动切换默认 API 配置
        applyApiDefaultsForTemplate(currentTemplate);
    }

    function reloadTemplate() {
        if (currentTemplate === 'custom') {
            window.showFlashMessage('info', '自定义模式无法重载模板');
            return;
        }
        
        const template = promptTemplates[currentTemplate];
        if (template) {
            document.getElementById('system-prompt').value = template.system_prompt;
            updateCharCount();
            window.showFlashMessage('success', '已重新载入模板原始内容');
        }
    }

    function updateCharCount() {
        const textarea = document.getElementById('system-prompt');
        const count = textarea.value.length;
        document.getElementById('prompt-char-count').textContent = `${count} 字符`;
    }

    // -------------------------
    // Tab 切换逻辑
    // -------------------------
    let currentInputMode = 'rss';

    function switchInputMode(mode) {
        currentInputMode = mode;
        const rssBtn = document.getElementById('tab-rss');
        const manualBtn = document.getElementById('tab-manual');
        const rssArea = document.getElementById('input-area-rss');
        const manualArea = document.getElementById('input-area-manual');

        const activeClass = "px-3 py-1.5 rounded-md bg-white dark:bg-blue-600 text-blue-600 dark:text-white shadow-sm transition-all";
        const inactiveClass = "px-3 py-1.5 rounded-md text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white transition-all";

        if (mode === 'rss') {
            rssBtn.className = activeClass;
            manualBtn.className = inactiveClass;
            rssArea.classList.remove('hidden');
            manualArea.classList.add('hidden');
        } else {
            rssBtn.className = inactiveClass;
            manualBtn.className = activeClass;
            rssArea.classList.add('hidden');
            manualArea.classList.remove('hidden');
        }
    }

    // -------------------------
    // 思考过程显示控制
    // -------------------------
    function toggleThinking() {
        const content = document.getElementById('thinking-content');
        const icon = document.getElementById('thinking-toggle-icon');
        content.classList.toggle('collapsed');
        icon.classList.toggle('rotated');
    }

    let thinkingSectionVisible = false;

    function showThinkingSection() {
        if (!thinkingSectionVisible) {
            document.getElementById('thinking-section').classList.remove('hidden');
            document.getElementById('thinking-content').textContent = '';
            document.getElementById('thinking-status').textContent = '思考中...';
            thinkingSectionVisible = true;
        }
    }

    function hideThinkingSection() {
        document.getElementById('thinking-section').classList.add('hidden');
        thinkingSectionVisible = false;
    }

    function appendThinking(text) {
        // 只有当收到思考内容时才显示思考区域
        if (!thinkingSectionVisible) {
            showThinkingSection();
        }
        const content = document.getElementById('thinking-content');
        content.textContent += text;
        content.scrollTop = content.scrollHeight;
    }

    function finishThinking() {
        document.getElementById('thinking-status').textContent = '(完成)';
    }

    // -------------------------
    // 获取API配置
    // -------------------------
    function getApiConfig() {
        const baseUrl = document.getElementById('api-base-url').value.trim();
        const apiKey = document.getElementById('api-key').value.trim();
        const modelName = document.getElementById('model-name').value.trim();
        const temperature = document.getElementById('temperature').value.trim();
        const extraBody = document.getElementById('extra-body').value.trim();
        const enableLogging = document.getElementById('enable-logging').checked;
        
        return {
            base_url: baseUrl || null,
            api_key: apiKey || null,
            model: modelName || null,
            temperature: temperature ? parseFloat(temperature) : null,
            extra_body: extraBody || null,
            enable_logging: enableLogging
        };
    }

    // -------------------------
    // 切换API Key可见性
    // -------------------------
    function toggleApiKeyVisibility() {
        const input = document.getElementById('api-key');
        const icon = document.getElementById('api-key-toggle-icon');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // -------------------------
    // 保存最后一次请求配置（用于重试）
    // -------------------------
    let lastRequestConfig = null;
    let currentAbortController = null;
    let currentStreamReader = null;

    // -------------------------
    // 中止请求
    // -------------------------
    function abortTest() {
        if (currentAbortController) {
            currentAbortController.abort();
            currentAbortController = null;
        }
        if (currentStreamReader) {
            currentStreamReader.cancel();
            currentStreamReader = null;
        }
        
        const statusDot = document.getElementById('ai-status-dot');
        const statusText = document.getElementById('ai-status-text');
        const output = document.getElementById('console-output');
        
        statusDot.className = "w-2 h-2 rounded-full bg-orange-500";
        statusText.innerText = "已中止";
        statusText.className = "text-orange-600 dark:text-orange-400";
        
        output.innerHTML += `
            <div class="text-orange-500 mt-4 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                <i class="fa-solid fa-stop-circle mr-2"></i> 请求已中止
            </div>
        `;
        
        document.getElementById('btn-abort').classList.add('hidden');
        resetButton();
    }

    // -------------------------
    // 后端交互与测试运行逻辑
    // -------------------------
    async function startTest() {
        const output = document.getElementById('console-output');
        const statusDot = document.getElementById('ai-status-dot');
        const statusText = document.getElementById('ai-status-text');
        const tokenDisplay = document.getElementById('token-count');
        const timeDisplay = document.getElementById('time-cost');
        const startBtn = document.getElementById('btn-start-test');
        const btnText = document.getElementById('btn-text');
        const retryBtn = document.getElementById('btn-retry');

        // 隐藏重试按钮，显示中止按钮
        retryBtn.classList.add('hidden');
        document.getElementById('btn-abort').classList.remove('hidden');
        hideThinkingSection();

        // 创建新的 AbortController
        currentAbortController = new AbortController();

        // 获取输入数据
        const apiConfig = getApiConfig();
        const systemPrompt = document.getElementById('system-prompt').value;
        const inputData = currentInputMode === 'rss' 
            ? document.getElementById('input-rss-value').value 
            : document.getElementById('input-manual-value').value;

        // 获取上下文信息
        const animeTitle = document.getElementById('context-anime-title').value.trim();
        const animeType = document.getElementById('context-anime-type').value;
        const tvdbId = document.getElementById('context-tvdb-id').value.trim();

        if (!inputData.trim()) {
            window.showFlashMessage('warning', '请输入 RSS 链接或手动输入标题');
            return;
        }

        // 验证多文件重命名必须填写动漫标题
        if ((currentTemplate === 'multi_file_tvdb' || currentTemplate === 'multi_file_standard') && !animeTitle) {
            window.showFlashMessage('warning', '当前模式需要填写动漫标题');
            return;
        }

        // 验证多文件重命名必须使用手动输入
        if ((currentTemplate === 'multi_file_tvdb' || currentTemplate === 'multi_file_standard') && currentInputMode === 'rss') {
            window.showFlashMessage('warning', '当前模式仅支持手动输入');
            switchInputMode('manual');
            return;
        }
        
        // 验证TVDB模式必须填写TVDB ID
        if (currentTemplate === 'multi_file_tvdb' && !tvdbId) {
            window.showFlashMessage('warning', 'TVDB模式需要填写TVDB ID');
            return;
        }

        // 保存请求配置用于重试
        lastRequestConfig = {
            apiConfig,
            systemPrompt,
            inputData,
            inputMode: currentInputMode,
            contextData: { animeTitle, animeType, tvdbId }
        };

        // 1. 设置 UI 状态为"运行中"
        startBtn.disabled = true;
        btnText.innerText = "处理中...";
        startBtn.classList.add('opacity-75', 'cursor-not-allowed');
        
        statusDot.className = "w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
        statusText.innerText = "AI 连接中...";
        statusText.className = "text-yellow-600 dark:text-yellow-400";
        
        output.innerHTML = `
            <div class="text-slate-400 dark:text-gray-500 flex items-center justify-center gap-3 mt-16">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-500"></i>
                <span class="text-lg">等待 AI 回应...</span>
            </div>
        `;

        const startTime = Date.now();

        try {
            // 使用流式传输模式
            await handleStreamingRequest(apiConfig, systemPrompt, inputData, startTime, { animeTitle, animeType, tvdbId });
        } catch (error) {
            handleError(error);
        }
    }

    // 流式传输请求处理
    async function handleStreamingRequest(apiConfig, systemPrompt, inputData, startTime, contextData = {}) {
        const output = document.getElementById('console-output');
        const statusDot = document.getElementById('ai-status-dot');
        const statusText = document.getElementById('ai-status-text');
        const tokenDisplay = document.getElementById('token-count');
        const timeDisplay = document.getElementById('time-cost');

        hideThinkingSection();  // 先隐藏，只有收到思考内容时才显示

        output.innerHTML = '';

        const response = await fetch('/ai_test/process_stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt_template: currentTemplate,
                model: apiConfig.model,
                base_url: apiConfig.base_url,
                api_key: apiConfig.api_key,
                temperature: apiConfig.temperature,
                extra_body: apiConfig.extra_body,
                system_prompt: systemPrompt,
                input_type: currentInputMode,
                content: inputData,
                streaming: true,
                enable_logging: apiConfig.enable_logging,
                anime_title: contextData.animeTitle,
                anime_type: contextData.animeType,
                tvdb_id: contextData.tvdbId
            }),
            signal: currentAbortController.signal
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Network response was not ok');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        let resultContent = '';
        let thinkingContent = '';
        let isThinking = false;
        let totalTokens = 0;
        
        // 创建结果显示区域
        const resultDiv = document.createElement('div');
        resultDiv.className = "text-slate-800 dark:text-gray-300 whitespace-pre-wrap";
        output.appendChild(resultDiv);

        try {
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') {
                            finishThinking();
                            continue;
                        }

                        try {
                            const parsed = JSON.parse(data);
                            
                            if (parsed.type === 'thinking') {
                                // 思考过程内容
                                if (statusText.innerText !== "AI 思考中...") {
                                    statusText.innerText = "AI 思考中...";
                                    statusDot.className = "w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
                                    statusText.className = "text-yellow-600 dark:text-yellow-400";
                                }
                                appendThinking(parsed.content);
                                thinkingContent += parsed.content;
                            } else if (parsed.type === 'content') {
                                // 正常回应内容
                                if (statusText.innerText !== "AI 回应中") {
                                    statusText.innerText = "AI 回应中";
                                    statusDot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                                    statusText.className = "text-blue-600 dark:text-blue-400";
                                }
                                resultContent += parsed.content;
                                resultDiv.textContent = resultContent;
                                output.scrollTop = output.scrollHeight;
                            } else if (parsed.type === 'error') {
                                throw new Error(parsed.error);
                            } else if (parsed.type === 'done') {
                                totalTokens = parsed.tokens || 0;
                                // 立即更新token显示
                                tokenDisplay.innerText = totalTokens > 0 ? totalTokens : "N/A";
                            }
                        } catch (e) {
                            // 忽略JSON解析错误（可能是不完整的数据）
                            if (e.name === 'SyntaxError') {
                                // ignore
                            } else {
                                // 其他错误（包括后端返回的 error）向上抛出
                                throw e;
                            }
                        }
                    }
                }
            }
        } catch (streamError) {
            throw streamError;
        }

        const endTime = Date.now();
        const duration = endTime - startTime;

        // 更新状态
        statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
        statusText.innerText = "完成";
        statusText.className = "text-emerald-600 dark:text-emerald-400";

        // 更新统计
        tokenDisplay.innerText = totalTokens || "N/A";
        timeDisplay.innerText = duration + "ms";

        output.scrollTop = output.scrollHeight;

        // 尝试解析JSON并设置正则测试器
        try {
            // 提取JSON部分（如果有markdown代码块）
            let jsonStr = resultContent;
            if (jsonStr.includes('```json')) {
                jsonStr = jsonStr.split('```json')[1].split('```')[0];
            } else if (jsonStr.includes('```')) {
                jsonStr = jsonStr.split('```')[1].split('```')[0];
            }
            
            const jsonData = JSON.parse(jsonStr.trim());
            setupRegexTester(jsonData);
        } catch (e) {
            console.log("无法解析为JSON以设置正则测试器:", e);
            // 即使解析失败，如果之前是隐藏的，也不要显示测试器
            document.getElementById('regex-tester-section').classList.add('hidden');
        }

        resetButton();
    }

    // -------------------------
    // 正则测试器功能
    // -------------------------
    function setupRegexTester(data) {
        const section = document.getElementById('regex-tester-section');
        const container = document.getElementById('regex-buttons-container');
        const testInput = document.getElementById('regex-test-input');
        
        // 清空按钮
        container.innerHTML = '';
        
        // 查找所有 _regex 结尾的字段
        const regexFields = [];
        for (const key in data) {
            if (key.endsWith('_regex') && data[key] && data[key] !== '无') {
                regexFields.push({
                    key: key,
                    pattern: data[key]
                });
            }
        }
        
        if (regexFields.length === 0) {
            section.classList.add('hidden');
            return;
        }
        
        // 显示区域
        section.classList.remove('hidden');
        
        // 自动填充测试字符串（取第一个输入行或第一个文件）
        const manualInput = document.getElementById('input-manual-value').value.trim();
        const rssInput = document.getElementById('input-rss-value').value.trim();
        
        if (data.main_files && typeof data.main_files === 'object') {
            // 如果有 main_files，取第一个key（原始文件名）
            const keys = Object.keys(data.main_files);
            if (keys.length > 0) {
                // 有时候key是完整路径，我们可能只需要文件名，但正则通常匹配整个字符串或部分
                // 这里直接用key
                testInput.value = keys[0];
            }
        } else if (manualInput) {
            testInput.value = manualInput.split('\n')[0];
        } else if (rssInput) {
             // 如果是RSS，可能没法直接获取标题，除非从结果里找
             // 尝试从 results 数组找 title (非流式) 或者 data.files (流式)
             if (data.files && Array.isArray(data.files) && data.files.length > 0) {
                 testInput.value = data.files[0];
             }
        }

        // 生成按钮
        regexFields.forEach(item => {
            const btn = document.createElement('button');
            btn.className = "px-3 py-1.5 rounded bg-white dark:bg-white/10 border border-slate-200 dark:border-white/10 text-slate-700 dark:text-gray-300 text-xs hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-600 dark:hover:text-blue-400 hover:border-blue-200 dark:hover:border-blue-800 transition-all text-left truncate max-w-[200px]";
            btn.title = `${item.key}: ${item.pattern}`;
            btn.innerHTML = `<span class="font-semibold block text-[10px] opacity-70">${item.key}</span><code class="font-mono">${escapeHtml(item.pattern)}</code>`;
            
            btn.onclick = () => runRegexTest(item.pattern, item.key);
            
            container.appendChild(btn);
        });
    }

    function runRegexTest(patternStr, regexName) {
        const input = document.getElementById('regex-test-input').value;
        const resultDiv = document.getElementById('regex-test-result');
        
        resultDiv.classList.remove('hidden');
        
        try {
            // 移除可能存在的首尾斜杠（虽然通常AI返回的是字符串形式的正则，没有斜杠）
            // 但如果AI返回的是 /.../ 格式，需要处理
            // Python正则通常是字符串，JS RegExp构造函数接受字符串
            
            // 注意：Python正则和JS正则有细微差别，比如 (?P<name>...) 在JS中是 (?<name>...)
            // 简单的处理：替换 (?P< -> (?<
            let jsPatternStr = patternStr.replace(/\(\?P</g, '(?<');
            
            const regex = new RegExp(jsPatternStr);
            const match = regex.exec(input);
            
            if (match) {
                let html = `<div class="mb-2 font-semibold text-green-600 dark:text-green-400"><i class="fa-solid fa-check"></i> 匹配成功 (${regexName})</div>`;
                html += `<div class="mb-1 text-slate-500">完整匹配:</div>`;
                html += `<div class="bg-green-100 dark:bg-green-900/30 p-1 rounded text-green-800 dark:text-green-300 mb-2 break-all">${escapeHtml(match[0])}</div>`;
                
                if (match.length > 1) {
                    html += `<div class="mb-1 text-slate-500">捕获组:</div><ul class="space-y-1 pl-2">`;
                    // 遍历所有捕获组
                    for (let i = 1; i < match.length; i++) {
                        const val = match[i] === undefined ? 'undefined' : match[i];
                        html += `<li><span class="text-slate-400 mr-2">#${i}</span> <span class="font-bold text-slate-700 dark:text-gray-300 break-all">${escapeHtml(val)}</span></li>`;
                    }
                    html += `</ul>`;
                }
                
                // 显示命名捕获组
                if (match.groups) {
                     html += `<div class="mt-2 mb-1 text-slate-500">命名捕获组:</div><ul class="space-y-1 pl-2">`;
                     for (const [key, val] of Object.entries(match.groups)) {
                         html += `<li><span class="text-purple-500 mr-2">${key}:</span> <span class="font-bold text-slate-700 dark:text-gray-300 break-all">${escapeHtml(val)}</span></li>`;
                     }
                     html += `</ul>`;
                }
                
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `<div class="text-red-500"><i class="fa-solid fa-xmark"></i> 匹配失败</div><div class="text-xs text-slate-400 mt-1">正则: ${escapeHtml(jsPatternStr)}</div>`;
            }
        } catch (e) {
            resultDiv.innerHTML = `<div class="text-red-500"><i class="fa-solid fa-triangle-exclamation"></i> 正则表达式错误</div><div class="text-xs text-slate-400 mt-1">${e.message}</div>`;
        }
    }

    // 错误处理
    function handleError(error) {
        console.error(error);
        const output = document.getElementById('console-output');
        const statusDot = document.getElementById('ai-status-dot');
        const statusText = document.getElementById('ai-status-text');
        const retryBtn = document.getElementById('btn-retry');

        // 检查是否是用户主动中止
        if (error.name === 'AbortError') {
            // 中止已经在 abortTest 函数中处理了，这里不需要再处理
            return;
        }

        statusDot.className = "w-2 h-2 rounded-full bg-red-500";
        statusText.innerText = "错误";
        statusText.className = "text-red-600 dark:text-red-400";
        
        output.innerHTML += `
            <div class="text-red-500 mt-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span class="font-semibold">请求失败</span>
                </div>
                <div class="text-sm">${escapeHtml(error.message)}</div>
                <div class="text-xs mt-2 text-red-400 dark:text-red-500">
                    提示：检查API配置是否正确，或网络连接是否正常
                </div>
            </div>
        `;
        
        // 显示重试按钮
        retryBtn.classList.remove('hidden');
        
        resetButton();
    }

    // 重试功能
    function retryTest() {
        if (lastRequestConfig) {
            // 恢复上次的配置
            document.getElementById('system-prompt').value = lastRequestConfig.systemPrompt;
            if (lastRequestConfig.inputMode === 'rss') {
                document.getElementById('input-rss-value').value = lastRequestConfig.inputData;
            } else {
                document.getElementById('input-manual-value').value = lastRequestConfig.inputData;
            }
            currentInputMode = lastRequestConfig.inputMode;
            
            // 恢复上下文信息
            if (lastRequestConfig.contextData) {
                document.getElementById('context-anime-title').value = lastRequestConfig.contextData.animeTitle || '';
                document.getElementById('context-anime-type').value = lastRequestConfig.contextData.animeType || 'tv';
                document.getElementById('context-tvdb-id').value = lastRequestConfig.contextData.tvdbId || '';
            }
            
            // 重新执行测试
            startTest();
        }
    }

    // 重置按钮状态
    function resetButton() {
        const startBtn = document.getElementById('btn-start-test');
        const btnText = document.getElementById('btn-text');
        startBtn.disabled = false;
        btnText.innerText = "开始测试";
        startBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        
        // 隐藏中止按钮
        document.getElementById('btn-abort').classList.add('hidden');
        
        // 清理 abort controller
        currentAbortController = null;
        currentStreamReader = null;
    }

    // HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 打字机效果工具函数
    function typeWriter(text, element, callback) {
        let i = 0;
        const speed = 2; // 速度
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                const container = document.getElementById('console-output');
                container.scrollTop = container.scrollHeight;
                setTimeout(type, speed);
            } else if (callback) {
                callback();
            }
        }
        type();
    }

    // -------------------------
    // 辅助功能
    // -------------------------
    function resetForm() {
        // 重置模板选择
        document.getElementById('prompt-template').value = 'title_parse';
        currentTemplate = 'title_parse';
        
        // 重置系统提示词
        document.getElementById('system-prompt').value = promptTemplates.title_parse.system_prompt;
        originalPrompt = promptTemplates.title_parse.system_prompt;
        updateCharCount();
        
        // 重置输入
        document.getElementById('input-rss-value').value = "";
        document.getElementById('input-manual-value').value = "";
        
        // 重置上下文信息
        document.getElementById('context-anime-title').value = "";
        document.getElementById('context-anime-type').value = "tv";
        document.getElementById('context-tvdb-id').value = "";
        
        // 重置API配置
        document.getElementById('api-key').value = '';
        document.getElementById('temperature').value = '';
        document.getElementById('extra-body').value = '';
        applyApiDefaultsForTemplate('title_parse', { force: true });
        
        // 重置输出区域
        hideThinkingSection();
        document.getElementById('console-output').innerHTML = `
            <div class="text-slate-400 dark:text-gray-500 opacity-50 italic text-center mt-20">
                <i class="fa-solid fa-terminal text-4xl mb-4 block"></i>
                点击 "开始测试" 运行模型<br>
                结果将显示在这里
            </div>
        `;
        
        // 重置状态
        document.getElementById('ai-status-text').innerText = "等待开始";
        document.getElementById('ai-status-text').className = "";
        document.getElementById('ai-status-dot').className = "w-2 h-2 rounded-full bg-slate-400 dark:bg-gray-600";
        document.getElementById('token-count').innerText = "0";
        document.getElementById('time-cost').innerText = "0ms";
        document.getElementById('btn-retry').classList.add('hidden');
        
        // 隐藏用户提示词范例
        loadPromptTemplate();
        
        window.showFlashMessage('success', '表单已重置');
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        updateCharCount();
        loadPromptTemplate();
    });
</script>
{% endblock %}
